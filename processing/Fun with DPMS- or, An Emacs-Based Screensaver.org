#+TITLE: Fun with DPMS; or, An Emacs-Based Screensaver
#+URL: https://lars.ingebrigtsen.no/2019/02/28/fun-with-dpms-or-an-emacs-based-screensaver/
#+AUTHOR: lujun9972
#+TAGS: raw
#+DATE: [2019年 03月 20日 星期三 11:18:28 HKT]
#+LANGUAGE:  zh-CN
#+OPTIONS:  H:6 num:nil toc:t n:nil ::t |:t ^:nil -:nil f:t *:t <:nil
[[https://larsmagne23.files.wordpress.com/2019/02/2019-02-28-2.png][[[https://larsmagne23.files.wordpress.com/2019/02/2019-02-28-2.png?w=840]]]]
[[https://larsmagne23.files.wordpress.com/2019/02/2019 - 02 - 28 - 2. - png] [[[https://larsmagne23.files.wordpress.com/2019/02/2019 - 02 - 28 - 2. png?w=840]]]]

I've got a bunch of monitors, large and small, that (in general) are always on. Because I'm too lazy to switch stuff off and or.
我有一堆显示器，大的和小的，(通常)总是开着的。因为我太懒了，不想关掉任何东西。

They display some useful information, but are largely decorative (i.e, some of them display temperature data, and some use xscreensaver to show what albums are playing).
它们展示了一些有用的信息，但主要是装饰性的。e，它们有些显示温度数据，有些使用xscreensaver显示正在播放的专辑)。

But I've got the [[https://lars.ingebrigtsen.no/2011/01/09/emacs-home-automation/][rest of the lights]] and stuff in the apt to switch off when I push the “I'm going to bed” button on the wall. I thought it might be nice to have all the monitors also switch off at the same time? And then I could link the “I'm awake now” button on the wall to switching all the monitors on again.
但是我有[[https://lars.ingebrigtsen。no/2011/01/09/emacs-home automation/][剩余的灯]]和当我按墙上的“我要睡觉了”按钮时，apt中的东西就会关闭。我想让所有的显示器同时关闭会很好吧?然后我可以把墙上的“我现在醒了”按钮和所有的监视器重新打开连接起来。

So cyber.
所以网络。

I thought this was going to be really easy, but... you know... computers.
我以为这很简单，但是…你知道的…电脑。

First of all: Switching a screen off is easy:
首先:关掉屏幕很容易:

#+BEGIN_EXAMPLE
$ xset dpms force off
#+END_EXAMPLE

And then it's off.
然后就关了。

#+BEGIN_EXAMPLE
$ xset dpms force on; xset -dpms
#+END_EXAMPLE

to switch it on again and disable power management again (to avoid the monitors switching themselves off again on their own volition).
再次打开电源并禁用电源管理(以避免监控器根据自己的意愿再次关闭电源)。

So far so good!
到目前为止一切顺利!

However, there's like a dozen things that feel free to wake monitors up.
但是，有很多东西可以让监视器自由地唤醒。

* mpv
* mpv
:PROPERTIES:
属性:
:CUSTOM_ID: mpv
:CUSTOM_ID: mpv
:END:
结束:

[[https://larsmagne23.files.wordpress.com/2019/02/n-p1390339.jpg][[[https://larsmagne23.files.wordpress.com/2019/02/n-p1390339.jpg?w=840]]]]
[[https://larsmagne23.files.wordpress.com/2019/02/n-p1390339.jpg] [[[https://larsmagne23.files.wordpress.com/2019/02/n-p1390339.jpg?w=840]]]]

Easiest first: I've got a [[https://lars.ingebrigtsen.no/2018/08/14/twiddling-youtube-or-i-mean-innovations-in-machine-learning/][little monitor]] that plays Youtube 24/7 (and displays weather data).
最简单的:我有一个[[https://lars.ingebrigtsen。no/2018/08/14/twiddling-youtube-or-i-mean-innovation -in-machine-learning/][小显示器]]全天候播放Youtube(显示天气数据)。

It would switch itself on immediately, because it uses mpv to display the youtube vids. To switch that off, just say --no-stop-screensaver.
它会立即打开自己，因为它使用mpv来显示youtube视频。要关掉它，只要说-no-stop-screensaver。

* Stereo Computer
*立体电脑
:PROPERTIES:
属性:
:CUSTOM_ID: stereo-computer
:CUSTOM_ID stereo-computer
:END:
结束:

[[https://larsmagne23.files.wordpress.com/2019/02/n-p1390335.jpg][[[https://larsmagne23.files.wordpress.com/2019/02/n-p1390335.jpg?w=840]]]]
[[https://larsmagne23.files.wordpress.com/2019/02/n-p1390335.jpg] [[[https://larsmagne23.files.wordpress.com/2019/02/n-p1390335.jpg?w=840]]]]

The screen on the computer I use to control the stereo would switch it self on whenever the song changed, and after a bit of trial and error and more code reading, I found this:
每当歌曲改变时，我用来控制立体声的电脑屏幕就会自动打开，经过反复试验和更多的代码阅读，我发现了这个:

#+BEGIN_EXAMPLE
(set-mouse-pixel-position (selected-frame) 2000 0)
#+END_EXAMPLE

It's code designed to just move the mouse pointer off the screen. And it turns out that that makes X wake the monitor up!
这段代码的目的是将鼠标指针移出屏幕。这让X唤醒了监视器!

I guess that... makes sense? I mean, moving the mouse is supposed to wake the screen up, so...
我猜……有道理吗?我的意思是，移动鼠标应该会唤醒屏幕，所以……

I added the following guard:
我加了如下的保护:

#+BEGIN_EXAMPLE
(defun jukebox-monitor-on-p ()
(with-temp-buffer
(call-process "xset" nil t nil "q")
(goto-char (point-min))
(search-forward "Monitor is On" nil t)))
#+END_EXAMPLE

* xscreensaver
* xscreensaver
:PROPERTIES:
属性:
:CUSTOM_ID: xscreensaver
:CUSTOM_ID xscreensaver
:END:
结束:

[[https://larsmagne23.files.wordpress.com/2019/02/n-p1390336.jpg][[[https://larsmagne23.files.wordpress.com/2019/02/n-p1390336.jpg?w=840]]]]
[[https://larsmagne23.files.wordpress.com/2019/02/n-p1390336.jpg] [[[https://larsmagne23.files.wordpress.com/2019/02/n-p1390336.jpg?w=840]]]]

Many of the larger screens use xscreensaver to display the sleeve of whatever album is playing, and xscreensaver wakes the monitor up after just a few seconds. Isn't that ironic!
许多较大的屏幕使用xscreensaver来显示正在播放的专辑的封套，而xscreensaver只需几秒钟就可以唤醒监视器。这不是讽刺!

Don't you think?
你不觉得吗?

It's like a screensaver that switches on a screen that's already saved, it's like
它就像一个屏幕保护程序，在已经保存的屏幕上切换

Oh, where was I...
哦，我刚才在哪里……

xscreensaver has a bunch of DPMS-related options:
xscreensaver有很多与pmds相关的选项:

#+BEGIN_EXAMPLE
dpmsEnabled:   False
dpmsQuickOff:   False
dpmsStandby:    24:00:00
dpmsSuspend:    24:00:00
dpmsOff:    24:00:00
#+END_EXAMPLE

But none of them seem to help with this problem. xscreensaver stubbornly wakes shit up. What's up with that, jwz?
但似乎没有一个能解决这个问题。xscreensaver顽固地唤醒。怎么回事，jwz?

So.
所以。

The only solution for this problem is to write an [[https://github.com/larsmagne/screensaver.el][Emacs-based screensaver]].
这个问题的唯一解决方案是编写一个[[https://github.com/larsmagne/screensaver.el][基于emacs的屏幕保护程序]]。

Obviously.
很明显。

It uses the [[https://github.com/ch11ng/xelb][xelb]] library to query the idleness (to schedule when to start saving the screen) and to query/restore focus after closing the screensaver window.
它使用[[https://github.com/ch11ng/xelb][xelb]]库来查询空闲状态(调度何时开始保存屏幕)，并在关闭屏保窗口后查询/恢复焦点。

Man. It'd be great if somebody could write a manual for xelb. Working with it is kinda frustrating because you just have to poke around, looking at examples, until you suddenly get something that works. I spent, like, seven thousand hours (approx.) trying to get the idleness out of it until I guessed (by looking at what exwm did with randr extensions) that you had to say
男人。如果有人能为xelb编写一个手册就太好了。用它工作是有点令人沮丧的，因为你只是到处闲逛，看看例子，直到你突然得到一些有用的东西。我花了大约七千小时(大约)来摆脱这种无所事事的状态，直到我猜出(通过查看exwm对randr扩展所做的操作)您必须要说的话

#+BEGIN_EXAMPLE
(xcb:get-extension-data x 'xcb:screensaver)
#+END_EXAMPLE

before trying to call the xcb:screensaver:QueryInfo function.
在调用xcb:屏保:QueryInfo函数之前。

[Edit: Emacs give me almost all events that's given to the frame (mouse and keystrokes), but not when the user presses shift, etc. Is there a way to get something like xcb_wait_for_event out of the xelb library?]
[编辑:Emacs给我几乎所有的事件，是给帧(鼠标和击键)，但不是当用户按下shift等。有没有办法从xelb库中获取类似xcb_wait_for_event这样的东西?]
