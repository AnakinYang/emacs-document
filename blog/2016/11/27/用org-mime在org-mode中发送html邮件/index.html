<!DOCTYPE html>
<html lang="en">
<head>
  <title>用org-mime在org-mode中发送html邮件 - EMACS-DOCUMENT</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <meta name="author" content="lujun9972" />
  <meta name="keywords" content="org-mode" />
  <!-- <link rel="stylesheet" href="https://lujun9972.github.io/emacs-document/media/css/main.css" type="text/css"/>
       <link rel="stylesheet" href="https://lujun9972.github.io/emacs-document/media/css/comment.css" type="text/css"/> -->
  <link rel='stylesheet' href='https://cdn.jsdelivr.net/gh/kognise/water.css@latest/dist/dark.css'>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
</head>

  <body><div class="container">
<div>
  <header class="masthead">
    <h1 class="masthead-title"><a href="https://lujun9972.github.io/emacs-document/">EMACS-DOCUMENT</a></h1>
    <p>=============&gt;集思广益</p>
    <nav class="site-nav">
      <ul class="trigger">
        <li><a href="https://lujun9972.github.io/emacs-document/years/">Years</a></li>
        <li><a href="https://lujun9972.github.io/emacs-document/authors/">Authors</a></li>
        <li><a href="https://lujun9972.github.io/emacs-document/tags/">Tags</a></li>
        <li><a href="https://lujun9972.github.io/emacs-document/about/">About</a></li>
        <li><a href="https://github.com/lujun9972/emacs-document">Github</a></li>
        <li><a href="https://lujun9972.github.io/emacs-document/rss.xml">RSS</a></li>
      </ul>
    </nav>
    <form method="get" id="searchform" action="https://www.bing.com/search">
      <input type="text" class="field" name="q" id="s" placeholder="Search">
      <input type="hidden" name="as_sitesearch" value="lujun9972.github.io/emacs-document">
    </form>
  </header>
</div>

<div>
<div class="post">
<h1 class="title">用org-mime在org-mode中发送html邮件</h1>
<div id="table-of-contents">
<h2>&#30446;&#24405;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org3de9498">Sending html emails from org-mode with org-mime</a>
<ul>
<li><a href="#org12a5288">From an org-headline in an org-file</a>
<ul>
<li><a href="#orgc0dfb8e">标记</a></li>
<li><a href="#org9d2c9d2">等式</a></li>
<li><a href="#org566276f">表格</a></li>
<li><a href="#org83971a2">列表</a></li>
<li><a href="#orgab43159">代码块</a></li>
<li><a href="#org5534233">其他目录中的图片</a></li>
<li><a href="#org96c7f8a">org-ref的引用</a></li>
</ul>
</li>
<li><a href="#orgd07c2de">In a mail message</a></li>
<li><a href="#org6d16050">Equations and file attachments do not seem to work out of the box</a></li>
<li><a href="#orgd57f48e">Summary</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org3de9498" class="outline-2">
<h2 id="org3de9498">Sending html emails from org-mode with org-mime</h2>
<div class="outline-text-2" id="text-org3de9498">
<p>
在org-mode的邮件列表中进行哦一些关于如何用orgmode发送html格式邮件的讨论. 之前用mu4e来实现的方式已经过时了. 你可以用org-mime这个库来代替以前的实现方法. 我试用了一下这个库,发现还存在以下一些缺陷:
</p>

<ol class="org-ol">
<li>我发现org中的等式并不会渲染成html中的图片,而且org中所链接的文件也不会自动成为邮件的附件. 对此我做了一些<a href="#org6d16050">修改</a>.</li>
<li>我发现使用org-mime命令从org buffer中生成email时,若能把光标保留在 <code>To:</code> 的位置就好了.</li>
<li>我使用mu4e来发送邮件, 因此我创建了一个函数来用 <code>org-mu4e-compose-org-mode</code> 编辑message, 然后为 <code>C-c C-c</code> 添加了一个hook来方便我发送邮件<a href="#orgd07c2de">(函数定义参见这里)</a>.</li>
</ol>

<p>
这篇博文主要记录了我折腾出来发送html邮件的那些步骤. 经过实验, 上面列出的有些缺陷已经在最新的org-mime中得到了修复.
</p>

<p>
第一步,你需要require <code>org-mime</code> 这个库.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">require</span> '<span style="color: #a45bad;">org-mime</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
org-mime
</pre>


<p>
你可以通过命令 <a href="org-mime-org-buffer-htmlize">org-mime-org-buffer-htmlize</a> 来将整个org buffer作为html邮件来发送. 不过这个命令并不能支持所有的内部链接(at least in gmail).
</p>

<p>
这个命令默认会把你的光标移动到buffer的末尾位置,这样很不方便. 我们可以稍微修改一下这个函数来让光标定位到 <code>To:</code> 的位置.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defun</span> <span style="color: #bc6ec5; font-weight: bold;">org-mime-org-buffer-htmlize</span> <span style="color: #bc6ec5;">()</span>
  <span style="color: #2aa1ae;">"Create an email buffer containing the current org-mode file</span>
<span style="color: #2aa1ae;">  exported to html and encoded in both html and in org formats as</span>
<span style="color: #2aa1ae;">  mime alternatives."</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">interactive</span><span style="color: #bc6ec5;">)</span>
  <span style="color: #bc6ec5;">(</span>org-mime-send-buffer 'html<span style="color: #bc6ec5;">)</span>
  <span style="color: #bc6ec5;">(</span>message-goto-to<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
org-mime-org-buffer-htmlize
</pre>
</div>

<div id="outline-container-org12a5288" class="outline-3">
<h3 id="org12a5288">From an org-headline in an org-file</h3>
<div class="outline-text-3" id="text-org12a5288">
<p>
你可以将org buffer中的某个heading内容转换为html邮件发送. 这种情况下, 你需要为heading指定 <code>MAIL_FMT</code> 属性为html, 像这样:
</p>

<pre class="example">
:PROPERTIES:
:MAIL_FMT: html
:END:
</pre>

<p>
除此之外,你还可以设置下面这些属性.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #4f97d7;">(</span>subject <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">or</span> <span style="color: #2d9574;">(</span>funcall mp <span style="color: #2d9574;">"MAIL_SUBJECT"</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">(</span>nth <span style="color: #a45bad;">4</span> <span style="color: #67b11d;">(</span>org-heading-components<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7;">(</span>to <span style="color: #bc6ec5;">(</span>funcall mp <span style="color: #2d9574;">"MAIL_TO"</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7;">(</span>cc <span style="color: #bc6ec5;">(</span>funcall mp <span style="color: #2d9574;">"MAIL_CC"</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7;">(</span>bcc <span style="color: #bc6ec5;">(</span>funcall mp <span style="color: #2d9574;">"MAIL_BCC"</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<p>
完了后, 通过命令 <a href="org-mime-subtree">org-mime-subtree</a> 来将该heading作为邮件发送出去.
</p>

<p>
同样的,我也修改了一下这个函数,来让光标停留在 <code>To:</code> 位置.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defun</span> <span style="color: #bc6ec5; font-weight: bold;">org-mime-subtree</span> <span style="color: #bc6ec5;">()</span>
  <span style="color: #2aa1ae;">"Create an email buffer containing the current org-mode subtree</span>
<span style="color: #2aa1ae;">  exported to a org format or to the format specified by the</span>
<span style="color: #2aa1ae;">  MAIL_FMT property of the subtree."</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">interactive</span><span style="color: #bc6ec5;">)</span>
  <span style="color: #bc6ec5;">(</span>org-mime-send-subtree
   <span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">or</span> <span style="color: #67b11d;">(</span>org-entry-get nil <span style="color: #2d9574;">"MAIL_FMT"</span> org-mime-use-property-inheritance<span style="color: #67b11d;">)</span> 'org<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
  <span style="color: #bc6ec5;">(</span>message-goto-to<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
org-mime-subtree
</pre>


<p>
下面是一些例子,可以看看这些元素是否能正常的转换为html.
</p>
</div>

<div id="outline-container-orgc0dfb8e" class="outline-4">
<h4 id="orgc0dfb8e">标记</h4>
<div class="outline-text-4" id="text-orgc0dfb8e">
<p>
<b>粗体</b>
</p>

<p>
<span class="underline">下划线</span>
</p>

<p>
<i>斜体</i>
</p>

<p>
<del>删除线</del>
</p>

<p>
<code>代码</code>
</p>

<p>
下标: H_{2}O
上标: H^{+}
实体: To &infin; and beyond
</p>
</div>
</div>

<div id="outline-container-org9d2c9d2" class="outline-4">
<h4 id="org9d2c9d2">等式</h4>
<div class="outline-text-4" id="text-org9d2c9d2">
<p>
\(x^2\)
</p>

<p>
\[x^4\]
</p>

<p>
\(e^x\)
</p>
</div>
</div>

<div id="outline-container-org566276f" class="outline-4">
<h4 id="org566276f">表格</h4>
<div class="outline-text-4" id="text-org566276f">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">&#34920;1&nbsp;</span> A table for you.</caption>

<colgroup>
<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-right">x</td>
<td class="org-right">y</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-right">2</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org83971a2" class="outline-4">
<h4 id="org83971a2">列表</h4>
<div class="outline-text-4" id="text-org83971a2">
<p>
嵌套列表.
</p>
<ul class="org-ul">
<li>one
<ul class="org-ul">
<li>Subentry under one.</li>
</ul></li>
<li>two</li>
</ul>


<p>
定义列表:
</p>

<dl class="org-dl">
<dt>def1</dt><dd>first definition</dd>
</dl>

<p>
检查列表:
</p>
<ul class="org-ul">
<li class="off"><code>[&#xa0;]</code> A checkbox</li>
</ul>


<p>
带数字编号的列表:
</p>

<ol class="org-ol">
<li>number 1</li>
<li>number 2</li>
</ol>
</div>
</div>

<div id="outline-container-orgab43159" class="outline-4">
<h4 id="orgab43159">代码块</h4>
<div class="outline-text-4" id="text-orgab43159">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">import</span> numpy <span style="color: #4f97d7; font-weight: bold;">as</span> np
<span style="color: #4f97d7; font-weight: bold;">import</span> matplotlib.pyplot <span style="color: #4f97d7; font-weight: bold;">as</span> plt

<span style="color: #7590db;">t</span> = np.linspace<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">0</span>, <span style="color: #a45bad;">10</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">x</span> = np.cos<span style="color: #4f97d7;">(</span>t<span style="color: #4f97d7;">)</span> * np.exp<span style="color: #4f97d7;">(</span>-t<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">y</span> = np.sin<span style="color: #4f97d7;">(</span>t<span style="color: #4f97d7;">)</span> * np.exp<span style="color: #4f97d7;">(</span>-t<span style="color: #4f97d7;">)</span>

plt.plot<span style="color: #4f97d7;">(</span>x, y<span style="color: #4f97d7;">)</span>
plt.savefig<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'spiral.png'</span><span style="color: #4f97d7;">)</span>
</pre>
</div>


<div class="figure">
<p><img src="./spiral.png" alt="spiral.png" />
</p>
<p><span class="figure-number">&#22270;1&nbsp; </span>A spiral</p>
</div>
</div>
</div>

<div id="outline-container-org5534233" class="outline-4">
<h4 id="org5534233">其他目录中的图片</h4>
<div class="outline-text-4" id="text-org5534233">

<div class="figure">
<p><img src="./images/Au-icosahedron-3.png" alt="Au-icosahedron-3.png" />
</p>
<p><span class="figure-number">&#22270;2&nbsp; </span>A gold particle</p>
</div>
</div>
</div>

<div id="outline-container-org96c7f8a" class="outline-4">
<h4 id="org96c7f8a">org-ref的引用</h4>
<div class="outline-text-4" id="text-org96c7f8a">
<table id="org4f2bca4" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">a</td>
<td class="org-left">b</td>
<td class="org-left">c</td>
</tr>
</tbody>
</table>

<p>
See Table ref:table-1.
</p>

<p>
cite:Dominik201408
</p>

<p>
bibliography:../../../Dropbox/bibliography/references.bib
</p>
</div>
</div>
</div>

<div id="outline-container-orgd07c2de" class="outline-3">
<h3 id="orgd07c2de">In a mail message</h3>
<div class="outline-text-3" id="text-orgd07c2de">
<p>
如果你想直接在邮件里用org的形式编写内容. 你可以用下面的方式适用于mu4e用户. 
下面的这个命令会以org-mode打开一个写消息的窗口,而且在邮件header与邮件body之间切换的同时也会切换到不同的mode下. 
如果你经常这样做,那么你可以为message-mode加一个hook. 我自己不怎么发送html邮件因此我没有这样做.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defun</span> <span style="color: #bc6ec5; font-weight: bold;">mu4e-compose-org-mail</span> <span style="color: #bc6ec5;">()</span>
 <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">interactive</span><span style="color: #bc6ec5;">)</span>
 <span style="color: #bc6ec5;">(</span>mu4e-compose-new<span style="color: #bc6ec5;">)</span>
 <span style="color: #bc6ec5;">(</span>org-mu4e-compose-org-mode<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
mu4e-compose-org-mail
</pre>


<p>
在发送时,我们需要使用 <code>org-mime</code> 来将org内容转换成html, 因此我们为 <code>C-c C-c</code> 添加一个hook函数来发送邮件.
这个hook函数有一些棘手, 我们需要保持 <code>C-c C-c</code> 在org-mode中的行为不变, 例如,在code block中按下 <code>C-c C-c</code> 要能执行该代码块, 但是当 <code>C-c C-c</code> 不触发其他动作时则发送邮件. 为了做到这一点,你需要将该hook函数放在hook的最末尾才行.
当然,你也可以为该功能分配其他的快捷键,或者直接用 <code>M-x</code> 运行该命令也行. 
需要注意的是,这个 <code>C-c C-c</code> hook函数只有在光标处于email的boy时才生效. 当在email的header处按下 <code>C-c C-c</code> 则会将邮件内容以纯文本的方式发送出去.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defun</span> <span style="color: #bc6ec5; font-weight: bold;">htmlize-and-send</span> <span style="color: #bc6ec5;">()</span>
  <span style="color: #2aa1ae;">"When in an org-mu4e-compose-org-mode message, htmlize and send it."</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">interactive</span><span style="color: #bc6ec5;">)</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">when</span> <span style="color: #2d9574;">(</span>member 'org~mu4e-mime-switch-headers-or-body post-command-hook<span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span>org-mime-htmlize<span style="color: #2d9574;">)</span> 
    <span style="color: #2d9574;">(</span>message-send-and-exit<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7;">(</span>add-hook 'org-ctrl-c-ctrl-c-hook 'htmlize-and-send t<span style="color: #4f97d7;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">org-babel-hash-at-point</td>
<td class="org-left">org-babel-execute-safely-maybe</td>
<td class="org-left">htmlize-and-send</td>
</tr>
</tbody>
</table>

<p>
下面的方法则可以可非mu4e用户做到在直接在邮件里编写org格式的内容,但是它无法做到mode的自动切换. 因此你会失去邮件的补全功能,以及那些与邮件header相关的功能,除非你重新切换回message-mode.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defun</span> <span style="color: #bc6ec5; font-weight: bold;">compose-html-org</span> <span style="color: #bc6ec5;">()</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">interactive</span><span style="color: #bc6ec5;">)</span>
  <span style="color: #bc6ec5;">(</span>compose-mail<span style="color: #bc6ec5;">)</span>
  <span style="color: #bc6ec5;">(</span>message-goto-body<span style="color: #bc6ec5;">)</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">setq</span> *compose-html-org* t<span style="color: #bc6ec5;">)</span>
  <span style="color: #bc6ec5;">(</span>org-mode<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defun</span> <span style="color: #bc6ec5; font-weight: bold;">org-htmlize-and-send</span> <span style="color: #bc6ec5;">()</span>
  <span style="color: #2aa1ae;">"When in an org-mu4e-compose-org-mode message, htmlize and send it."</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">interactive</span><span style="color: #bc6ec5;">)</span>
  
  <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">when</span> *compose-html-org*
    <span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">setq</span> *compose-html-org* nil<span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span>message-mode<span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span>org-mime-htmlize<span style="color: #2d9574;">)</span> 
    <span style="color: #2d9574;">(</span>message-send-and-exit<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7;">(</span>add-hook 'org-ctrl-c-ctrl-c-hook 'org-htmlize-and-send t<span style="color: #4f97d7;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">org-babel-hash-at-point</td>
<td class="org-left">org-babel-execute-safely-maybe</td>
<td class="org-left">htmlize-and-send</td>
<td class="org-left">org-htmlize-and-send</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org6d16050" class="outline-3">
<h3 id="org6d16050">Equations and file attachments do not seem to work out of the box</h3>
<div class="outline-text-3" id="text-org6d16050">
<p>
\(e^{i\pi} - 1 = 0\)
</p>

<p>
不做任何配置的情况下, org-mime似乎并不会将file链接的文件加入到电子邮件的附件中,也不会将内容中的等式转换成图片..
</p>

<p>
<a href="html-email.html">html-email.html</a> 
</p>

<p>
下面的 <code>org-mime-compose</code> 能帮你实现这一点.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defun</span> <span style="color: #bc6ec5; font-weight: bold;">org-mime-compose</span> <span style="color: #bc6ec5;">(</span>body fmt file <span style="color: #ce537a; font-weight: bold;">&amp;optional</span> to subject headers<span style="color: #bc6ec5;">)</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">require</span> '<span style="color: #a45bad;">message</span><span style="color: #bc6ec5;">)</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">let</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>bhook
   <span style="color: #b1951d;">(</span><span style="color: #4f97d7; font-weight: bold;">lambda</span> <span style="color: #4f97d7;">(</span>body fmt<span style="color: #4f97d7;">)</span>
     <span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">let</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>hook <span style="color: #9cb6ad;">(</span>intern <span style="color: #4f97d7;">(</span>concat <span style="color: #2d9574;">"org-mime-pre-"</span>
               <span style="color: #bc6ec5;">(</span>symbol-name fmt<span style="color: #bc6ec5;">)</span>
               <span style="color: #2d9574;">"-hook"</span><span style="color: #4f97d7;">)</span><span style="color: #9cb6ad;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
       <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>&gt; <span style="color: #9cb6ad;">(</span>eval `<span style="color: #4f97d7;">(</span>length ,hook<span style="color: #4f97d7;">)</span><span style="color: #9cb6ad;">)</span> <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>
     <span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">with-temp-buffer</span>
       <span style="color: #9cb6ad;">(</span>insert body<span style="color: #9cb6ad;">)</span>
       <span style="color: #9cb6ad;">(</span>goto-char <span style="color: #4f97d7;">(</span>point-min<span style="color: #4f97d7;">)</span><span style="color: #9cb6ad;">)</span>
       <span style="color: #9cb6ad;">(</span>eval `<span style="color: #4f97d7;">(</span>run-hooks ',hook<span style="color: #4f97d7;">)</span><span style="color: #9cb6ad;">)</span>
       <span style="color: #9cb6ad;">(</span>buffer-string<span style="color: #9cb6ad;">)</span><span style="color: #2d9574;">)</span>
         body<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
  <span style="color: #67b11d;">(</span>fmt <span style="color: #b1951d;">(</span><span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">(</span>symbolp fmt<span style="color: #4f97d7;">)</span> fmt <span style="color: #4f97d7;">(</span>intern fmt<span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
  <span style="color: #67b11d;">(</span>files <span style="color: #b1951d;">(</span>org-element-map <span style="color: #4f97d7;">(</span>org-element-parse-buffer<span style="color: #4f97d7;">)</span> 'link
     <span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">lambda</span> <span style="color: #bc6ec5;">(</span>link<span style="color: #bc6ec5;">)</span>
       <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">when</span> <span style="color: #2d9574;">(</span>string= <span style="color: #9cb6ad;">(</span>org-element-property <span style="color: #4f97d7;">:type</span> link<span style="color: #9cb6ad;">)</span> <span style="color: #2d9574;">"file"</span><span style="color: #2d9574;">)</span>
         <span style="color: #2d9574;">(</span>file-truename <span style="color: #9cb6ad;">(</span>org-element-property <span style="color: #4f97d7;">:path</span> link<span style="color: #9cb6ad;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span>compose-mail to subject headers nil<span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span>message-goto-body<span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">cond</span>
     <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>eq fmt 'org<span style="color: #b1951d;">)</span>
      <span style="color: #b1951d;">(</span><span style="color: #4f97d7; font-weight: bold;">require</span> '<span style="color: #a45bad;">ox-org</span><span style="color: #b1951d;">)</span>
      <span style="color: #b1951d;">(</span>insert <span style="color: #4f97d7;">(</span>org-export-string-as
         <span style="color: #bc6ec5;">(</span>org-babel-trim <span style="color: #2d9574;">(</span>funcall bhook body 'org<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> 'org t<span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>eq fmt 'ascii<span style="color: #b1951d;">)</span>
      <span style="color: #b1951d;">(</span><span style="color: #4f97d7; font-weight: bold;">require</span> '<span style="color: #a45bad;">ox-ascii</span><span style="color: #b1951d;">)</span>
      <span style="color: #b1951d;">(</span>insert <span style="color: #4f97d7;">(</span>org-export-string-as
         <span style="color: #bc6ec5;">(</span>concat <span style="color: #2d9574;">"#+Title:\n"</span> <span style="color: #2d9574;">(</span>funcall bhook body 'ascii<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> 'ascii t<span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span><span style="color: #4f97d7; font-weight: bold;">or</span> <span style="color: #4f97d7;">(</span>eq fmt 'html<span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">(</span>eq fmt 'html-ascii<span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span>
      <span style="color: #b1951d;">(</span><span style="color: #4f97d7; font-weight: bold;">require</span> '<span style="color: #a45bad;">ox-ascii</span><span style="color: #b1951d;">)</span>
      <span style="color: #b1951d;">(</span><span style="color: #4f97d7; font-weight: bold;">require</span> '<span style="color: #a45bad;">ox-org</span><span style="color: #b1951d;">)</span>
      <span style="color: #b1951d;">(</span><span style="color: #4f97d7; font-weight: bold;">let*</span> <span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span>org-link-file-path-type 'absolute<span style="color: #bc6ec5;">)</span>
       <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">we probably don't want to export a huge style file</span>
       <span style="color: #bc6ec5;">(</span>org-export-htmlize-output-type 'inline-css<span style="color: #bc6ec5;">)</span>
       <span style="color: #bc6ec5;">(</span>org-html-with-latex 'dvipng<span style="color: #bc6ec5;">)</span>
       <span style="color: #bc6ec5;">(</span>html-and-images
        <span style="color: #2d9574;">(</span>org-mime-replace-images
         <span style="color: #9cb6ad;">(</span>org-export-string-as <span style="color: #4f97d7;">(</span>funcall bhook body 'html<span style="color: #4f97d7;">)</span> 'html t<span style="color: #9cb6ad;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
       <span style="color: #bc6ec5;">(</span>images <span style="color: #2d9574;">(</span>cdr html-and-images<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
       <span style="color: #bc6ec5;">(</span>html <span style="color: #2d9574;">(</span>org-mime-apply-html-hook <span style="color: #9cb6ad;">(</span>car html-and-images<span style="color: #9cb6ad;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
  <span style="color: #4f97d7;">(</span>insert <span style="color: #bc6ec5;">(</span>org-mime-multipart
     <span style="color: #2d9574;">(</span>org-export-string-as
      <span style="color: #9cb6ad;">(</span>org-babel-trim
       <span style="color: #4f97d7;">(</span>funcall bhook body <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>eq fmt 'html<span style="color: #2d9574;">)</span> 'org 'ascii<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span><span style="color: #9cb6ad;">)</span>
      <span style="color: #9cb6ad;">(</span><span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">(</span>eq fmt 'html<span style="color: #4f97d7;">)</span> 'org 'ascii<span style="color: #9cb6ad;">)</span> t<span style="color: #2d9574;">)</span>
     html<span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">(</span>mapconcat 'identity images <span style="color: #2d9574;">"\n"</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span>mapc #'mml-attach-file files<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
org-mime-compose
</pre>
</div>
</div>

<div id="outline-container-orgd57f48e" class="outline-3">
<h3 id="orgd57f48e">Summary</h3>
<div class="outline-text-3" id="text-orgd57f48e">
<p>
用这种方法来发送具有丰富格式的html邮件真是太棒了.
</p>
</div>
</div>
</div>

</div>
</div>
<div>
        <div class="post-meta">
            <span title="post date" class="post-info">2016-11-27</span>
            <span title="last modification date" class="post-info">2016-11-27</span>
            <span title="tags" class="post-info">:<a href="https://lujun9972.github.io/emacs-document/tags/org-mode">org-mode</a>:</span>
            <span title="author" class="post-info"><a href="mailto:lujun9972 &lt;at&gt; T430S">lujun9972</a></span>
        </div>
    <script src="https://lujun9972.github.io/emacs-document/media/js/jquery-2.1.3.min.js"></script>
    <script src="https://lujun9972.github.io/emacs-document/media/js/md5.min.js"></script>
        <section>
            <div id="gitalk-container"></div>
            <script type="text/javascript">
             var gitalk = new Gitalk({
                 clientID: 'fdcb5d9da3f4acb4862c',
                 clientSecret: 'dd0a16312a206782cb7669dcec5e96874ab48170',
                 repo: 'lujun9972.github.com',
                 owner: 'lujun9972',
                 admin: ['lujun9972'],
                 id: md5(location.pathname),      // Ensure uniqueness and length less than 50
                 distractionFreeMode: false  // Facebook-like distraction free mode
             })
             gitalk.render('gitalk-container')
            </script>
        </section>
    <script src="https://lujun9972.github.io/emacs-document/media/js/main.js"></script>
    <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 26.x(<a href="http://orgmode.org">Org mode</a> 9.x)</p>
        <p>
            Copyright &copy; 2014 - <span id="footerYear"></span> <a href="mailto:lujun9972 &lt;at&gt; T430S">lujun9972</a>
            &nbsp;&nbsp;-&nbsp;&nbsp;
            Powered by <a href="https://github.com/emacs-china/ego" target="_blank">EGO</a><br/>
            <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license"><img src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png" style="border-width:0" alt="Creative Commons License" class="center"></a>
            <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
    </div>
            </div>
            <script type="text/javascript"
                    src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_SVG">
            </script>
            <script type="text/x-mathjax-config">
             MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "AMS"} } });
            </script>
</div>

  </div>
  <!-- https://instant.page/
       Make your site’s pages instant in 1 minute and improve your conversion rate by 1%  -->
  <script src="https://lujun9972.github.io/emacs-document//instant.page/1.1.0" type="module" integrity="sha384-EwBObn5QAxP8f09iemwAJljc+sU+eUXeL9vSBw1eNmVarwhKk2F9vBEpaN9rsrtp"></script>
  </body>
</html>
