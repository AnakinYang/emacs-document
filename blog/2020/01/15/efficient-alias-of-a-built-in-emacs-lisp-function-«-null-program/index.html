<!DOCTYPE html>
<html lang="en">
<head>
  <title>Efficient Alias of a Built-In Emacs Lisp Function « null program - EMACS-DOCUMENT</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <meta name="author" content="lujun9972" />
  <meta name="keywords" content="raw" />
  <!-- <link rel="stylesheet" href="../../../../../media/css/main.css" type="text/css"/>
       <link rel="stylesheet" href="../../../../../media/css/comment.css" type="text/css"/> -->
  <link rel='stylesheet' href='https://cdn.jsdelivr.net/gh/kognise/water.css@latest/dist/dark.css'>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
</head>

  <body><div class="container">
<div>
  <header class="masthead">
    <h1 class="masthead-title"><a href="../../../../../">EMACS-DOCUMENT</a></h1>
    <p>=============&gt;随便,谢谢</p>
    <nav class="site-nav">
      <ul class="trigger">
        <li><a href="../../../../../years/">Years</a></li>
        <li><a href="../../../../../authors/">Authors</a></li>
        <li><a href="../../../../../tags/">Tags</a></li>
        <li><a href="../../../../../about/">About</a></li>
        <li><a href="https://github.com/lujun9972/emacs-document.git">Github</a></li>
        <li><a href="../../../../../rss.xml">RSS</a></li>
      </ul>
    </nav>
    <form method="get" id="searchform" action="https://www.bing.com/search">
      <input type="text" class="field" name="q" id="s" placeholder="Search">
      <input type="hidden" name="as_sitesearch" value="lujun9972.github.io/emacs-document">
    </form>
  </header>
</div>

<div>
<div class="post">
<h1 class="title">Efficient Alias of a Built-In Emacs Lisp Function « null program</h1>
<div id="table-of-contents">
<h2>&#30446;&#24405;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#defalias">defalias</a></li>
<li><a href="#defsubst">defsubst</a></li>
<li><a href="#cl-first">cl-first</a></li>
<li><a href="#benchmark">Benchmark</a></li>
</ul>
</div>
</div>
<p>
Suppose you don't like the names <code>car</code> and <code>cdr</code>, the traditional identifiers for two halves of a lisp cons cell. <a href="https://irreal.org/blog/?p=8500">This is misguided.</a> A cons is really just a 2-tuple, and the halves don't have any particular meaning on their own, even as “head” and “tail.” However, maybe this is really important to you so you want to do it anyway. What's the best way to go about it?
</p>

<div id="outline-container-org4bb58a4" class="outline-2">
<h2 id="defalias"><a id="org4bb58a4"></a>defalias</h2>
<div class="outline-text-2" id="text-defalias">
<p>
Emacs Lisp has a built-in function just for this, <code>defalias</code>, which is the obvious choice.
</p>

<pre class="example">
(defalias 'car-alias #'car)
</pre>

<p>
The <code>car</code> built-in function is so fundamental to the language that <a href="file:///blog/2014/01/04/">it gets its own byte-code opcode</a>. When you call <code>car</code> in your code, the byte-compiler doesn't generate a function call, but instead uses a single instruction. For example, here's an <code>add</code> function that sums the <code>car</code> of its two arguments. I've followed the definition with its disassembly (Emacs 26.3, <a href="file:///blog/2016/12/22/">lexical scope</a>):
</p>

<pre class="example">
(defun add (a b)
 (+ (car a) (car b)))
;; 0 stack-ref 1
;; 1 car
;; 2 stack-ref 1
;; 3 car
;; 4 plus
;; 5 return
</pre>

<p>
There are zero function calls because of the dedicated <code>car</code> opcode, and it has the optimal six byte-code instructions.
</p>

<p>
The problem with <code>defalias</code> is that the definition is permitted change --- or <a href="file:///blog/2013/01/22/">be advised</a> --- and that robs the byte-compiler of optimization opportunities. It's <a href="file:///blog/2019/12/09/">a constraint</a>. When the byte-code compiler sees <code>car-alias</code>, it must emit a function call:
</p>

<pre class="example">
(defun add-alias (a b)
 (+ (car-alias a) (car-alias b)))
;; 0 constant car-alias
;; 1 stack-ref 2
;; 2 call 1
;; 3 constant car-alias
;; 4 stack-ref 2
;; 5 call 1
;; 6 plus
;; 7 return
</pre>

<p>
This has two function calls and eight byte-code instructions. Those function calls are significantly more expensive than a <code>car</code> instruction, which will show in the benchmark later.
</p>
</div>
</div>

<div id="outline-container-org41ee92b" class="outline-2">
<h2 id="defsubst"><a id="org41ee92b"></a>defsubst</h2>
<div class="outline-text-2" id="text-defsubst">
<p>
An alternative is <code>defsubst</code>, an inlined function definition, which will inline an actual <code>car</code>. The semantics for <code>defsubst</code> are, like macros, explicit that re-definitions may not affect previous uses, so the constraint is gone. Unfortunately <a href="file:///blog/2019/02/24/">the byte-code compiler is pretty dumb</a>, and does a poor job inlining <code>car-subst</code>.
</p>

<pre class="example">
(defsubst car-subst (x)
 (car x))

(defun add-subst (a b)
 (+ (car-subst a) (car-subst b)))
;; 0 stack-ref 1
;; 1 dup
;; 2 car
;; 3 stack-set 1
;; 5 stack-ref 1
;; 6 dup
;; 7 car
;; 8 stack-set 1
;; 10 plus
;; 11 return
</pre>

<p>
There are zero function calls and ten byte-code instructions. The <code>car</code> opcode is in use, but there are five unnecessary instructions. This is still faster than making the function calls, though. If the byte-code compiler was just a little smarter and could compile this to the ideal case, then this would be the end of the discussion.
</p>
</div>
</div>

<div id="outline-container-orgab9b475" class="outline-2">
<h2 id="cl-first"><a id="orgab9b475"></a>cl-first</h2>
<div class="outline-text-2" id="text-cl-first">
<p>
The built-in <code>cl-lib</code> package has a <code>cl-first</code> alias for <code>car</code>. This was written by someone with intimate knowledge of Emacs Lisp, so how how well did they do?
</p>

<pre class="example">
(require 'cl-lib)

(defun add-cl-first (a b)
 (+ (cl-first a) (cl-first b)))
;; 0 stack-ref 1
;; 1 car
;; 2 stack-ref 1
;; 3 car
;; 4 plus
;; 5 return
</pre>

<p>
It's just like plain old <code>car</code>! How did they manage this? By using a byte-compiler hint:
</p>

<pre class="example">
(defalias 'cl-first 'car)
(put 'cl-first 'byte-optimizer 'byte-compile-inline-expand)
</pre>

<p>
They used <code>defalias</code>, but they also manually told the byte-compiler to inline the definition like <code>defsubst</code>. In fact, <code>defsubst</code> expands to an expression that sets <code>byte-compile-inline-expand</code>, but, as seen above, the inline function overhead gets inlined and doesn't get eliminated.
</p>
</div>
</div>

<div id="outline-container-org00a86a2" class="outline-2">
<h2 id="benchmark"><a id="org00a86a2"></a>Benchmark</h2>
<div class="outline-text-2" id="text-benchmark">
<p>
So how do the alternatives perform? (<a href="https://gist.github.com/skeeto/36baa3b1493f53eab4e082b449448a96">benchmark source</a>)
</p>

<pre class="example">
add (0.594811299 0 0.0)
add-alias (1.232037132 0 0.0)
add-subst (0.700044324 0 0.0)
add-cl-first (0.58332882 0 0.0)
</pre>

<p>
(The <code>car</code> of the list is the running time.) Since <code>add</code> and <code>add-cl-first</code> have the same byte-codes, we shouldn't, and didn't, see a significant difference. The simple use of <code>defalias</code> doubles the running time, and using <code>defsubst</code> is about 15% slower.
</p>
</div>
</div>

</div>
</div>
<div>
        <div class="post-meta">
            <span title="post date" class="post-info">2020-01-15</span>
            <span title="last modification date" class="post-info">2020-01-15</span>
            <span title="tags" class="post-info">:<a href="../../../../../tags/raw">raw</a>:</span>
            <span title="author" class="post-info"><a href="mailto:travis &lt;at&gt; travis-job-bcec46e0-e8c4-4bd6-8a1c-ab619f3d8b40">lujun9972</a></span>
        </div>
    <script src="../../../../../media/js/jquery-2.1.3.min.js"></script>
    <script src="../../../../../media/js/md5.min.js"></script>
        <section>
            <div id="gitalk-container"></div>
            <script type="text/javascript">
             var gitalk = new Gitalk({
                 clientID: 'fdcb5d9da3f4acb4862c',
                 clientSecret: 'dd0a16312a206782cb7669dcec5e96874ab48170',
                 repo: 'lujun9972.github.com',
                 owner: 'lujun9972',
                 admin: ['lujun9972'],
                 id: md5(location.pathname),      // Ensure uniqueness and length less than 50
                 distractionFreeMode: false  // Facebook-like distraction free mode
             })
             gitalk.render('gitalk-container')
            </script>
        </section>
    <script src="../../../../../media/js/main.js"></script>
        <script>
         var _hmt = _hmt || [];
         (function() {
             var hm = document.createElement("script");
             hm.src = "https://hm.baidu.com/hm.js?7bac4fd0247f69c27887e0d4e3aee41e";
             var s = document.getElementsByTagName("script")[0]; 
             s.parentNode.insertBefore(hm, s);
         })();
        </script>
    <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 27.x(<a href="http://orgmode.org">Org mode</a> 9.x)</p>
        <p>
            Copyright &copy; 2014 - <span id="footerYear"></span> <a href="mailto:travis &lt;at&gt; travis-job-bcec46e0-e8c4-4bd6-8a1c-ab619f3d8b40">lujun9972</a>
            &nbsp;&nbsp;-&nbsp;&nbsp;
            Powered by <a href="https://github.com/emacs-china/ego" target="_blank">EGO</a><br/>
            <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license"><img src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png" style="border-width:0" alt="Creative Commons License" class="center"></a>
            <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
    </div>
            </div>
            <script type="text/javascript"
                    src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_SVG">
            </script>
            <script type="text/x-mathjax-config">
             MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "AMS"} } });
            </script>
</div>

  </div>
  <!-- https://instant.page/
       Make your site’s pages instant in 1 minute and improve your conversion rate by 1%  -->
  <script src="../../../../../instant.page/1.1.0" type="module" integrity="sha384-EwBObn5QAxP8f09iemwAJljc+sU+eUXeL9vSBw1eNmVarwhKk2F9vBEpaN9rsrtp"></script>
  </body>
</html>
