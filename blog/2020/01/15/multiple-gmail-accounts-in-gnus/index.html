<!DOCTYPE html>
<html lang="en">
<head>
  <title>Multiple GMail Accounts in Gnus - EMACS-DOCUMENT</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <meta name="author" content="lujun9972" />
  <meta name="keywords" content="raw" />
  <!-- <link rel="stylesheet" href="../../../../../media/css/main.css" type="text/css"/>
       <link rel="stylesheet" href="../../../../../media/css/comment.css" type="text/css"/> -->
  <link rel='stylesheet' href='https://cdn.jsdelivr.net/gh/kognise/water.css@latest/dist/dark.css'>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
</head>

  <body><div class="container">
<div>
  <header class="masthead">
    <h1 class="masthead-title"><a href="../../../../../">EMACS-DOCUMENT</a></h1>
    <p>=============&gt;随便,谢谢</p>
    <nav class="site-nav">
      <ul class="trigger">
        <li><a href="../../../../../years/">Years</a></li>
        <li><a href="../../../../../authors/">Authors</a></li>
        <li><a href="../../../../../tags/">Tags</a></li>
        <li><a href="../../../../../about/">About</a></li>
        <li><a href="https://github.com/lujun9972/emacs-document.git">Github</a></li>
        <li><a href="../../../../../rss.xml">RSS</a></li>
      </ul>
    </nav>
    <form method="get" id="searchform" action="https://www.bing.com/search">
      <input type="text" class="field" name="q" id="s" placeholder="Search">
      <input type="hidden" name="as_sitesearch" value="lujun9972.github.io/emacs-document">
    </form>
  </header>
</div>

<div>
<div class="post">
<h1 class="title">Multiple GMail Accounts in Gnus</h1>
<div id="table-of-contents">
<h2>&#30446;&#24405;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#getting-authinfo-to-work-with-multiple-gmail-accounts">Getting authinfo to work with multiple Gmail accounts</a></li>
<li><a href="#setting-up-multiple-smtp-servers">Setting up Multiple SMTP Servers</a></li>
<li><a href="#setting-behaviors-per-mailbox">Setting behaviors per Mailbox</a></li>
<li><a href="#fixing-the-naming-problem">Fixing the Naming Problem</a></li>
</ul>
</div>
</div>
<p>
I have both my home and work email accounts through Gmail (work being hosted through our own domain). I wanted to configure Gnus to access both imap accounts with the following requirements:
</p>

<ul class="org-ul">
<li>Visually differentiate between mailboxes in the different accounts (Gnus wants to call all your Gmail account inboxes “INBOX”)</li>
<li>Have outgoing mail routed through the correct account, with an appropriate signature, from address, other headers, etc.</li>
<li>Have expiry work the way I want -- basically, in “normal” mailboxes (not special Gmail folders), I want to be able to expire messages and have them moved immediately into the Gmail “All Mail” folder for archival.</li>
<li>Get the desired behavior for each mailbox (INBOX always visible, show read messages, etc.)</li>
</ul>

<p>
There are a number of hurdles you have to climb over to get this working acceptably, and I never found one source that had a complete working solution that met my needs, so I decided to publish my setup in the hopes that it might prove useful for someone. In short, here are the problems we need to solve:
</p>

<ul class="org-ul">
<li>All your google accounts will have the same server name, breaking authinfo logins</li>
<li>Get Gnus to understand how to set behaviors per-mailbox</li>
<li>Make outgoing mail route through the correct account's SMTP server</li>
<li>Figure out a way to identify mailboxes by name in the Group buffer</li>
</ul>

<div id="outline-container-orge244f84" class="outline-2">
<h2 id="getting-authinfo-to-work-with-multiple-gmail-accounts"><a id="orge244f84"></a>Getting authinfo to work with multiple Gmail accounts</h2>
<div class="outline-text-2" id="text-getting-authinfo-to-work-with-multiple-gmail-accounts">
<p>
Ordinarily, you'd configure your select methods in Gnus something like the following:
</p>

<p>
‘Account setup in .gnus'
</p>

<pre class="example">
(setq gnus-secondary-select-methods
 '((nnimap "home"
 (nnimap-address "imap.gmail.com")
 (nnimap-server-port 993)
 (nnimap-stream ssl)
 (nnimap-authinfo-file "~/.authinfo"))
 (nnimap "work"
 (nnimap-address "imap.gmail.com")
 (nnimap-server-port 993)
 (nnimap-stream ssl)
 (nnimap-authinfo-file "~/.authinfo"))))
</pre>

<p>
You'd then put your credentials into your .authinfo file like so:
</p>

<pre class="example">
machine imap.gmail.com login mylogin password mypassword port imaps
machine imap.gmail.com login mylogin2 password mypassword2 port imaps
</pre>

<p>
The problem is that in our case, both accounts have a server name of “imap.gmail.com”, and thus authinfo can't figure out which credentials to send to which account. If you're using a new enough Gnus version, this problem can be solved by replacing “imap.gmail.com” in .authinfo with the account name “home” or “work” from .gnus. Alternately, you can define aliases for imap.gmail.com in your localhosts file and configure each account to access a different alias, allowing you to have different server names in .authinfo. I went with the simpler version.
</p>

<pre class="example">
machine home login mylogin password mypassword port imaps
machine work login mylogin2 password mypassword2 port imaps
</pre>
</div>
</div>

<div id="outline-container-org82c1f76" class="outline-2">
<h2 id="setting-up-multiple-smtp-servers"><a id="org82c1f76"></a>Setting up Multiple SMTP Servers</h2>
<div class="outline-text-2" id="text-setting-up-multiple-smtp-servers">
<p>
Gnus by default has no mechanism for switching SMTP servers on outgoing messages. There are a few options, but the simplest is probably to install <a href="http://msmtp.sourceforge.net/">msmtp</a>. This is a simple little program that accepts a command line parameter that tells it which server to use, and then connects to that server to send your mail. Once you've installed and configured that (my configuration is shown below), we'll still need to customize Gnus to pass the right flags to msmtp depending on where we send the message from.
</p>

<pre class="example">
defaults
tls on
auto_from on
logfile ~/.msmtp.log

account home
host smtp.gmail.com
tls on
tls_certcheck off
auth on
from myusername@gmail.com
user myusername@gmail.com
password myhomepassword
port 587

account work
host smtp.gmail.com
tls on
tls_certcheck off
auth on
from me@myworkdomain.com
user me@myworkdomain.com
password myworkpassword
port 587
</pre>
</div>
</div>

<div id="outline-container-org19cb2c5" class="outline-2">
<h2 id="setting-behaviors-per-mailbox"><a id="org19cb2c5"></a>Setting behaviors per Mailbox</h2>
<div class="outline-text-2" id="text-setting-behaviors-per-mailbox">
<p>
Most of what I need can be accomplished through Gnus' notion of group parameters. You can theoretically customize parameters through the Customize buffer, but I abhor that awful abomination and would prefer to do it through Lisp. Fortunately, you can set most group parameters via the gnus-parameters variable. This variable is a list of alists, each of which contains a regular expression matching a group name followed by a set of parameters for that group. Below is my gnus-parameters.
</p>

<p>
‘Account customization in .gnus'
</p>

<pre class="example">
(setq gnus-parameters
 '(("nnimap work:INBOX"
 (display . all)
 (posting-style
 (name "Deon Garrett")
 (address "me@myworkaddress.com")
 (organization "My Employer")
 (signature-file "~/.signature-work"))
 (expiry-target . delete)
 ("nnimap work:[Gmail]/.*"
 (display . all)
 (posting-style
 (name "Deon Garrett")
 (address "me@myworkaddress.com")
 (organization "My Employer")
 (signature-file "~/.signature-work"))
 (expiry-wait . never))
 ("nnimap home:(INBOX|lists..*)"
 (display . all)
 (posting-style
 (name "Deon Garrett")
 (address "me@myhomeaddress.com")
 (signature-file "~/.signature-home"))
 (expiry-target . delete)
 ("nnimap home:[Gmail]/.*"
 (display . all)
 (posting-style
 (name "Deon Garrett")
 (address "me@myhomeaddress.com")
 (signature-file "~/.signature-home"))
 (expiry-wait . never))))
</pre>

<p>
There's a lot going on here, but basically, I have two accounts “home” and “work”, and for each account, I have one set of parameters for normal mailboxes, and another set for those “special” gmail mailboxes that I want to treat slightly differently (mainly with respect to expiry). Note the regular expressions for the group names: “nnimap XXXX:YYYY” where XXXX is the account name (“home” or “work”) and YYYY must match only the mailboxes I want. So the first block matches only the INBOX on my work account. It sets the headers I want on outgoing mail, tells Gnus to always show all messages when I enter the group, sends the correct switch to the msmtp program to select my work account (Edit: msmtp supports automatically choosing an account based on the From header. See my updated example .msmtprc file),and sets up expiry to immediate move expired messages to the “[GMail]/All Mail” folder. *Correction: I've since changed the expiry to delete the message instead of moving it to All Mail, as Gmail always keeps a copy in All Mail anyway. I have left the “expiry . never” for the Gmail groups to prevent deletion of messages from inside the Google special groups. **The second block is still the work account, but now matches only mailboxes named like “[GMail]/”, that is, all the special Gmail boxes. The only different setting here is that I tell Gnus to never expire a message from a special folder. The remaining two blocks of settings configure my home account in a similar fashion. There are a few global settings we need to set as well. We need to tell Gnus to use msmtp as our sendmail replacement. I also want all my subscribed groups to be always visible, and the “visible” group parameter won't work from gnus-parameters, so per the documentation, we need to set that in an alternate fashion. You should also set up a default set of outgoing headers so that if you send mail from outside any group, you'll still have some useful default. Below is the elisp to set up msmtp and make the groups visible. I'll leave it to you to set most of those other variables, as they're standard Gnus settings that you probably already know.
</p>

<p>
‘SMTP setup in .gnus'
</p>

<pre class="example">
(setq message-send-mail-function 'message-send-mail-with-sendmail)
(setq sendmail-program "/usr/local/bin/msmtp")
(setq gnus-permanently-visible-groups ".*")
</pre>
</div>
</div>

<div id="outline-container-org73fad83" class="outline-2">
<h2 id="fixing-the-naming-problem"><a id="org73fad83"></a>Fixing the Naming Problem</h2>
<div class="outline-text-2" id="text-fixing-the-naming-problem">
<p>
There's one last really annoying issue -- if you open gnus with this configuration and subscribe to INBOX from both accounts, you'll see the groups buffer with the following:
</p>

<pre class="example">
0: INBOX
0: INBOX
</pre>

<p>
Clearly we'd like to have a visual way of differentiating the two accounts. I tried setting the “comment” field in the group parameters and modifying gnus-group-line-format, but it had no effect. I believe the gnus-parameters variable isn't consulted until you enter a group, which must happen after the group buffer is displayed, so that makes some sense. After experimenting with several complete failures, I hit upon the idea to use Gnus' “topics” to give me at least a reasonable solution. Briefly, the idea of topics is that you can organize your group buffer by topic rather than by group, giving you a hierarchical display of, for example, all your “comp.lang.*” newsgroups under a tree instead of just in a flat list. From the group buffer, press “t”. This puts you into the topic minor mode. You can consult the info page for Topic Parameters for all the details, but the short version is that you can create new topics with “T n”, rename topics with “T r”, move groups from one topic to another with “T m”, etc. I created topics named “Home”, “Work”, and “News” (for a couple of NNTP groups), and moved each group or mailbox into the appropriate topic. Put the following into your .gnus to activate topic mode each time you start Gnus to persist your changes.
</p>

<p>
‘turning on topic-mode'
</p>

<pre class="example">
1
</pre>

<pre class="example">
(add-hook 'gnus-group-mode-hook 'gnus-topic-mode)
</pre>

<p>
The result is shown in the screenshot below. It's not perfect, but it's certainly at least reasonable.
</p>


<div class="figure">
<p><img src="http://www.cataclysmicmutation.com/images/2010/11/gnustopics.png" alt="gnustopics.png" />
</p>
</div>
</div>
</div>

</div>
</div>
<div>
        <div class="post-meta">
            <span title="post date" class="post-info">2020-01-15</span>
            <span title="last modification date" class="post-info">2020-01-15</span>
            <span title="tags" class="post-info">:<a href="../../../../../tags/raw">raw</a>:</span>
            <span title="author" class="post-info"><a href="mailto:travis &lt;at&gt; travis-job-bcec46e0-e8c4-4bd6-8a1c-ab619f3d8b40">lujun9972</a></span>
        </div>
    <script src="../../../../../media/js/jquery-2.1.3.min.js"></script>
    <script src="../../../../../media/js/md5.min.js"></script>
        <section>
            <div id="gitalk-container"></div>
            <script type="text/javascript">
             var gitalk = new Gitalk({
                 clientID: 'fdcb5d9da3f4acb4862c',
                 clientSecret: 'dd0a16312a206782cb7669dcec5e96874ab48170',
                 repo: 'lujun9972.github.com',
                 owner: 'lujun9972',
                 admin: ['lujun9972'],
                 id: md5(location.pathname),      // Ensure uniqueness and length less than 50
                 distractionFreeMode: false  // Facebook-like distraction free mode
             })
             gitalk.render('gitalk-container')
            </script>
        </section>
    <script src="../../../../../media/js/main.js"></script>
        <script>
         var _hmt = _hmt || [];
         (function() {
             var hm = document.createElement("script");
             hm.src = "https://hm.baidu.com/hm.js?7bac4fd0247f69c27887e0d4e3aee41e";
             var s = document.getElementsByTagName("script")[0]; 
             s.parentNode.insertBefore(hm, s);
         })();
        </script>
    <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 27.x(<a href="http://orgmode.org">Org mode</a> 9.x)</p>
        <p>
            Copyright &copy; 2014 - <span id="footerYear"></span> <a href="mailto:travis &lt;at&gt; travis-job-bcec46e0-e8c4-4bd6-8a1c-ab619f3d8b40">lujun9972</a>
            &nbsp;&nbsp;-&nbsp;&nbsp;
            Powered by <a href="https://github.com/emacs-china/ego" target="_blank">EGO</a><br/>
            <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license"><img src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png" style="border-width:0" alt="Creative Commons License" class="center"></a>
            <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
    </div>
            </div>
            <script type="text/javascript"
                    src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_SVG">
            </script>
            <script type="text/x-mathjax-config">
             MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "AMS"} } });
            </script>
</div>

  </div>
  <!-- https://instant.page/
       Make your site’s pages instant in 1 minute and improve your conversion rate by 1%  -->
  <script src="../../../../../instant.page/1.1.0" type="module" integrity="sha384-EwBObn5QAxP8f09iemwAJljc+sU+eUXeL9vSBw1eNmVarwhKk2F9vBEpaN9rsrtp"></script>
  </body>
</html>
