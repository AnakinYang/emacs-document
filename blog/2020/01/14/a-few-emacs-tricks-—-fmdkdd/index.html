<!DOCTYPE html>
<html lang="en">
<head>
  <title>A Few Emacs Tricks — fmdkdd - EMACS-DOCUMENT</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <meta name="author" content="lujun9972" />
  <meta name="keywords" content="raw" />
  <!-- <link rel="stylesheet" href="../../../../../media/css/main.css" type="text/css"/>
       <link rel="stylesheet" href="../../../../../media/css/comment.css" type="text/css"/> -->
  <link rel='stylesheet' href='https://cdn.jsdelivr.net/gh/kognise/water.css@latest/dist/dark.css'>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
</head>

  <body><div class="container">
<div>
  <header class="masthead">
    <h1 class="masthead-title"><a href="../../../../../">EMACS-DOCUMENT</a></h1>
    <p>=============&gt;随便,谢谢</p>
    <nav class="site-nav">
      <ul class="trigger">
        <li><a href="../../../../../years/">Years</a></li>
        <li><a href="../../../../../authors/">Authors</a></li>
        <li><a href="../../../../../tags/">Tags</a></li>
        <li><a href="../../../../../about/">About</a></li>
        <li><a href="https://github.com/lujun9972/emacs-document.git">Github</a></li>
        <li><a href="../../../../../rss.xml">RSS</a></li>
      </ul>
    </nav>
    <form method="get" id="searchform" action="https://www.bing.com/search">
      <input type="text" class="field" name="q" id="s" placeholder="Search">
      <input type="hidden" name="as_sitesearch" value="lujun9972.github.io/emacs-document">
    </form>
  </header>
</div>

<div>
<div class="post">
<h1 class="title">A Few Emacs Tricks — fmdkdd</h1>
<div id="table-of-contents">
<h2>&#30446;&#24405;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#automatically-reload-the-browser-when-editing-html">Automatically reload the browser when editing HTML</a></li>
<li><a href="#one-sentence-per-line-for-editing-shared-latex">One sentence per line for editing shared LaTeX</a></li>
<li><a href="#preview-definitions-when-editing-assembly">Preview definitions when editing assembly</a></li>
<li><a href="#highlight-todo-keywords">Highlight TODO keywords</a></li>
<li><a href="#insert-screenshots-into-org-documents">Insert screenshots into Org documents</a></li>
<li><a href="#insert-delete-or-change-delimiters">Insert, delete or change delimiters</a></li>
<li><a href="#auto-revert-without-the-lag">Auto-revert without the lag</a></li>
</ul>
</div>
</div>
<p>
Here are some Emacs Lisp stuff I have in my configuration, which others may find
useful. I don't want to publish them on MELPA, because I have no intention
to maintain them. They probably contain bugs, haven't been tested thoroughly
etc. Feel free to grab them if they fit your needs, but don't complain if they
don't work!
</p>

<div id="outline-container-org38ec639" class="outline-2">
<h2 id="automatically-reload-the-browser-when-editing-html"><a id="org38ec639"></a>Automatically reload the browser when editing HTML</h2>
<div class="outline-text-2" id="text-automatically-reload-the-browser-when-editing-html">
<p>
When I do web programming in HTML/CSS/JS, I like to have a browser to test my
changes quickly. Switching to the browser and refreshing it got old rather
quickly, so I scripted it.
</p>

<p>
<a href="https://github.com/fmdkdd/dotfiles/blob/master/emacs/.emacs.d/elisp/reload-browser.el"><code>reload-browser.el</code></a> provides a function which reloads multiple browser
windows. The first time you call it, it turns your cursor into a box, asking
you to click in the window you want to reload. After that, calling the function
again will reload the window you selected. You can even select multiple windows
(e.g., Firefox and Chrome) if you pass a numeric prefix argument. With a
keybinding to save the current buffer and reload all browser windows, I don't
need a more fancy setup.
</p>

<p>
Behind the scenes it simply calls <code>xdotool</code> to do the heavy lifting. It's
mostly straightforward, but it turns out that Chromium requires to be in focus
to be reloaded, whereas Firefox does not, so the script has to handle that as
well.
</p>
</div>
</div>

<div id="outline-container-org0ebed17" class="outline-2">
<h2 id="one-sentence-per-line-for-editing-shared-latex"><a id="org0ebed17"></a>One sentence per line for editing shared LaTeX</h2>
<div class="outline-text-2" id="text-one-sentence-per-line-for-editing-shared-latex">
<p>
I usually write text with <code>auto-fill-mode</code>, which wraps lines at 80 characters
so the result is readable in any text editor. When writing papers in LaTeX
though, I want to keep one sentence per line, as it makes reviewing the diffs
and handling conflicts much easier when working with other people. Of course, I
want my editor to fill that way automatically.
</p>

<p>
<a href="https://github.com/fmdkdd/dotfiles/blob/master/emacs/.emacs.d/elisp/ospl.el"><code>ospl.el</code></a> redefines <code>auto-fill-function</code> to break after a sentence, and
provides an <code>ospl-paragraph</code> function which refills the current paragraph to one
sentence per line. The trick here is to detect where sentences end so you can
insert newlines. Emacs can recognize sentences by looking for a colon, but note
that abbreviated acronyms also end by colons (“e.g.”, “i.e.”). The best way to
handle this unambiguously is to use a double space after a sentence, and a
single space after other colons (see the variable <code>sentence-end-double-space</code>).
</p>

<p>
Unfortunately, not everyone has recognized that the double space is the superior
form, so <code>ospl</code> assumes you use a single space, and avoids breaking after common
acronyms, which makes it slightly more complex than it should be.
</p>
</div>
</div>

<div id="outline-container-org85fb36f" class="outline-2">
<h2 id="preview-definitions-when-editing-assembly"><a id="org85fb36f"></a>Preview definitions when editing assembly</h2>
<div class="outline-text-2" id="text-preview-definitions-when-editing-assembly">
<p>
Lately I've been dabbling in 6502 assembly, and when navigating code, I often
found the need to look at the definition for the label under point. So I wrote
an xref backend for assembly (<a href="https://github.com/fmdkdd/dotfiles/blob/master/emacs/.emacs.d/elisp/xref-asm.el"><code>xref-asm.el</code></a>), so that I could jump to the
definition and back using the standard keybindings. But for most labels, I
didn't really need to jump to the definition, I only needed to see a couple of
lines at or below the label, so I could remember what it was doing.
</p>

<p>
So I wrote <a href="https://github.com/fmdkdd/dotfiles/blob/master/emacs/.emacs.d/elisp/xref-posframe.el"><code>xref-posframe.el</code></a>, another package which previews the
definition using <code>posframe</code>. Posframe lets you create one-shot Emacs frames
without window decorations, which is more convenient and configurable than
overlays for displaying stuff on top of the current buffer, but still fast
enough to be usable. With xref-posframe, I can preview a definition in one
key:
</p>

<p>
Pressing the key a second time, I can even jump to the definition.
</p>

<p>
And it works everywhere xref is supported, not just for assembly.
</p>
</div>
</div>

<div id="outline-container-org2b877c8" class="outline-2">
<h2 id="highlight-todo-keywords"><a id="org2b877c8"></a>Highlight TODO keywords</h2>
<div class="outline-text-2" id="text-highlight-todo-keywords">
<p>
This one is pretty simple. I want keywords in comments like <code>TODO:</code> and
<code>FIXME:</code> to use a custom font, so I can see them pop out at me, screaming to be
fixed. This can be done by adding keywords to font lock:
</p>

<pre class="example">
(defun add-watchwords ()
 "Add TODO: words to font-lock keywords."
 (font-lock-add-keywords
 nil '(("\\(\\&lt;TODO\\|\\&lt;FIXME\\|\\&lt;HACK\\|@.+\\):"
 1 font-lock-warning-face t))))
(add-hook 'prog-mode-hook #'add-watchwords)
</pre>


<div class="figure">
<p><img src="file:///img/posts/todo-highlight.png" alt="todo-highlight.png" />
</p>
</div>

<p>
This method has one drawback: it highlights these words anywhere they appear
in a programming buffer, even outside of comments. There are complex packages
that do this in a more robust way, making sure to only highlight these words in
comments. I don't think these are worth the added complexity. For me, 99.99%
of the time the method above works fine. When there is a false positive, I just
ignore it.
</p>

<p>
Lately I've been using more descriptive keywords like <code>@Correctness:</code> or
<code>@Optimize:</code>, so I've added a wildcard at the end to handle all words between
“=@=” and “=:=”. Even then, false positives are not an issue.
</p>
</div>
</div>

<div id="outline-container-org853428d" class="outline-2">
<h2 id="insert-screenshots-into-org-documents"><a id="org853428d"></a>Insert screenshots into Org documents</h2>
<div class="outline-text-2" id="text-insert-screenshots-into-org-documents">
<p>
I take a lot of notes on what I'm working on in Org. Whenever I'm working on
something that can be visualized, I prefer to include screenshots as they are
often more helpful in conveying what's going on. To reduce the friction of
taking the screenshot, cropping it, and inserting the link into the Org file,
I've written a bit of Elisp to do it for me:
</p>

<pre class="example">
(defun insert-screenshot (file-name)
 "Save screenshot to FILE-NAME and insert an Org link at point.

This calls the `import' from ImageMagick to take the screenshot,
and `optipng' to reduce the file size if the program is present."
 (interactive "FSave to file: ")
 ;; Get absolute path
 (let ((file (expand-file-name file-name)))
 ;; Create the directory if necessary
 (make-directory (file-name-directory file) 'parents)
 ;; Still, make sure to signal if the screenshot was in fact not created
 (unless (= 0 (call-process "import" nil nil nil file))
 (user-error "`import' failed to create screenshot %s" file))
 (if (executable-find "optipng")
 (start-process "optipng" nil "optipng" file))
 (insert
 ;; A link relative to the buffer where it is inserted is more portable
 (format "[[file:%s]]"
 (file-relative-name file
 (file-name-directory buffer-file-name))))
 (when (eq major-mode 'org-mode)
 (org-redisplay-inline-images))))
</pre>

<p>
This snippet asks for a filename, then calls <code>import</code> to select just the area I
want to screenshot, saves it and then insert an org-format image link at point.
In org-mode, it redisplays inline images so I can see the result right away. If
<code>optipng</code> is installed, it even compresses the screenshot to save space.
</p>
</div>
</div>

<div id="outline-container-org5965b60" class="outline-2">
<h2 id="insert-delete-or-change-delimiters"><a id="org5965b60"></a>Insert, delete or change delimiters</h2>
<div class="outline-text-2" id="text-insert-delete-or-change-delimiters">
<p>
In Spacemacs and Vim, there's a nifty way to quickly surround a part of text
with quotes, braces, and other delimiters. When I went back to vanilla Emacs,
adding quotes by hand seemed tedious.
</p>

<p>
<a href="https://github.com/fmdkdd/dotfiles/blob/master/emacs/.emacs.d/elisp/delimiter.el"><code>delimiter.el</code></a> solves this. It's very straightforward: <code>delimiter-surround</code>
will prompt for a delimiter char and surround the current region with it. If no
region is active, it surrounds the current sexp. So in two quick key presses, I
can quote a word. Some delimiters go in pairs, so giving an opening brace “={<code>”
will use the matching closing brace “</code>}=” as closing delimiter.
</p>

<p>
There is also <code>delimiter-change</code> to change an existing delimiter pair to
something else, and <code>delimiter-delete</code> which is self-explanatory.
</p>

<p>
Note that the deletion is purposefully not clever: if you have nested
delimiters, it will just delete the ones closest to point, so in the following
situation (the caret <code>|</code> marks point):
</p>

<pre class="example">
(he|re (is) a list)
</pre>

<p>
invoking <code>M-x delimiter-delete ( RET</code> will yield:
</p>

<pre class="example">
he|re (is a list)
</pre>

<p>
where one may expect to eat the outermost parens:
</p>

<pre class="example">
he|re (is) a list
</pre>

<p>
If you want clever behavior, you should look elsewhere.
</p>
</div>
</div>

<div id="outline-container-org4366041" class="outline-2">
<h2 id="auto-revert-without-the-lag"><a id="org4366041"></a>Auto-revert without the lag</h2>
<div class="outline-text-2" id="text-auto-revert-without-the-lag">
<p>
Just yesterday I wanted to explore the assembly output of GCC for some simple C
file. I opened two windows: one with the C code, and one with the output
assembly. I put the latter in <code>auto-revert-mode</code> so I could quickly see the
result after recompilation.
</p>

<p>
Turns out, <code>auto-revert-mode</code> had some weird lag on my machine, where it could
take a few seconds to revert the buffer so I could see the result. Opening a
terminal with <code>watch -n 0.1 cat a.s</code> was better.
</p>

<p>
I wrote a small minor mode that reverts the buffer after getting change events
from <code>inotify</code>, and it was constantly instantaneous.
</p>

<p>
Later, I checked out the source to <code>auto-revert-mode</code>, and found that it does
more or less the same as my minor mode, using <code>filenotify</code> watchers first, and
falling back on polling if filenotify isn't supported or fails. Yet, it can
still take seconds to refresh whereas my minor mode just works.
</p>

<p>
If you have the same issue with <code>auto-revert-mode</code>, you may want to try
<a href="https://github.com/fmdkdd/dotfiles/blob/master/emacs/.emacs.d/elisp/inotify-revert.el"><code>inotify-revert.el</code></a>.
</p>
</div>
</div>

</div>
</div>
<div>
        <div class="post-meta">
            <span title="post date" class="post-info">2020-01-14</span>
            <span title="last modification date" class="post-info">2020-01-14</span>
            <span title="tags" class="post-info">:<a href="../../../../../tags/raw">raw</a>:</span>
            <span title="author" class="post-info"><a href="mailto:travis &lt;at&gt; travis-job-0fadc80a-0033-4eb4-a46f-5ab1cf12cdd3">lujun9972</a></span>
        </div>
    <script src="../../../../../media/js/jquery-2.1.3.min.js"></script>
    <script src="../../../../../media/js/md5.min.js"></script>
        <section>
            <div id="gitalk-container"></div>
            <script type="text/javascript">
             var gitalk = new Gitalk({
                 clientID: 'fdcb5d9da3f4acb4862c',
                 clientSecret: 'dd0a16312a206782cb7669dcec5e96874ab48170',
                 repo: 'lujun9972.github.com',
                 owner: 'lujun9972',
                 admin: ['lujun9972'],
                 id: md5(location.pathname),      // Ensure uniqueness and length less than 50
                 distractionFreeMode: false  // Facebook-like distraction free mode
             })
             gitalk.render('gitalk-container')
            </script>
        </section>
    <script src="../../../../../media/js/main.js"></script>
        <script>
         var _hmt = _hmt || [];
         (function() {
             var hm = document.createElement("script");
             hm.src = "https://hm.baidu.com/hm.js?7bac4fd0247f69c27887e0d4e3aee41e";
             var s = document.getElementsByTagName("script")[0]; 
             s.parentNode.insertBefore(hm, s);
         })();
        </script>
    <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 27.x(<a href="http://orgmode.org">Org mode</a> 9.x)</p>
        <p>
            Copyright &copy; 2014 - <span id="footerYear"></span> <a href="mailto:travis &lt;at&gt; travis-job-0fadc80a-0033-4eb4-a46f-5ab1cf12cdd3">lujun9972</a>
            &nbsp;&nbsp;-&nbsp;&nbsp;
            Powered by <a href="https://github.com/emacs-china/ego" target="_blank">EGO</a><br/>
            <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license"><img src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png" style="border-width:0" alt="Creative Commons License" class="center"></a>
            <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
    </div>
            </div>
            <script type="text/javascript"
                    src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_SVG">
            </script>
            <script type="text/x-mathjax-config">
             MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "AMS"} } });
            </script>
</div>

  </div>
  <!-- https://instant.page/
       Make your site’s pages instant in 1 minute and improve your conversion rate by 1%  -->
  <script src="../../../../../instant.page/1.1.0" type="module" integrity="sha384-EwBObn5QAxP8f09iemwAJljc+sU+eUXeL9vSBw1eNmVarwhKk2F9vBEpaN9rsrtp"></script>
  </body>
</html>
