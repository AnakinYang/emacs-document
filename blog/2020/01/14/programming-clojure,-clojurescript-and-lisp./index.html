<!DOCTYPE html>
<html lang="en">
<head>
  <title>Programming Clojure, ClojureScript and Lisp. - EMACS-DOCUMENT</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <meta name="author" content="lujun9972" />
  <meta name="keywords" content="raw" />
  <!-- <link rel="stylesheet" href="../../../../../media/css/main.css" type="text/css"/>
       <link rel="stylesheet" href="../../../../../media/css/comment.css" type="text/css"/> -->
  <link rel='stylesheet' href='https://cdn.jsdelivr.net/gh/kognise/water.css@latest/dist/dark.css'>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
</head>

  <body><div class="container">
<div>
  <header class="masthead">
    <h1 class="masthead-title"><a href="../../../../../">EMACS-DOCUMENT</a></h1>
    <p>=============&gt;随便,谢谢</p>
    <nav class="site-nav">
      <ul class="trigger">
        <li><a href="../../../../../years/">Years</a></li>
        <li><a href="../../../../../authors/">Authors</a></li>
        <li><a href="../../../../../tags/">Tags</a></li>
        <li><a href="../../../../../about/">About</a></li>
        <li><a href="https://github.com/lujun9972/emacs-document.git">Github</a></li>
        <li><a href="../../../../../rss.xml">RSS</a></li>
      </ul>
    </nav>
    <form method="get" id="searchform" action="https://www.bing.com/search">
      <input type="text" class="field" name="q" id="s" placeholder="Search">
      <input type="hidden" name="as_sitesearch" value="lujun9972.github.io/emacs-document">
    </form>
  </header>
</div>

<div>
<div class="post">
<h1 class="title">Programming Clojure, ClojureScript and Lisp.</h1>
<div id="table-of-contents">
<h2>&#30446;&#24405;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#what-i-am-trying-to-improve">[[#what-i-am-trying-to-improve][]]What I am trying to improve</a></li>
<li><a href="#org-mode-the-swiss-army-knife-and-requirements">[[#org-mode-the-swiss-army-knife-and-requirements][]]Org-mode: the swiss army knife and requirements</a></li>
<li><a href="#org-capture-parsing-and-storing-commit-messages">[[#org-capture-parsing-and-storing-commit-messages][]]Org-capture: parsing and storing commit messages</a></li>
<li><a href="#org-agenda-reports-and-improvement-achieved">[[#org-agenda-reports-and-improvement-achieved][]]Org-agenda: reports and improvement achieved</a></li>
<li><a href="#conclusions">[[#conclusions][]]Conclusions</a></li>
</ul>
</div>
</div>
<p>
Optimizing my workflow has always been one of my personal goals. A smoother developer experience makes your velocity go through the roof and consequently makes you happier.
</p>

<p>
It is not, by any means, something easy to accomplish though, especially given the enormous amount of "productivity tools" out there.
</p>

<p>
I try to follow a few guidelines:
</p>

<ul class="org-ul">
<li>use as few tools as possible to avoid context switching</li>
<li>has got the right abstractions for the problem you are trying to solve</li>
<li>prefer programmable tools</li>
</ul>

<p>
The last point is particularly important because it contributes to my maker side and liberates me from the (arguably understandable) "solve for the 80% of the use cases" mantra of many products out there.
</p>

<div id="outline-container-org7a5a02a" class="outline-2">
<h2 id="what-i-am-trying-to-improve"><a id="org7a5a02a"></a>[[#what-i-am-trying-to-improve][]]What I am trying to improve</h2>
<div class="outline-text-2" id="text-what-i-am-trying-to-improve">
<p>
Like many others, my daily routine consists of having to deal with backlogs and tickets.
</p>

<p>
Our corporate tooling can correlate tickets with actual work through a very simple convention in the git commit messages:
</p>

<pre class="example">
[PM-1824] Rename config keys

This patch makes the config keys a bit shorter.
</pre>

<p>
The part within brackets is the ticket number I am working on.
</p>

<p>
At the beginning of each week, each developer collects the ticket numbers and submits them to some other corporate tool.
</p>

<p>
This is currently a manual step and you tend to conveniently "forget" about it. Whenever the punctual reminder loudly knocks at your email the only thing you can do is to rush through your commits, checking all the different repositories you contributed to...trying to do the job that machines have been designed for.
</p>

<p>
Not fun.
</p>
</div>
</div>

<div id="outline-container-orgd9e8de4" class="outline-2">
<h2 id="org-mode-the-swiss-army-knife-and-requirements"><a id="orgd9e8de4"></a>[[#org-mode-the-swiss-army-knife-and-requirements][]]Org-mode: the swiss army knife and requirements</h2>
<div class="outline-text-2" id="text-org-mode-the-swiss-army-knife-and-requirements">
<p>
In the spirit of the tool selection guidelines laid out above I have wholeheartedly embraced the way of the Emacs for a long time now.
</p>

<p>
Emacs is not an editor but ultimately a productivity tool. The productivity tool I would say.
</p>

<p>
It is infinitely programmable (via Emacs Lisp) but it has also been around for enough time that a myriad of plugins have been developed for it. This allows you to reduce context switching: I do most of my coding, git and even part of my web browsing in Emacs.
</p>

<p>
Not too bad for a piece of software initially released in 1976.
</p>

<p>
Is Emacs the right tool for my particular problem?
</p>

<p>
Absolutely, enter <a href="https://orgmode.org/"><code>org-mode</code></a>:
</p>

<blockquote>
<p>
Org-mode [...] is a document editing, formatting, and organizing mode, designed for notes, planning, and authoring within the free software text editor Emacs.
</p>
</blockquote>

<p>
Just by looking at the above description one can be quite confident that we are going to have all the pieces we need to improve our workflow. The whole of <code>org-mode</code> simply boils down to a thin layer of very well oiled conventions so that text can be interpreted as data.
</p>

<p>
Let's start with what we need then. We would like to have:
</p>

<ul class="org-ul">
<li>An easy way to store ticket numbers each day, potentially many times per day</li>
<li>An easy way to display weekly reports</li>
</ul>

<p>
Expanding on the first point - it does not need to be fully automated as long as it is fully integrated into the code &amp; commit flow.
</p>
</div>
</div>

<div id="outline-container-org0125704" class="outline-2">
<h2 id="org-capture-parsing-and-storing-commit-messages"><a id="org0125704"></a>[[#org-capture-parsing-and-storing-commit-messages][]]Org-capture: parsing and storing commit messages</h2>
<div class="outline-text-2" id="text-org-capture-parsing-and-storing-commit-messages">
<p>
The <code>org-mode</code> capture functionality is what allows you to store text and metadata interactively in a <code>.org</code> file of your choice. The text can be anything useful, like a note for your future self, an idea for a blog post, a snippet of code.
</p>

<p>
The only thing you tell Emacs is what metadata should be captured and the text that goes along with it.
</p>

<p>
With a bit of bottom-up approach, let's prepare the very first functions we will be using for parsing the commit message string so that ticket number and actual commit message can be isolated:
</p>

<pre class="example">
(defun org-conf--find-commit-ticket (text)
 "Find the ticket number from the input TEXT."
 (when (string-match "\\[\\(.*\\)]" text)
 (match-string 1 text)))

(defun org-conf--find-commit-msg (text)
 "Find the actual commit message from the input TEXT."
 (when (string-match "\\[.*\\]\\s-+\\(\\(.\\|\n\\)*\\)" text)
 (match-string 1 text)))
</pre>

<p>
I hope that the only unfamiliar piece is the <code>org-conf--</code> prefix up there. The rest is simply how you do regex group matching in Emacs Lisp, plus an awful lot of escaping.
</p>

<p>
The way you hook this up in <code>org-capture</code> is to create a custom template:
</p>

<pre class="example">
(setq org-capture-templates
 `(("w" "Work Templates")

 ("wc" "Commit Ticket"
 entry
 (file+olp+datetree ,(concat org-directory "/agenda/tickets.org.gpg"))
 ,(string-join
 (list "* %(org-conf--find-commit-ticket (org-conf--retrieve-commit-text)) :dev:"
 ":LOGBOOK:"
 ":added: %T"
 ":END:"
 "%(org-conf--find-commit-msg (org-conf--retrieve-commit-text))%?")
 "\n")
 :clock-resume t
 :tree-type week)))
</pre>

<p>
There is a log going on there but <code>"w"</code> and <code>"wc"</code> are the shortcuts (and description, more on this later) used in the <code>org-capture</code> interactive menu. Then one can easily detect the (encrypted in my case) <code>tickets.org</code> destination file and the <code>:added: %T</code> entry timestamp .
</p>

<p>
The first item of the <code>list</code> sexp needs more explanation:
</p>

<p>
The long-winded <code>%(org-conf--find-commit-ticket (org-conf--retrieve-commit-text))</code> means, in lispy words, call <code>org-conf--retrieve-commit-text</code> and pass its result to <code>org-conf--find-commit-ticket</code>.
</p>

<p>
We have already seen the latter. The former is the new piece of custom code that retrieves the commit message. It grabs it either from Emacs' selection (called <code>:initial</code> in <code>org-mode</code>) or, if not there, from <code>magit</code>'s very handy <code>git-commit-buffer-message</code>. It looks like this.
</p>

<pre class="example">
(defun org-conf--retrieve-commit-text ()
 "Return INITIAL or try to call git-commit-buffer-message."
 (cond
 ((let ((captured (org-capture-get :initial)))
 (when captured captured)))

 ((fboundp 'git-commit-buffer-message)
 (with-current-buffer (org-capture-get :original-buffer)
 (git-commit-buffer-message)))

 ((t nil))))
</pre>

<p>
What ends up in <code>ticket.org</code> looks like this (some entries have been collapsed for clarity):
</p>


<div class="figure">
<p><img src="file:///images/org-mode-captured-sample.png" alt="org-mode-captured-sample.png" />
</p>
</div>

<p>
As you can see, the ticket number is under a very specific heading, categorized by the week number. You get this for free because of the <code>file+olp+datetree</code> target directive above .
</p>
</div>
</div>

<div id="outline-container-orgfc0d896" class="outline-2">
<h2 id="org-agenda-reports-and-improvement-achieved"><a id="orgfc0d896"></a>[[#org-agenda-reports-and-improvement-achieved][]]Org-agenda: reports and improvement achieved</h2>
<div class="outline-text-2" id="text-org-agenda-reports-and-improvement-achieved">
<p>
The other side of the coin is the weekly report. This is even easier than the above - it is mostly configuration:
</p>

<pre class="example">
(setq org-agenda-custom-commands
 `(("c" "Weekly Commit Tickets"
 ((agenda "" ((org-agenda-files (list ,(concat org-directory "/agenda/tickets.org.gpg")))
 (org-agenda-span 'week)
 (org-agenda-start-on-weekday 1)
 (org-agenda-overriding-header "Worked on tickets: ")
 (org-agenda-time-grid nil)))))))
</pre>

<p>
Every time I need to compute my ticket numbers for the current week, I type <code>C-c a</code> (the <code>org-agenda</code> Emacs function) and then <code>c</code>. The <code>b</code> and <code>f</code> shortcuts bring me to the previous and next week, respectively. Like the above, many other useful <a href="https://orgmode.org/manual/Agenda-commands.html">shortcuts</a> have been tailored by decades of contributions for you to use.
</p>

<p>
The report is very simple but effective.
</p>


<div class="figure">
<p><img src="file:///images/org-mode-agenda-sample.png" alt="org-mode-agenda-sample.png" />
</p>
</div>

<p>
With these additions, at any point during my day I can <code>C-c c</code> (<code>org-capture</code> Emacs function) and an interactive menu pops up.
</p>


<div class="figure">
<p><img src="file:///images/org-mode-capture-selection.png" alt="org-mode-capture-selection.png" />
</p>
</div>

<p>
At that point, I can press <code>w</code> and <code>c</code> for adding an entry. The entry is displayed to me before appending so that I can tweak it or kill it (<code>C-c C-k</code>). Most of the times I just confirm the addition by <code>C-c C-c</code> and the entry will appear in <code>ticket.org</code>, as we saw above.
</p>

<p>
In case I am not in a git commit buffer, I simply make sure that my selection contains a suitable string to be parsed. As long as there is a <code>[FOOBAR]</code> in it I am good.
</p>
</div>
</div>

<div id="outline-container-org89dfd4a" class="outline-2">
<h2 id="conclusions"><a id="org89dfd4a"></a>[[#conclusions][]]Conclusions</h2>
<div class="outline-text-2" id="text-conclusions">
<p>
Winding it up, I hope this blog post sparked a bit of curiosity on a rather unconventional but low-cost solution to a productivity issue.
</p>

<p>
For more details, here are some links I found useful along the way:
</p>

<p>
Happy hacking!
</p>
</div>
</div>

</div>
</div>
<div>
        <div class="post-meta">
            <span title="post date" class="post-info">2020-01-14</span>
            <span title="last modification date" class="post-info">2020-01-25</span>
            <span title="tags" class="post-info">:<a href="../../../../../tags/raw">raw</a>:</span>
            <span title="author" class="post-info"><a href="mailto:travis &lt;at&gt; travis-job-e1aeb2ca-90af-43f4-b7d5-39ad90dc35c9">lujun9972</a></span>
        </div>
    <script src="../../../../../media/js/jquery-2.1.3.min.js"></script>
    <script src="../../../../../media/js/md5.min.js"></script>
        <section>
            <div id="gitalk-container"></div>
            <script type="text/javascript">
             var gitalk = new Gitalk({
                 clientID: 'fdcb5d9da3f4acb4862c',
                 clientSecret: 'dd0a16312a206782cb7669dcec5e96874ab48170',
                 repo: 'lujun9972.github.com',
                 owner: 'lujun9972',
                 admin: ['lujun9972'],
                 id: md5(location.pathname),      // Ensure uniqueness and length less than 50
                 distractionFreeMode: false  // Facebook-like distraction free mode
             })
             gitalk.render('gitalk-container')
            </script>
        </section>
    <script src="../../../../../media/js/main.js"></script>
        <script>
         var _hmt = _hmt || [];
         (function() {
             var hm = document.createElement("script");
             hm.src = "https://hm.baidu.com/hm.js?7bac4fd0247f69c27887e0d4e3aee41e";
             var s = document.getElementsByTagName("script")[0]; 
             s.parentNode.insertBefore(hm, s);
         })();
        </script>
    <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 27.x(<a href="http://orgmode.org">Org mode</a> 9.x)</p>
        <p>
            Copyright &copy; 2014 - <span id="footerYear"></span> <a href="mailto:travis &lt;at&gt; travis-job-e1aeb2ca-90af-43f4-b7d5-39ad90dc35c9">lujun9972</a>
            &nbsp;&nbsp;-&nbsp;&nbsp;
            Powered by <a href="https://github.com/emacs-china/ego" target="_blank">EGO</a><br/>
            <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license"><img src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png" style="border-width:0" alt="Creative Commons License" class="center"></a>
            <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
    </div>
            </div>
            <script type="text/javascript"
                    src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_SVG">
            </script>
            <script type="text/x-mathjax-config">
             MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "AMS"} } });
            </script>
</div>

  </div>
  <!-- https://instant.page/
       Make your site’s pages instant in 1 minute and improve your conversion rate by 1%  -->
  <script src="../../../../../instant.page/1.1.0" type="module" integrity="sha384-EwBObn5QAxP8f09iemwAJljc+sU+eUXeL9vSBw1eNmVarwhKk2F9vBEpaN9rsrtp"></script>
  </body>
</html>
