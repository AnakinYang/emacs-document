<!DOCTYPE html>
<html lang="en">
<head>
  <title>Part 7: motion, drunkard&#39;s walk, keyboard control - EMACS-DOCUMENT</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <meta name="author" content="lujun9972" />
  <meta name="keywords" content="raw" />
  <!-- <link rel="stylesheet" href="../../../../../media/css/main.css" type="text/css"/>
       <link rel="stylesheet" href="../../../../../media/css/comment.css" type="text/css"/> -->
  <link rel='stylesheet' href='https://cdn.jsdelivr.net/gh/kognise/water.css@latest/dist/dark.css'>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
</head>

  <body><div class="container">
<div>
  <header class="masthead">
    <h1 class="masthead-title"><a href="../../../../../">EMACS-DOCUMENT</a></h1>
    <p>=============&gt;随便,谢谢</p>
    <nav class="site-nav">
      <ul class="trigger">
        <li><a href="../../../../../years/">Years</a></li>
        <li><a href="../../../../../authors/">Authors</a></li>
        <li><a href="../../../../../tags/">Tags</a></li>
        <li><a href="../../../../../about/">About</a></li>
        <li><a href="https://github.com/lujun9972/emacs-document.git">Github</a></li>
        <li><a href="../../../../../rss.xml">RSS</a></li>
      </ul>
    </nav>
    <form method="get" id="searchform" action="https://www.bing.com/search">
      <input type="text" class="field" name="q" id="s" placeholder="Search">
      <input type="hidden" name="as_sitesearch" value="lujun9972.github.io/emacs-document">
    </form>
  </header>
</div>

<div>
<div class="post">
<h1 class="title">Part 7: motion, drunkard&#39;s walk, keyboard control</h1>
<div id="table-of-contents">
<h2>&#30446;&#24405;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#file-handling">File handling</a></li>
<li><a href="#test-buffers">Test buffers</a></li>
<li><a href="#comments">Comments</a></li>
<li><a href="#helper-routines-and-global-variables">Helper routines and global variables</a></li>
<li><a href="#animate-a-character-down-and-to-right">Animate a character down and to right</a></li>
<li><a href="#animate-two-characters">Animate two characters</a></li>
<li><a href="#drunkards-walk">Drunkard's walk</a></li>
<li><a href="#two-drunkards">Two drunkards</a></li>
<li><a href="#a-drunkard-who-can-wander-forever">A drunkard who can wander forever</a></li>
<li><a href="#keyboard-controlled-walker">Keyboard controlled walker</a></li>
<li><a href="#the-character-keeps-moving-once-directed-by-keypress">The character keeps moving once directed by keypress</a></li>
<li><a href="#the-character-bounces-off-of-topbottom-of-grid-but-falls-off-the-sides">The character bounces off of top/bottom of grid, but falls off the sides</a></li>
</ul>
</div>
</div>
<p>
Continued from <a href="file:///project/emacs-animation/lisp6.html">Emacs Lisp programming pt. 6</a>.
</p>

<div id="outline-container-org91c6396" class="outline-2">
<h2 id="file-handling"><a id="org91c6396"></a>File handling</h2>
<div class="outline-text-2" id="text-file-handling">
<p>
To start working on code, create an emacs buffer which edits a file. For example, type <code>c-x c-f \~/Desktop/motion.el</code>. The <code>~/Desktop/</code> navigates to your Desktop (on OS X), then <code>motion.el</code> is the filename. You can choose any name, but have it end in <code>.el</code> to let Emacs know it is an Emacs Lisp program.
</p>

<p>
The first time you navigate to the file with <code>c-x c-f</code> Emacs will create the file. You then save you work via <code>c-x c-s</code>. The next time you start Emacs, <code>c-x c-f ~/Desktop/motion.el</code> (or whatever its name was) will load the file.
</p>

<p>
At any point when specifying a filename or directory, type <code>TAB</code> and Emacs will complete the directory/filename. If it doesn't find a completion, typing <code>TAB</code> twice will show all possible completions. To edit a file on a flash drive, use a file pathname like =/Volumes/=drivename=/=filename (on OS X).
</p>

<p>
key command meaning
<code>c-x c-f</code>
find file
<code>c-x c-s</code>
save file
<code>TAB</code>
try to complete directory/file name
</p>
</div>
</div>

<div id="outline-container-orgf30507a" class="outline-2">
<h2 id="test-buffers"><a id="orgf30507a"></a>Test buffers</h2>
<div class="outline-text-2" id="text-test-buffers">
<p>
To show a test buffer in the same Emacs window as your code, type <code>c-x 3</code> to split the Emacs window. You can now flip the cursor between the left and right panes via <code>c-x o</code>. In the right pane, type <code>c-x b test &lt;return&gt;</code> to create a test buffer. Then <code>c-x o</code> to go back to the left pane and edit code. Widen the window so there's enough space to see code on the left and the test buffer on the right.
</p>


<div class="figure">
<p><img src="file:///project/emacs-animation/emacs-two-pane.jpg" alt="emacs-two-pane.jpg" />
</p>
</div>

<p>
Now in the left pane, you can type <code>m-x eval-buffer &lt;return&gt;</code> to load your Lisp code into Emacs. Then type <code>c-x o</code> to move to the right pane (test buffer), and type <code>m-: (=defunname</code>)= to run a defun you've created. If you need to quit your defun (because it is looping forever), type <code>c-g</code>. Then <code>c-x o</code> will bring you back to you Emacs code in the left pane.
</p>

<p>
If you accidentally run your Lisp program in the same buffer as you Lisp code, it'll probably overwrite your code. To get your program back, type <code>c-/</code> which performs an undo. If the Lisp code has hidden the cursor, typing <code>m-: (setq cursor-type t) &lt;return&gt;</code> will bring back the cursor.
</p>

<p>
key command meaning
<code>c-x 3</code>
split window horizontally
<code>c-x o</code>
move cursor to other pane
<code>c-x b</code>
switch to buffer
<code>m-x eval-buffer</code>
load the Lisp code in the current buffer
<code>m-:</code>
prompt for and evaluate a Lisp expression
<code>c-g</code>
abort running Lisp program (or pretty much anything else)
<code>c-/</code>
undo
<code>m-: (setq cursor-type t)</code>
bring back cursor
</p>
</div>
</div>

<div id="outline-container-orgcdf30fe" class="outline-2">
<h2 id="comments"><a id="orgcdf30fe"></a>Comments</h2>
<div class="outline-text-2" id="text-comments">
<p>
Lisp ignores any text on a line after a semicolon (<code>;</code>). This lets you comment on your code in non-Lisp-language. It's customary for full-line comments to start with two semicolons (<code>;;</code>):
</p>

<pre class="example">
;; set some variables
(setq i 23)
(setq j "hello")
</pre>
</div>
</div>

<div id="outline-container-org39fa062" class="outline-2">
<h2 id="helper-routines-and-global-variables"><a id="org39fa062"></a>Helper routines and global variables</h2>
<div class="outline-text-2" id="text-helper-routines-and-global-variables">
<p>
For the code in this page, we'll set up global variables (<code>setq</code>'d outside of a defun, so all defuns can see them) for drawing grid size and background. We'll then set up functions to draw a grid, draw a character, and clear a character. This code will need to be eval'd for the rest of the code to work.
</p>

<pre class="example">
;; global variables

(setq width 50)
(setq height 35)
(setq background-char ?\.)

;; helper routines (little elves)

(defun make-grid ()
 (erase-buffer)
 (dotimes (i height)
 (insert-char background-char width)
 (newline)))

(defun draw-char (x y char)
 (goto-char (+ x (* (1- y) (1+ width))))
 (delete-char 1)
 (insert-char char 1))

(defun clear-char (x y)
 (draw-char x y background-char))
</pre>

<p>
<code>1+</code> returns 1 more than its argument, <code>1-</code> returns one less. So <code>(1+ width)</code> is short for <code>(+ 1 width)</code> and <code>(1- y)</code> is short for <code>(- y 1)</code>.
</p>

<p>
Note that <code>clear-char</code> is a defun which uses another defun <code>draw-char</code> to do its work, along with a reference to the global variable <code>background-char</code>. (Just as <code>draw-char</code> uses built-in Emacs defuns <code>goto-char</code>, <code>delete-char</code>, and <code>insert-char</code> to do its work.)
</p>
</div>
</div>

<div id="outline-container-org31a3cba" class="outline-2">
<h2 id="animate-a-character-down-and-to-right"><a id="org31a3cba"></a>Animate a character down and to right</h2>
<div class="outline-text-2" id="text-animate-a-character-down-and-to-right">
<pre class="example">
(defun move-char ()
 (make-grid)
 (let ((x 1) (y 1))
 (dotimes (i 30)
 (draw-char x y ?\*)
 (sit-for 0.2)
 (clear-char x y)
 (setq x (+ x (random 3))
 y (+ y (random 3))))))
</pre>

<p>
The <code>let</code> sets up <code>x</code> and <code>y</code> to keep track of the character position. <code>(random 3)</code> returns 0, 1, or 2. Thus, the <code>setq</code> sets <code>x</code> and <code>y</code> each to be randomly either the same or a bit more. Note that <code>setq</code> can set more than one variable.
</p>
</div>
</div>

<div id="outline-container-org845600f" class="outline-2">
<h2 id="animate-two-characters"><a id="org845600f"></a>Animate two characters</h2>
<div class="outline-text-2" id="text-animate-two-characters">
<pre class="example">
(defun move-two-chars ()
 (make-grid)
 (let ((x1 1) (y1 1)
 (x2 1) (y2 1))
 (dotimes (i 30)
 (draw-char x1 y1 ?\*)
 (draw-char x2 y2 ?\o)
 (sit-for 0.2)
 (clear-char x1 y1)
 (clear-char x2 y2)
 (setq x1 (+ x1 (random 3))
 y1 (+ y1 (random 3))
 x2 (+ x2 (random 4))
 y2 (+ y2 (random 2))))))
</pre>

<p>
This is a pretty characteristic animation code. The <code>let</code> sets up the two characters. For each time through the loop, first the code draws the characters, then pauses so the viewer can see them, then clears the characters, then updates their position, then repeats. (In slicker code, the computer might update the character position data during the pause, to save time and eliminate flicker.)
</p>
</div>
</div>

<div id="outline-container-org624befd" class="outline-2">
<h2 id="drunkards-walk"><a id="org624befd"></a>Drunkard's walk</h2>
<div class="outline-text-2" id="text-drunkards-walk">
<pre class="example">
(defun drunkard ()
 (setq cursor-type nil)
 (make-grid)
 (let ((x (/ width 2))
 (y (/ height 2)))
 (while t
 (draw-char x y ?\*)
 (sit-for 0.2)
 (clear-char x y)
 (setq x (+ x (1- (random 3)))
 y (+ y (1- (random 3)))))))
</pre>

<p>
The character <a href="http://en.wikipedia.org/wiki/Random_walk">staggers</a> around the screen. The <code>(setq cursor-type nil)</code> hides the cursor. <code>(1- (random 3))</code> returns -1, 0, or 1. The <code>while t</code> means that the drunkard will wander forever (well, actually not forever, this code will break when the character wanders off the grid).
</p>
</div>
</div>

<div id="outline-container-orgb02f18b" class="outline-2">
<h2 id="two-drunkards"><a id="orgb02f18b"></a>Two drunkards</h2>
<div class="outline-text-2" id="text-two-drunkards">
<pre class="example">
(defun two-drunks ()
 (setq cursor-type nil)
 (make-grid)
 (let ((x1 (/ width 2)) (y1 (/ height 2))
 (x2 (/ width 2)) (y2 (/ height 2)))
 (while t
 (draw-char x1 y1 ?\*)
 (draw-char x2 y2 ?\#)
 (sit-for 0.2)
 (make-grid)
 (setq x1 (+ x1 (1- (random 3)))
 y1 (+ y1 (1- (random 3)))
 x2 (+ x2 (1- (random 3)))
 y2 (+ y2 (1- (random 3)))))))
</pre>

<p>
Similar two <code>move-two-chars</code>.
</p>

<p>
A version with a helper function to determine stagger direction:
</p>

<pre class="example">
(defun delta ()
 (1- (random 3)))

(defun two-drunks2 ()
 (setq cursor-type nil)
 (make-grid)
 (let ((x1 (/ width 2)) (y1 (/ height 2))
 (x2 (/ width 2)) (y2 (/ height 2)))
 (while t
 (draw-char x1 y1 ?\*)
 (draw-char x2 y2 ?\#)
 (sit-for 0.2)
 (make-grid)
 (setq x1 (+ x1 (delta))
 y1 (+ y1 (delta))
 x2 (+ x2 (delta))
 y2 (+ y2 (delta))))))
</pre>

<p>
Note that <code>delta</code> is a defun which returns a value, the result of the last (and only, in this case) expression in the defun. This value will be either -1, 0, or 1, and will vary each time it is called, due to its calling <code>random</code>.
</p>
</div>
</div>

<div id="outline-container-orgf90b104" class="outline-2">
<h2 id="a-drunkard-who-can-wander-forever"><a id="orgf90b104"></a>A drunkard who can wander forever</h2>
<div class="outline-text-2" id="text-a-drunkard-who-can-wander-forever">
<pre class="example">
(defun circular-drunkard ()
 (setq cursor-type nil)
 (make-grid)
 (let ((x (/ width 2))
 (y (/ height 2)))
 (while t
 (draw-char x y ?\*)
 (sit-for 0.05)
 (clear-char x y)
 (setq x (+ x (1- (random 3)))
 y (+ y (1- (random 3))))
 ;; like pac-man, edges of screen connect
 (if (&lt; x 1) (setq x width))
 (if (&gt; x width) (setq x 1))
 (if (&lt; y 1) (setq y height))
 (if (&gt; y height) (setq y 1)))))
</pre>

<p>
The <code>if</code> clauses at the end do something about the character walking off the grid.
</p>
</div>
</div>

<div id="outline-container-orgec21d87" class="outline-2">
<h2 id="keyboard-controlled-walker"><a id="orgec21d87"></a>Keyboard controlled walker</h2>
<div class="outline-text-2" id="text-keyboard-controlled-walker">
<pre class="example">
(defun walker ()
 (setq cursor-type nil)
 (make-grid)
 (let ((x 1) (y 1))
 (while t
 (draw-char x y ?\*)
 (let ((key (read-event)))
 (clear-char x y)
 (cond
 ((eq key 'left)
 (setq x (1- x)))
 ((eq key 'right)
 (setq x (1+ x)))
 ((eq key 'up)
 (setq y (1- y)))
 ((eq key 'down)
 (setq y (1+ y)))))
 ;; stop at edges of screen
 (setq x (min x width)
 y (min y height)
 x (max x 1)
 y (max y 1)))))
</pre>

<p>
Like the single-drunkard walk, except that now the keyboard controls where the character walks. <code>(read-event)</code> waits for a keypress, then returns it. The <code>cond</code> (short for conditional) function is a way to do a series of <code>if</code>'s without writing <code>if</code> each time. Storing the result of <code>(read-event)</code> temporarily in a variable <code>key</code> via the <code>let</code> command lets the <code>cond</code> compare the same keypress against all four arrow keys. The apostrophe (<code>'</code>) before <code>left</code>, <code>right</code>, <code>up</code>, and <code>down</code> is necessary to “quote” these, otherwise Lisp would think we meant a variable named <code>left</code>, etc.
</p>

<p>
The <code>min</code> and <code>max</code> function respectively return the smallest and largest of their arguments. This is a succinct way to make sure that x is always less than or equal to <code>width</code>, y is always less than or equal to <code>height</code>, and both x and y are greater than or equal to 1.
</p>
</div>
</div>

<div id="outline-container-org11171c7" class="outline-2">
<h2 id="the-character-keeps-moving-once-directed-by-keypress"><a id="org11171c7"></a>The character keeps moving once directed by keypress</h2>
<div class="outline-text-2" id="text-the-character-keeps-moving-once-directed-by-keypress">
<pre class="example">
(defun runner ()
 (setq cursor-type nil)
 (make-grid)
 (let ((x 1) (y 1)
 (dx 0) (dy 0))
 (while (and (&gt;= x 1) (&lt;= x width))
 (draw-char x y ?\*)
 (let ((key (read-event nil nil 0.1)))
 (cond
 ((eq key 'left)
 (setq dx -1))
 ((eq key 'right)
 (setq dx 1))
 ((eq key 'up)
 (setq dy -1))
 ((eq key 'down)
 (setq dy 1))))
 (clear-char x y)
 (setq x (+ x dx)
 y (+ y dy))
 ;; bounce off edges
 (if (or (&lt; x 1) (&gt; x width))
 (setq dx (- dx)))
 (if (or (&lt; y 1) (&gt; y height))
 (setq dy (- dy)))
 ;; stop at edges of screen
 (setq x (min x width)
 y (min y height)
 x (max x 1)
 y (max y 1)))))
</pre>

<p>
The variables <code>dx</code> and <code>dy</code> stand for delta-x and delta-y, and describe the rate of change of x and y.
</p>

<p>
<code>(read-event nil nil 0.1)</code> waits a tenth of a second for a keypress, and returns either the keypress (if there was one), or <code>nil</code> if there was no keypress in that time. It's a good way to check for input, but keep the action going if there is no input. Because it waits for a bit, we no longer need a <code>(sit-for 0.1)</code>, the wait in <code>read-event</code> does the same thing.
</p>

<p>
The <code>(setq dx (- dx))</code> sets <code>dx</code> to negative <code>dx</code>, reversing the side-to-side motion of the character. Similarly <code>(setq dy (- dy))</code> reverses the up/down motion of the character. This (within the <code>if</code> tests) makes the character bounce of screen edges if it has gone too far. It's a bit much to code in the character bouncing off the screen edges and also constrained by them...
</p>
</div>
</div>

<div id="outline-container-org2d552a9" class="outline-2">
<h2 id="the-character-bounces-off-of-topbottom-of-grid-but-falls-off-the-sides"><a id="org2d552a9"></a>The character bounces off of top/bottom of grid, but falls off the sides</h2>
<div class="outline-text-2" id="text-the-character-bounces-off-of-topbottom-of-grid-but-falls-off-the-sides">
<pre class="example">
(defun runner-with-boundaries ()
 (setq cursor-type nil)
 (make-grid)
 (let ((x 1) (y 1)
 (dx 0) (dy 0))
 (while (and (&gt;= x 1) (&lt;= x width))
 (draw-char x y ?\*)
 (let ((key (read-event nil nil 0.1)))
 (cond
 ((eq key 'left)
 (setq dx -1))
 ((eq key 'right)
 (setq dx 1))
 ((eq key 'up)
 (setq dy -1))
 ((eq key 'down)
 (setq dy 1))))
 (clear-char x y)
 (setq x (+ x dx)
 y (+ y dy))
 ;; bounce off top/bottom edges
 (if (or (&lt; y 1) (&gt; y height))
 (setq dy (- dy)))
 ;; stop at edges of screen
 (setq y (min y height)
 y (max y 1)))
 (insert "Game over")))
</pre>

<p>
The <code>while</code> loop now doesn't go forever, but only so long as the character stays in the left/right grid bounds. The final “Game over” is a bit crude, but this starts getting us closer to Pong!
</p>

<p>
Continued in <a href="file:///project/emacs-animation/lisp8.html">Emacs Lisp programming pt. 8</a>.
</p>
</div>
</div>

</div>
</div>
<div>
        <div class="post-meta">
            <span title="post date" class="post-info">2020-02-10</span>
            <span title="last modification date" class="post-info">2020-02-10</span>
            <span title="tags" class="post-info">:<a href="../../../../../tags/raw">raw</a>:</span>
            <span title="author" class="post-info"><a href="mailto:travis &lt;at&gt; travis-job-14e8f0fe-d940-44e0-aea3-3f63fe5a96b9">lujun9972</a></span>
        </div>
    <script src="../../../../../media/js/jquery-2.1.3.min.js"></script>
    <script src="../../../../../media/js/md5.min.js"></script>
        <section>
            <div id="gitalk-container"></div>
            <script type="text/javascript">
             var gitalk = new Gitalk({
                 clientID: 'fdcb5d9da3f4acb4862c',
                 clientSecret: 'dd0a16312a206782cb7669dcec5e96874ab48170',
                 repo: 'lujun9972.github.com',
                 owner: 'lujun9972',
                 admin: ['lujun9972'],
                 id: md5(location.pathname),      // Ensure uniqueness and length less than 50
                 distractionFreeMode: false  // Facebook-like distraction free mode
             })
             gitalk.render('gitalk-container')
            </script>
        </section>
    <script src="../../../../../media/js/main.js"></script>
        <script>
         var _hmt = _hmt || [];
         (function() {
             var hm = document.createElement("script");
             hm.src = "https://hm.baidu.com/hm.js?7bac4fd0247f69c27887e0d4e3aee41e";
             var s = document.getElementsByTagName("script")[0]; 
             s.parentNode.insertBefore(hm, s);
         })();
        </script>
    <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 27.x(<a href="http://orgmode.org">Org mode</a> 9.x)</p>
        <p>
            Copyright &copy; 2014 - <span id="footerYear"></span> <a href="mailto:travis &lt;at&gt; travis-job-14e8f0fe-d940-44e0-aea3-3f63fe5a96b9">lujun9972</a>
            &nbsp;&nbsp;-&nbsp;&nbsp;
            Powered by <a href="https://github.com/emacs-china/ego" target="_blank">EGO</a><br/>
            <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license"><img src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png" style="border-width:0" alt="Creative Commons License" class="center"></a>
            <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
    </div>
            </div>
            <script type="text/javascript"
                    src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_SVG">
            </script>
            <script type="text/x-mathjax-config">
             MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "AMS"} } });
            </script>
</div>

  </div>
  <!-- https://instant.page/
       Make your site’s pages instant in 1 minute and improve your conversion rate by 1%  -->
  <script src="../../../../../instant.page/1.1.0" type="module" integrity="sha384-EwBObn5QAxP8f09iemwAJljc+sU+eUXeL9vSBw1eNmVarwhKk2F9vBEpaN9rsrtp"></script>
  </body>
</html>
