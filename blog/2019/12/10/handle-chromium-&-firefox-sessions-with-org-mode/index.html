<!DOCTYPE html>
<html lang="en">
<head>
  <title>Handle Chromium &amp; Firefox sessions with org-mode - EMACS-DOCUMENT</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <meta name="author" content="lujun9972" />
  <meta name="keywords" content="raw" />
  <!-- <link rel="stylesheet" href="../../../../../media/css/main.css" type="text/css"/>
       <link rel="stylesheet" href="../../../../../media/css/comment.css" type="text/css"/> -->
  <link rel='stylesheet' href='https://cdn.jsdelivr.net/gh/kognise/water.css@latest/dist/dark.css'>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
</head>

  <body><div class="container">
<div>
  <header class="masthead">
    <h1 class="masthead-title"><a href="../../../../../">EMACS-DOCUMENT</a></h1>
    <p>=============&gt;随便,谢谢</p>
    <nav class="site-nav">
      <ul class="trigger">
        <li><a href="../../../../../years/">Years</a></li>
        <li><a href="../../../../../authors/">Authors</a></li>
        <li><a href="../../../../../tags/">Tags</a></li>
        <li><a href="../../../../../about/">About</a></li>
        <li><a href="https://github.com/lujun9972/emacs-document.git">Github</a></li>
        <li><a href="../../../../../rss.xml">RSS</a></li>
      </ul>
    </nav>
    <form method="get" id="searchform" action="https://www.bing.com/search">
      <input type="text" class="field" name="q" id="s" placeholder="Search">
      <input type="hidden" name="as_sitesearch" value="lujun9972.github.io/emacs-document">
    </form>
  </header>
</div>

<div>
<div class="post">
<h1 class="title">Handle Chromium &amp; Firefox sessions with org-mode</h1>
<div id="table-of-contents">
<h2>&#30446;&#24405;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#what_about_firefox?">那么Firefox呢?</a></li>
</ul>
</div>
</div>
<p>
I was big fan of, small addon for Chrome and Chromium that will save all open tabs, assign the name to session and, when is needed, restore it.
我是 <a href="https://chrome.google.com/webstore/detail/session-manager/mghenlmbmjcpehccoangkdpagbcbkdpc?hl=en-US">Session Manager</a> 的大粉丝，它是Chrome和Chromium的小插件，可以保存所有打开的选项卡，为会话命名，并在需要时恢复会话。
</p>

<p>
它非常有用，特别是如果你像我一样，白天的时候需要在多个“思维活动”之间切换——研究、开发或者新闻阅读。或者您只是单纯地希望记住几天前的工作流(和选项卡)。
</p>

<p>
在我决定放弃chromium上除了 <a href="https://chrome.google.com/webstore/detail/ublock-origin/cjpalhdlnbpafiamejdnhcphjbkeiagm?hl=en">uBlock Origin</a> 之外的所有扩展后, 也到了寻找替代品的时候了. 我的主要目标是使之与浏览器无关同时会话链接需要保存在文本文件中, 这样我就可以享受所有纯文本的好处了. 还有什么比 <a href="https://orgmode.org/">org-mode</a> 更好呢 ;)
</p>

<p>
and with some elisp sugar and coffee, here is the code:
很久以前我就发现了这个小诀窍:<a href="https://superuser.com/a/1310873">通过命令行获取当前在谷歌Chrome中打开的标签</a> 再加上些elisp代码:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="font-weight: bold;">require</span> '<span style="font-weight: bold; text-decoration: underline;">cl-lib</span>)

(<span style="font-weight: bold;">defun</span> <span style="font-weight: bold;">save-chromium-session</span> ()
  <span style="font-style: italic;">"Reads chromium current session and generate org-mode heading with items."</span>
  (<span style="font-weight: bold;">interactive</span>)
  (<span style="font-weight: bold;">save-excursion</span>
    (<span style="font-weight: bold;">let*</span> ((cmd <span style="font-style: italic;">"strings ~/'.config/chromium/Default/Current Session' | 'grep' -E '^https?://' | sort | uniq"</span>)
           (ret (shell-command-to-string cmd)))
      (insert
       (concat
        <span style="font-style: italic;">"* "</span>
        (format-time-string <span style="font-style: italic;">"[%Y-%m-%d %H:%M:%S]"</span>)
        <span style="font-style: italic;">"\n"</span>
        (mapconcat 'identity
                   (cl-reduce (<span style="font-weight: bold;">lambda</span> (lst x)
                                (<span style="font-weight: bold;">if</span> (<span style="font-weight: bold;">and</span> x (not (string= <span style="font-style: italic;">""</span> x)))
                                    (cons (concat <span style="font-style: italic;">"  - "</span> x) lst)
                                  lst))
                              (split-string ret <span style="font-style: italic;">"\n"</span>)
                              <span style="font-weight: bold;">:initial-value</span> (list))
                   <span style="font-style: italic;">"\n"</span>))))))

(<span style="font-weight: bold;">defun</span> <span style="font-weight: bold;">restore-chromium-session</span> ()
  <span style="font-style: italic;">"Restore session, by openning each link in list with (browse-url).</span>
<span style="font-style: italic;">Make sure to put cursor on date heading that contains list of urls."</span>
  (<span style="font-weight: bold;">interactive</span>)
  (<span style="font-weight: bold;">save-excursion</span>
    (beginning-of-line)
    (<span style="font-weight: bold;">when</span> (looking-at <span style="font-style: italic;">"^\\*"</span>)
      (forward-line 1)
      (<span style="font-weight: bold;">while</span> (looking-at <span style="font-style: italic;">"^[ ]+-[ ]+</span><span style="font-weight: bold; font-style: italic;">\\</span><span style="font-weight: bold; font-style: italic;">(</span><span style="font-style: italic;">http.?+</span><span style="font-weight: bold; font-style: italic;">\\</span><span style="font-weight: bold; font-style: italic;">)</span><span style="font-style: italic;">$"</span>)
        (<span style="font-weight: bold;">let*</span> ((ln (thing-at-point 'line t))
               (ln (replace-regexp-in-string <span style="font-style: italic;">"^[ ]+-[ ]+"</span> <span style="font-style: italic;">""</span> ln))
               (ln (replace-regexp-in-string <span style="font-style: italic;">"\n"</span> <span style="font-style: italic;">""</span> ln)))
          (browse-url ln))
        (forward-line 1)))))
</pre>
</div>

<p>
那么，它的工作是什么呢?
</p>

<p>
计算上述代码，打开一个新org-mode文件并调用=M-x save-chromium-session=。它会创建类似这样的东西:
</p>

<div class="org-src-container">
<pre class="src src-org"><span style="font-weight: bold;">* </span><span style="text-decoration: underline;">[2019-12-04 12:14:02]</span>
- <span style="text-decoration: underline;"><a href="https://www.reddit.com/r/emacs/comments/">https://www.reddit.com/r/emacs/comments/</a></span>...
- <span style="text-decoration: underline;"><a href="https://www.reddit.com/r/Clojure">https://www.reddit.com/r/Clojure</a></span>
- <span style="text-decoration: underline;"><a href="https://news.ycombinator.com">https://news.ycombinator.com</a></span>
</pre>
</div>

<p>
也就是任何在 chromium 实例中运行着的URL. 要还原的话, 则将光标置于所需日期上然后运行 <code>M-x restore-chromium-session</code>. 所有标签都应该恢复了。
</p>

<p>
以下是我的使用案例，其中的数据是随机生成的:
</p>

<div class="org-src-container">
<pre class="src src-org">#+TITLE: <span style="font-weight: bold;">Browser sessions</span>

<span style="font-weight: bold;">* </span><span style="text-decoration: underline;">[2019-12-01 23:15:00]</span><span style="font-weight: bold;">...</span>
<span style="font-weight: bold;">* </span><span style="text-decoration: underline;">[2019-12-02 18:10:20]</span><span style="font-weight: bold;">...</span>
<span style="font-weight: bold;">* </span><span style="text-decoration: underline;">[2019-12-03 19:00:12]</span>
- <span style="text-decoration: underline;"><a href="https://www.reddit.com/r/emacs/comments/">https://www.reddit.com/r/emacs/comments/</a></span>...
- <span style="text-decoration: underline;"><a href="https://www.reddit.com/r/Clojure">https://www.reddit.com/r/Clojure</a></span>
- <span style="text-decoration: underline;"><a href="https://news.ycombinator.com">https://news.ycombinator.com</a></span>

<span style="font-weight: bold;">* </span><span style="text-decoration: underline;">[2019-12-04 12:14:02]</span>
- <span style="text-decoration: underline;"><a href="https://www.reddit.com/r/emacs/comments/">https://www.reddit.com/r/emacs/comments/</a></span>...
- <span style="text-decoration: underline;"><a href="https://www.reddit.com/r/Clojure">https://www.reddit.com/r/Clojure</a></span>
- <span style="text-decoration: underline;"><a href="https://news.ycombinator.com">https://news.ycombinator.com</a></span>
</pre>
</div>

<p>
请注意，用于读取Chromium会话的方法并不完美: <code>strings</code> 将从二进制数据库中读取任何类似URL字符串的内容，有时这将产生不完整的url。不过，您可以很方便地地编辑它们,从而保持会话文件简洁。
</p>

<p>
为了真正打开标签，elisp代码中使用到了<a href="https://www.gnu.org/software/emacs/manual/html_node/emacs/Browse_002dURL.html">browse-url</a>，它可以通过 <code>browse-url-browser-function</code> 变量进一步定制成运行Chromium, Firefox或任何其他浏览器。请务必阅读该变量的相关文档。
</p>

<p>
别忘了把会话文件放在git、mercurial或svn中，这样你就再也不会丢失会话历史记录了 :)
</p>

<div id="outline-container-org1b47e87" class="outline-2">
<h2 id="what_about_firefox?"><a id="org1b47e87"></a>那么Firefox呢?</h2>
<div class="outline-text-2" id="text-what_about_firefox?">
<p>
如果您正在使用Firefox(最近的版本)，并且想要获取会话url，下面是操作方法。
</p>

<p>
首先，下载并编译<a href="https://github.com/andikleen/lz4json">lz4json</a>，这是一个可以解压缩Mozilla lz4json格式的小工具，Firefox以这种格式来存储会话数据。会话数据(在撰写本文时)存储在 <code>$HOME/.mozilla/firefox/&lt;unique-name&gt;/sessionstore-backup /recovery.jsonlz4</code> 中。
</p>

<p>
如果Firefox没有运行， 则没有 <code>recovery.jsonlz4</code>, 这种情况下用 <code>previous.jsonlz4</code> 代替.
=恢复。jsonlz4=将不存在，但使用=先前。jsonlz4 =。
</p>

<p>
要提取网址，尝试在终端运行:
</p>

<div class="org-src-container">
<pre class="src src-shell">$ lz4jsoncat recovery.jsonlz4 | grep -oP <span style="font-style: italic;">'"(http.+?)"'</span> | sed <span style="font-style: italic;">'s/"//g'</span> | sort | uniq
</pre>
</div>

<p>
然后更新 <code>save-chromium-session</code> 为:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="font-weight: bold;">defun</span> <span style="font-weight: bold;">save-chromium-session</span> ()
  <span style="font-style: italic;">"Reads chromium current session and converts it to org-mode chunk."</span>
  (<span style="font-weight: bold;">interactive</span>)
  (<span style="font-weight: bold;">save-excursion</span>
    (<span style="font-weight: bold;">let*</span> ((path <span style="font-style: italic;">"~/.mozilla/firefox/&lt;unique-name&gt;/sessionstore-backups/recovery.jsonlz4"</span>)
           (cmd (concat <span style="font-style: italic;">"lz4jsoncat "</span> path <span style="font-style: italic;">" | grep -oP '\"(http.+?)\"' | sed 's/\"//g' | sort | uniq"</span>))
(ret (shell-command-to-string cmd)))
...
<span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">rest of the code is unchanged</span>
</pre>
</div>

<p>
更新本函数的文档字符串、函数名以及进一步的重构都留作练习。
</p>
</div>
</div>

</div>
</div>
<div>
        <div class="post-meta">
            <span title="post date" class="post-info">2019-12-10</span>
            <span title="last modification date" class="post-info">2019-12-10</span>
            <span title="tags" class="post-info">:<a href="../../../../../tags/raw">raw</a>:</span>
            <span title="author" class="post-info"><a href="mailto:travis &lt;at&gt; travis-job-c6bd8e13-eac8-4571-89f1-fb481de4254d">lujun9972</a></span>
        </div>
    <script src="../../../../../media/js/jquery-2.1.3.min.js"></script>
    <script src="../../../../../media/js/md5.min.js"></script>
        <section>
            <div id="gitalk-container"></div>
            <script type="text/javascript">
             var gitalk = new Gitalk({
                 clientID: 'fdcb5d9da3f4acb4862c',
                 clientSecret: 'dd0a16312a206782cb7669dcec5e96874ab48170',
                 repo: 'lujun9972.github.com',
                 owner: 'lujun9972',
                 admin: ['lujun9972'],
                 id: md5(location.pathname),      // Ensure uniqueness and length less than 50
                 distractionFreeMode: false  // Facebook-like distraction free mode
             })
             gitalk.render('gitalk-container')
            </script>
        </section>
    <script src="../../../../../media/js/main.js"></script>
        <script>
         var _hmt = _hmt || [];
         (function() {
             var hm = document.createElement("script");
             hm.src = "https://hm.baidu.com/hm.js?7bac4fd0247f69c27887e0d4e3aee41e";
             var s = document.getElementsByTagName("script")[0]; 
             s.parentNode.insertBefore(hm, s);
         })();
        </script>
    <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 27.x(<a href="http://orgmode.org">Org mode</a> 9.x)</p>
        <p>
            Copyright &copy; 2014 - <span id="footerYear"></span> <a href="mailto:travis &lt;at&gt; travis-job-c6bd8e13-eac8-4571-89f1-fb481de4254d">lujun9972</a>
            &nbsp;&nbsp;-&nbsp;&nbsp;
            Powered by <a href="https://github.com/emacs-china/ego" target="_blank">EGO</a><br/>
            <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license"><img src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png" style="border-width:0" alt="Creative Commons License" class="center"></a>
            <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
    </div>
            </div>
            <script type="text/javascript"
                    src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_SVG">
            </script>
            <script type="text/x-mathjax-config">
             MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "AMS"} } });
            </script>
</div>

  </div>
  <!-- https://instant.page/
       Make your site’s pages instant in 1 minute and improve your conversion rate by 1%  -->
  <script src="../../../../../instant.page/1.1.0" type="module" integrity="sha384-EwBObn5QAxP8f09iemwAJljc+sU+eUXeL9vSBw1eNmVarwhKk2F9vBEpaN9rsrtp"></script>
  </body>
</html>
