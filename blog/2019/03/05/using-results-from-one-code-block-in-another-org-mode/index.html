<!DOCTYPE html>
<html lang="en">
<head>
  <title>Using results from one code block in another org-mode - EMACS-DOCUMENT</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <meta name="author" content="lujun9972" />
  <meta name="keywords" content="raw" />
  <!-- <link rel="stylesheet" href="../../../../../media/css/main.css" type="text/css"/>
       <link rel="stylesheet" href="../../../../../media/css/comment.css" type="text/css"/> -->
  <link rel='stylesheet' href='https://cdn.jsdelivr.net/gh/kognise/water.css@latest/dist/dark.css'>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
</head>

  <body><div class="container">
<div>
  <header class="masthead">
    <h1 class="masthead-title"><a href="../../../../../">EMACS-DOCUMENT</a></h1>
    <p>=============&gt;集思广益</p>
    <nav class="site-nav">
      <ul class="trigger">
        <li><a href="../../../../../years/">Years</a></li>
        <li><a href="../../../../../authors/">Authors</a></li>
        <li><a href="../../../../../tags/">Tags</a></li>
        <li><a href="../../../../../about/">About</a></li>
        <li><a href="https://github.com/lujun9972/emacs-document">Github</a></li>
        <li><a href="../../../../../rss.xml">RSS</a></li>
      </ul>
    </nav>
    <form method="get" id="searchform" action="https://www.bing.com/search">
      <input type="text" class="field" name="q" id="s" placeholder="Search">
      <input type="hidden" name="as_sitesearch" value="lujun9972.github.io/emacs-document">
    </form>
  </header>
</div>

<div>
<div class="post">
<h1 class="title">Using results from one code block in another org-mode</h1>
<div id="table-of-contents">
<h2>&#30446;&#24405;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org015bf3f"><span class="done DONE">DONE</span> Using results from one code block in another org-mode</a>
<ul>
<li><a href="#org0894890">:var</a></li>
<li><a href="#orgb215ee5">:cache</a></li>
<li><a href="#org907a763">:wrap</a></li>
<li><a href="#org62f270b">:file</a></li>
<li><a href="#org28ac063">"remote" data</a></li>
<li><a href="#org51102df">Manually saving data in files</a></li>
<li><a href="#orgab34aaa">An appendix for data</a></li>
<li><a href="#org1d96bf3">Caveats</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org015bf3f" class="outline-2">
<h2 id="org015bf3f"><span class="done DONE">DONE</span> Using results from one code block in another org-mode</h2>
<div class="outline-text-2" id="text-org015bf3f">
<p>
One really great feature in org-mode is you have many options to pass data between code-blocks. In this post we look at some of these options using emacs-lisp as the language. This runs in a <i>session</i> where you can keep variables in memory between blocks, and use them in subsequent blocks.
</p>

<p>
Here we set a variable to a value.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">setq</span> some-variable <span style="color: #a45bad;">42</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
42

</pre>

<p>
Then later in another block we can use that variable:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #4f97d7;">(</span>+ some-variable <span style="color: #a45bad;">1</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
43

</pre>

<p>
While you are in the session, <code>some-variable</code> can be used. If you want some mind-bending trouble, the emacs-lisp session is global, and you can access <code>some-variable</code> even in another buffer! Don't do that. When you close emacs this variable will disappear, and all that is left are the results from above.
</p>

<p>
There is another way to pass information from one block to another using named src blocks and variables in the block header. This allows you to pass data between blocks by name, and you will see later you can even access the results by name from other files.
</p>
</div>

<div id="outline-container-org0894890" class="outline-3">
<h3 id="org0894890">:var</h3>
<div class="outline-text-3" id="text-org0894890">
<p>
First, we give our src block a name like this:
</p>

<pre class="example">
#+name: block-1
#+BEGIN_SRC emacs-lisp
(current-time-string)
#+END_SRC
</pre>

<p>
When we run this, the results will have a name too.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp" id="org33e9215"><span style="color: #4f97d7;">(</span>current-time-string<span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
Tue Feb 12 08:19:23 2019

</pre>

<p>
Now, we can use the named result as <i>input</i> to a new block using the :var header.
</p>

<pre class="example">
#+BEGIN_SRC emacs-lisp :var input=block-1
(format "We got %S in block-1" input)
#+END_SRC
</pre>

<p>
When we run this block, emacs will run block-1 and put the output in to the variable <code>input</code> which we use inside the code block.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #4f97d7;">(</span>format <span style="color: #2d9574;">"We got %S in block-1"</span> input<span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
We got "Tue Feb 12 08:20:44 2019" in block-1

</pre>

<p>
Some things to note:
</p>
<ol class="org-ol">
<li>Every time you run this, block-1 gets rerun.</li>
<li>The results in this block are not the same as in block-1</li>
<li>The results in block-1 are not changed when you run the second block.</li>
</ol>

<p>
You may not want to rerun block-1 each time; maybe it is an expensive calculation, or maybe it should not be changed. You can prevent this behavior by using the :cache header.
</p>
</div>
</div>

<div id="outline-container-orgb215ee5" class="outline-3">
<h3 id="orgb215ee5">:cache</h3>
<div class="outline-text-3" id="text-orgb215ee5">
<p>
If you specify <code>:cache yes</code> then org-mode <i>should</i> store a hash of the code block with the results, and if the code block hasn't changed then it should not run again.
</p>

<pre class="example">
#+name: block-2
#+BEGIN_SRC emacs-lisp :cache yes
(current-time-string)
#+END_SRC
</pre>

<div class="org-src-container">
<pre class="src src-emacs-lisp" id="org4c47941"><span style="color: #4f97d7;">(</span>current-time-string<span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
Tue Feb 12 08:06:22 2019

</pre>

<p>
Now, we use block-2 as input to a block, we see the output is the same as the output from block-2.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #4f97d7;">(</span>format <span style="color: #2d9574;">"We got %S in block-2"</span> input<span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
We got "Tue Feb 12 08:06:22 2019" in block-2

</pre>

<p>
Ok, but what if my results are too large to put in the buffer, or too complex for text? You still have some options.
</p>
</div>
</div>

<div id="outline-container-org907a763" class="outline-3">
<h3 id="org907a763">:wrap</h3>
<div class="outline-text-3" id="text-org907a763">
<p>
Suppose we generate some json in one block, and we want to use it in another block. We still want to see the json in the buffer as an intermediate result. We can wrap the output in a json block like this.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp" id="org47c7eaf"><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">require</span> '<span style="color: #a45bad;">json</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7;">(</span>json-encode `<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #2d9574;">"date"</span> . ,<span style="color: #67b11d;">(</span>current-time-string<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<div class="json">
<p>
{"date":"Tue Feb 12 08:30:20 2019"}
</p>

</div>

<p>
Then, we can simply input that output into a new block.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #4f97d7;">(</span>format <span style="color: #2d9574;">"We got %S in json"</span> input<span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
We got "{\"date\":\"Tue Feb 12 08:30:20 2019\"}
" in json

</pre>

<p>
This admittedly still pretty simple, text-based data. It is probably not a good idea to do this with binary data.
</p>

<p>
Note you can refer to this result even in another org-file:
</p>

<pre class="example">
#+BEGIN_SRC emacs-lisp :var input=./2019-02-12.org:json
input
#+END_SRC

#+RESULTS:
: {"date":"Tue Feb 12 08:30:20 2019"}
</pre>
</div>
</div>


<div id="outline-container-org62f270b" class="outline-3">
<h3 id="org62f270b">:file</h3>
<div class="outline-text-3" id="text-org62f270b">
<p>
It may be that your data is too large to conveniently put into your org-file, or maybe it is binary data. No problem, just put it into an external file using the :file header. It looks like this:
</p>

<pre class="example">
#+name: block-3
#+BEGIN_SRC emacs-lisp :cache yes :file block-3
(require 'json)
(json-encode `(("date" . ,(current-time-string))))
#+END_SRC

#+RESULTS[a14d376653bd8c40a0961ca95f21d8837dddec66]: block-3
[[file:block-3]]
</pre>


<p>
Note that you have to provide a file name for this. Sometimes that is nice if you want a human recognizable file to send to someone, but it would also be nice if there was an automatic naming scheme, e.g. based on an sha-1 hash of the src block.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp" id="org775890f"><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">require</span> '<span style="color: #a45bad;">json</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7;">(</span>json-encode `<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #2d9574;">"date"</span> . ,<span style="color: #67b11d;">(</span>current-time-string<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<p>
<a href="block-3">block-3</a>
</p>

<p>
Now you can use other tools to check out the file. Here we can still use simple shell tools.
</p>

<div class="org-src-container">
<pre class="src src-sh">cat block-3
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #4f97d7;">{</span><span style="color: #2d9574;">"date"</span>:<span style="color: #2d9574;">"Tue Feb 12 08:46:55 2019"</span><span style="color: #4f97d7;">}</span>
</pre>
</div>


<p>
The output of block-3 is a file name:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">input
</pre>
</div>

<pre class="example">
/Users/jkitchin/Box Sync/kitchingroup/jkitchin/journal/2019/02/12/block-3

</pre>

<p>
So you can use it in a new block to read the data in, and then do something new with it.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">with-temp-buffer</span>
  <span style="color: #bc6ec5;">(</span>insert-file-contents input<span style="color: #bc6ec5;">)</span>
  <span style="color: #bc6ec5;">(</span>format <span style="color: #2d9574;">"We got %S in block-3"</span> <span style="color: #2d9574;">(</span>json-read-from-string <span style="color: #67b11d;">(</span>buffer-string<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
We got ((date . "Tue Feb 12 08:46:55 2019")) in block-3

</pre>
</div>
</div>

<div id="outline-container-org28ac063" class="outline-3">
<h3 id="org28ac063">"remote" data</h3>
<div class="outline-text-3" id="text-org28ac063">
<p>
The blocks do not have to be in order. If you want, you can put your blocks in an appendix, and then just have analysis blocks here that use them. That way, you can have short blocks here that are more readable, but longer, more complex blocks elsewhere that do not clutter your document.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">with-temp-buffer</span>
  <span style="color: #bc6ec5;">(</span>insert-file-contents input<span style="color: #bc6ec5;">)</span>
  <span style="color: #bc6ec5;">(</span>format <span style="color: #2d9574;">"We got %S in the appendix data"</span> <span style="color: #2d9574;">(</span>json-read-from-string <span style="color: #67b11d;">(</span>buffer-string<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
We got "{\"date\":\"Tue Feb 12 09:11:12 2019\"}" in the appendix data

</pre>
</div>
</div>


<div id="outline-container-org51102df" class="outline-3">
<h3 id="org51102df">Manually saving data in files</h3>
<div class="outline-text-3" id="text-org51102df">
<p>
Note you can also manually save data in a file, for example:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp" id="orged967af"><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">require</span> '<span style="color: #a45bad;">json</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">let</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>f <span style="color: #2d9574;">"block-4.json"</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">with-temp-file</span> f
    <span style="color: #2d9574;">(</span>prin1
     <span style="color: #67b11d;">(</span>json-encode `<span style="color: #b1951d;">(</span><span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"date"</span> . ,<span style="color: #bc6ec5;">(</span>current-time-string<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>current-buffer<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
  f<span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
block-4.json

</pre>

<p>
We put the filename as the last variable which is returned by the block, so that we don't have to manually type it later in the next block. You know, try not to repeat yourself...
</p>

<p>
This just shows we did write out to our file:
</p>

<div class="org-src-container">
<pre class="src src-sh">cat block-4.json
</pre>
</div>

<pre class="example">
:\"Tue Feb 12 08:50:00 2019\"}

</pre>

<p>
And we read the file in here, using the filename from block-4 as an input variable.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">with-temp-buffer</span>
  <span style="color: #bc6ec5;">(</span>insert-file-contents input<span style="color: #bc6ec5;">)</span>
  <span style="color: #bc6ec5;">(</span>format <span style="color: #2d9574;">"We got %S in block-4"</span> <span style="color: #2d9574;">(</span>json-read-from-string <span style="color: #67b11d;">(</span>buffer-string<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
We got "{\"date\":\"Tue Feb 12 08:51:25 2019\"}" in block-4

</pre>
</div>
</div>

<div id="outline-container-orgab34aaa" class="outline-3">
<h3 id="orgab34aaa"><a id="ID-0452775B-D200-4B9B-BC09-C6935D9183A4"></a>An appendix for data</h3>
<div class="outline-text-3" id="text-orgab34aaa">
<div class="org-src-container">
<pre class="src src-emacs-lisp" id="orge06cd66"><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">require</span> '<span style="color: #a45bad;">json</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">let</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>f <span style="color: #2d9574;">"appendix.json"</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">with-temp-file</span> f
    <span style="color: #2d9574;">(</span>prin1
     <span style="color: #67b11d;">(</span>json-encode `<span style="color: #b1951d;">(</span><span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"date"</span> . ,<span style="color: #bc6ec5;">(</span>current-time-string<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>current-buffer<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
  f<span style="color: #4f97d7;">)</span>
</pre>
</div>

<pre class="example">
appendix.json

</pre>
</div>
</div>


<div id="outline-container-org1d96bf3" class="outline-3">
<h3 id="org1d96bf3">Caveats</h3>
<div class="outline-text-3" id="text-org1d96bf3">
<p>
Using org-mode like this is almost always finding the right tradeoffs in what is persistent, and where is it stored. Not all of the intermediate data/calculations are stored; if they are really cheap you can just run the code blocks again. If they are really small, i.e. easy for your to read in a few lines, you can store them in the document. If they are really large, you can store them in a file.
</p>

<p>
The beauty of having everything in an org-file is you have a single file that is easy to transport. When the files get too large though, it can become impractical, e.g. emacs may slow down if you try to put thousands of lines of xml data into the buffer. Then, you have to make some decisions about what to keep, where to keep it, and in what form to keep it.
</p>

<p>
For short projects where you only need a single compute session, having everything in memory may be fine. For longer projects, say one that is long enough you will close all the buffers, and possibly restart emacs in between working on it, then you have to make some decisions about what to save from each block so you can continue the work in the next session. Again, you have to decide what to save, where to save, and in what form.
</p>

<p>
Once you start saving data outside the org-file, it becomes less portable, or more tricky to move the file because you need to also move all the data files to keep it intact. I have explored a concept of making an org-archive in the past, where you get a list of all files linked in the org-file, but this so far has just been worked out for some small proof of concept ideas.
</p>

<p>
Not all languages are the same in org-mode. They do not all support sessions for example, and they may not all work like the examples here. The scimax iPython modifications do not behave like the examples above. That is probably due to bugs I have inadvertently introduced, and in the future I will try to make it work like emacs-lisp does above.
</p>

<p>
Overall, org-mode has one of the most flexible and powerful systems for passing and reusing data in documents I have ever seen. It is not perfect, and in such a powerful system there are many unexplored or lightly traveled corners that may have hazards in them. It still seems pretty promising though.
</p>
</div>
</div>
</div>

</div>
</div>
<div>
        <div class="post-meta">
            <span title="post date" class="post-info">2019-03-05</span>
            <span title="last modification date" class="post-info">2019-04-26</span>
            <span title="tags" class="post-info">:<a href="../../../../../tags/raw">raw</a>:</span>
            <span title="author" class="post-info"><a href="mailto:lujun9972 &lt;at&gt; T520">lujun9972</a></span>
        </div>
    <script src="../../../../../media/js/jquery-2.1.3.min.js"></script>
    <script src="../../../../../media/js/md5.min.js"></script>
        <section>
            <div id="gitalk-container"></div>
            <script type="text/javascript">
             var gitalk = new Gitalk({
                 clientID: 'fdcb5d9da3f4acb4862c',
                 clientSecret: 'dd0a16312a206782cb7669dcec5e96874ab48170',
                 repo: 'lujun9972.github.com',
                 owner: 'lujun9972',
                 admin: ['lujun9972'],
                 id: md5(location.pathname),      // Ensure uniqueness and length less than 50
                 distractionFreeMode: false  // Facebook-like distraction free mode
             })
             gitalk.render('gitalk-container')
            </script>
        </section>
    <script src="../../../../../media/js/main.js"></script>
    <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 26.x(<a href="http://orgmode.org">Org mode</a> 9.x)</p>
        <p>
            Copyright &copy; 2014 - <span id="footerYear"></span> <a href="mailto:lujun9972 &lt;at&gt; T520">lujun9972</a>
            &nbsp;&nbsp;-&nbsp;&nbsp;
            Powered by <a href="https://github.com/emacs-china/ego" target="_blank">EGO</a><br/>
            <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license"><img src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png" style="border-width:0" alt="Creative Commons License" class="center"></a>
            <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
    </div>
            </div>
            <script type="text/javascript"
                    src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_SVG">
            </script>
            <script type="text/x-mathjax-config">
             MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "AMS"} } });
            </script>
</div>

  </div>
  <!-- https://instant.page/
       Make your site’s pages instant in 1 minute and improve your conversion rate by 1%  -->
  <script src="../../../../../instant.page/1.1.0" type="module" integrity="sha384-EwBObn5QAxP8f09iemwAJljc+sU+eUXeL9vSBw1eNmVarwhKk2F9vBEpaN9rsrtp"></script>
  </body>
</html>
