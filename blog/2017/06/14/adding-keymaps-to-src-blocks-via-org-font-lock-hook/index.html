<!DOCTYPE html>
<html lang="en">
<head>
  <title>Adding-keymaps-to-src-blocks-via-org-font-lock-hook - EMACS-DOCUMENT</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <meta name="author" content="lujun9972" />
  <meta name="keywords" content="raw" />
  <style>
   #ds-thread #ds-reset .ds-comment-body p {color: #ffffff;}
   #ds-thread #ds-reset .ds-comment-body p a {color: #ff0;}
   #ds-thread #ds-reset .ds-comment-body p a:hover {color: #0ff;}
   #disqus_thread a {color: #00ffff;}
  </style>
  <link rel="stylesheet" href="/media/css/main.css" type="text/css"/>
  <link rel="stylesheet" href="/media/css/comment.css" type="text/css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
</head>

  <body><div class="container">
<div>
  <header class="masthead">
    <h1 class="masthead-title"><a href="/">EMACS-DOCUMENT</a></h1>
    <p>=============&gt;随便,谢谢</p>
    <nav class="site-nav">
      <div class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z" fill="#ffff00"/>
          <path d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z" fill="#ffff00"/>
          <path d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z" fill="#ffff00"/>
        </svg>
      </div>
      <ul class="trigger">
        <li><a href="/years/">Years</a></li>
        <li><a href="/authors/">Authors</a></li>
        <li><a href="/tags/">Tags</a></li>
        <li><a href="/about/">About</a></li>
        <li><a href="https://github.com/lujun9972/emacs-document.git">Github</a></li>
        <li><a href="/rss.xml">RSS</a></li>
      </ul>
    </nav>
    <form method="get" id="searchform" action="http://www.google.com/search">
      <input type="text" class="field" name="q" id="s" placeholder="Search">
      <input type="hidden" name="as_sitesearch" value="lujun9972.github.io/emacs-document">
    </form>
  </header>
</div>

<div>
<div class="post">
<h1 class="title">Adding-keymaps-to-src-blocks-via-org-font-lock-hook</h1>
<div id="table-of-contents">
<h2>&#30446;&#24405;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org0444cd8">Update</a></li>
<li><a href="#org3be9204">Update #2</a></li>
</ul>
</div>
</div>
<p>
I had an idea to use custom keymaps in src-blocks. For example, you could then
use lispy directly in your org-files without entering org-special-edit, or the
elpy key-bindings in python blocks. There are other solutions I have seen,
e.g. polymode, that claim to do this. You might guess that if they worked, I
would not be writing this! There was some nice discussion about this idea on
the org-mode mailing list, and Nicolas Goaziou pointed out this might be
accomplished with the org-font-lock-hook.
</p>

<p>
You can check out the video here:
</p>

<p>
<a href="https://www.youtube.com/embed/a2jHqB1qWiY">https://www.youtube.com/embed/a2jHqB1qWiY</a>
</p>

<p>
It was relatively easy to figure out how to do this. Keymaps can be added to
regions during font-lock, so I just had to hook into the org-mode font lock
system with a function to find the src blocks and add the keymap as a
text-property. That took three steps:
</p>

<ol class="org-ol">
<li>Define the keymaps to use. I use an a-list of (language . map) for this.</li>
<li>Define the font-lock function. This will add the keymap properties to
src-blocks.</li>
<li>Define a minor mode to toggle this feature on and off.</li>
</ol>

<p>
Here is the definition of the keymaps. Generally I just copy the mode-map I
want and then add some things to them. For example sometimes it is still a
good idea to jump into the org-special-edit mode. For example, if you try to
use a command in a Python block to send the buffer to the repl while in
org-mode you are sure to get an error! You might also want to add the C-c C-e
export command if you use that a lot. An alternative approach, of course, is
to copy the org-map and add additional bindings to it. The choice is up to
you.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="font-weight: bold;">require</span> '<span style="font-weight: bold; text-decoration: underline;">lispy</span>)
(<span style="font-weight: bold;">require</span> '<span style="font-weight: bold; text-decoration: underline;">elpy</span>)

(<span style="font-weight: bold;">setq</span> scimax-src-block-keymaps
      `((<span style="font-style: italic;">"ipython"</span> . ,(<span style="font-weight: bold;">let</span> ((map (make-composed-keymap
                                  `(,elpy-mode-map ,python-mode-map ,pyvenv-mode-map)
                                  org-mode-map)))
                        <span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">In org-mode I define RET so we f</span>
                        (define-key map (kbd <span style="font-style: italic;">"&lt;return&gt;"</span>) 'newline)
                        (define-key map (kbd <span style="font-style: italic;">"C-c C-c"</span>) 'org-ctrl-c-ctrl-c)
                        map))
        (<span style="font-style: italic;">"python"</span> . ,(<span style="font-weight: bold;">let</span> ((map (make-composed-keymap
                                 `(,elpy-mode-map ,python-mode-map ,pyvenv-mode-map)
                                 org-mode-map)))
                       <span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">In org-mode I define RET so we f</span>
                       (define-key map (kbd <span style="font-style: italic;">"&lt;return&gt;"</span>) 'newline)
                       (define-key map (kbd <span style="font-style: italic;">"C-c C-c"</span>) 'org-ctrl-c-ctrl-c)
                       map))
        (<span style="font-style: italic;">"emacs-lisp"</span> . ,(<span style="font-weight: bold;">let</span> ((map (make-composed-keymap `(,lispy-mode-map
                                                            ,emacs-lisp-mode-map
                                                            ,outline-minor-mode-map)
                                                          org-mode-map)))
                           (define-key map (kbd <span style="font-style: italic;">"C-c C-c"</span>) 'org-ctrl-c-ctrl-c)
                           map))))
</pre>
</div>

<p>
Next we define the function that will apply the keymap to each src block. The
keymaps are only applied when they are defined in the variable above. This
function is derived from org-fontify-meta-lines-and-blocks-1.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="font-weight: bold;">defun</span> <span style="font-weight: bold;">scimax-add-keymap-to-src-blocks</span> (limit)
  <span style="font-style: italic;">"Add keymaps to src-blocks defined in `</span><span style="font-weight: bold; font-style: italic; text-decoration: underline;">scimax-src-block-keymaps</span><span style="font-style: italic;">'."</span>
  (<span style="font-weight: bold;">let</span> ((case-fold-search t)
        lang)
    (<span style="font-weight: bold;">while</span> (re-search-forward org-babel-src-block-regexp limit t)
      (<span style="font-weight: bold;">let</span> ((lang (match-string 2))
            (beg (match-beginning 0))
            (end (match-end 0)))
        (<span style="font-weight: bold;">if</span> (assoc (org-no-properties lang) scimax-src-block-keymaps)
            (<span style="font-weight: bold;">progn</span>
              (add-text-properties
               beg end `(local-map ,(cdr (assoc
                                          (org-no-properties lang)
                                          scimax-src-block-keymaps))))
              (add-text-properties
               beg end `(cursor-sensor-functions
                         ((<span style="font-weight: bold;">lambda</span> (win prev-pos sym)
                            <span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">This simulates a mouse click and makes a menu change</span>
                            (org-mouse-down-mouse nil)))))))))))
</pre>
</div>

<p>
Here we create an advice to trick any functions that need to know the major
mode. We only apply the spoof if we are in org-mode and in a src block though.
Otherwise we call the original function. So far lispy–eval is the only
function I have needed it for. This might be a general strategy though to do
other things like narrow to the src-block, or even go into special edit mode
temporarily if there are commands that require it.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="font-weight: bold;">defun</span> <span style="font-weight: bold;">scimax-spoof-mode</span> (orig-func <span style="font-weight: bold; text-decoration: underline;">&amp;rest</span> args)
  <span style="font-style: italic;">"Advice function to spoof commands in org-mode src blocks.</span>
<span style="font-style: italic;">It is for commands that depend on the major mode. One example is</span>
<span style="font-style: italic;">`</span><span style="font-weight: bold; font-style: italic; text-decoration: underline;">lispy--eval</span><span style="font-style: italic;">'."</span>
  (<span style="font-weight: bold;">if</span> (org-in-src-block-p)
      (<span style="font-weight: bold;">let</span> ((major-mode (intern (format <span style="font-style: italic;">"%s-mode"</span> (first (org-babel-get-src-block-info))))))
        (apply orig-func args))
    (apply orig-func args)))
</pre>
</div>

<p>
We define a minor mode so we can toggle this on and off. Here we add the
function to the org-font-lock-hook and advise the lispy–eval function. I had
to add the font-lock-function to the end of the org-font-lock hook for some
reason, and also add local-map as an extra-managed property so it would be
removed when we toggle it off.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="font-weight: bold;">define-minor-mode</span> <span style="font-weight: bold;">scimax-src-keymap-mode</span>
  <span style="font-style: italic;">"Minor mode to add mode keymaps to src-blocks."</span>
  <span style="font-weight: bold;">:init-value</span> nil
  (<span style="font-weight: bold;">if</span> scimax-src-keymap-mode
      (<span style="font-weight: bold;">progn</span>
        (add-hook 'org-font-lock-hook #'scimax-add-keymap-to-src-blocks t)
        (add-to-list 'font-lock-extra-managed-props 'local-map)
        (add-to-list 'font-lock-extra-managed-props 'cursor-sensor-functions)
        (advice-add 'lispy--eval <span style="font-weight: bold;">:around</span> 'scimax-spoof-mode)
        (cursor-sensor-mode +1))
    (remove-hook 'org-font-lock-hook #'scimax-add-keymap-to-src-blocks)
    (advice-remove 'lispy--eval 'scimax-spoof-mode)
    (cursor-sensor-mode -1))
  (font-lock-fontify-buffer))

(add-hook 'org-mode-hook (<span style="font-weight: bold;">lambda</span> ()
                           (scimax-src-keymap-mode +1)))
</pre>
</div>

<p>
That is it! I am pretty sure this is a good idea. It helps a lot when you are
writing a lot of short code blocks and near equal amounts of text (like in
this blog post). It also helps write the code since many things like
indentation, parentheses, etc. are automatically handled. That is what I used
to go into special-edit mode all the time for!
</p>

<p>
I have not used this long enough to know if it causes any other surprises. If
you try it and find any, leave a comment!
</p>

<div id="outline-container-org0444cd8" class="outline-2">
<h2 id="org0444cd8">Update</h2>
<div class="outline-text-2" id="text-org0444cd8">
<p>
It turns out you can have the best of all the worlds by combining keymaps. The
make-composed-keymap creates a new keymap that combines a keymaps and falls
through to a parent keymap. So here we use that to combine several keymaps,
falling through to org-mode. The only subtlety I have come across is that I
remapped &lt;return&gt; in orgmode to scimax/org-return, and not all modes define
it, so I redefine it in some places to just be newline. Also to keep C-c C-c
for executing the block, I add that back too.
</p>

<p>
I use a few maps here, and some of them seem to just add menus that are only
active when your cursor is in the block. Pretty handy!
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="font-weight: bold;">setq</span> scimax-src-block-keymaps
      `((<span style="font-style: italic;">"ipython"</span> . ,(<span style="font-weight: bold;">let</span> ((map (make-composed-keymap
                                  `(,elpy-mode-map ,python-mode-map ,pyvenv-mode-map)
                                  org-mode-map)))
                        <span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">In org-mode I define RET so we f</span>
                        (define-key map (kbd <span style="font-style: italic;">"&lt;return&gt;"</span>) 'newline)
                        (define-key map (kbd <span style="font-style: italic;">"C-c C-c"</span>) 'org-ctrl-c-ctrl-c)
                        map))
        (<span style="font-style: italic;">"python"</span> . ,(<span style="font-weight: bold;">let</span> ((map (make-composed-keymap
                                 `(,elpy-mode-map ,python-mode-map ,pyvenv-mode-map)
                                 org-mode-map)))
                       <span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">In org-mode I define RET so we f</span>
                       (define-key map (kbd <span style="font-style: italic;">"&lt;return&gt;"</span>) 'newline)
                       (define-key map (kbd <span style="font-style: italic;">"C-c C-c"</span>) 'org-ctrl-c-ctrl-c)
                       map))
        (<span style="font-style: italic;">"emacs-lisp"</span> . ,(<span style="font-weight: bold;">let</span> ((map (make-composed-keymap `(,lispy-mode-map
                                                            ,emacs-lisp-mode-map
                                                            ,outline-minor-mode-map)
                                                          org-mode-map)))
                           (define-key map (kbd <span style="font-style: italic;">"C-c C-c"</span>) 'org-ctrl-c-ctrl-c)
                           map))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org3be9204" class="outline-2">
<h2 id="org3be9204">Update #2</h2>
<div class="outline-text-2" id="text-org3be9204">
<p>
The previous version had some issues where it would only add a keymap to the
first block. The code in this post now addresses that and uses
cursor-sensor-functions to make sure we change key map on entering and leaving
blocks. That might mean you need an emacs of at least version 25 to use this.
I guess it will work with an earlier version, but the cursor-sensor-functions
might get ignored. You might have to comment out the cursor-sensor-mode line
</p>

<p>
Thanks to those brave people alpha-testing this and helping refine the idea!
</p>
</div>
</div>

</div>
</div>
<div>
        <div class="post-meta">
            <span title="post date" class="post-info">2017-06-14</span>
            <span title="last modification date" class="post-info">2017-06-14</span>
            <span title="tags" class="post-info">:<a href="/tags/raw">raw</a>:</span>
            <span title="author" class="post-info"><a href="mailto:travis &lt;at&gt; travis-job-c7de1c50-88ed-412e-ae70-62694dd7dea5">lujun9972</a></span>
        </div>
    <script src="/media/js/jquery-2.1.3.min.js"></script>
        <section>
            <h1>Comments</h1>
            <div id="comment-wrap">
                    <a class="disqus_label">使用 Disqus 评论</a>
    </ul>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
         //var disqus_developer = 1;
         var preempt_signal=false;
         var disqus_identifier = "/blog/2017/06/14/adding-keymaps-to-src-blocks-via-org-font-lock-hook/";
         var disqus_url = "https://lujun9972.github.io/emacs-document/blog/2017/06/14/adding-keymaps-to-src-blocks-via-org-font-lock-hook/";
         var disqus_shortname = 'emacs-document';
         /* * * DON'T EDIT BELOW THIS LINE * * */
         (function() {
             var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
             dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
             (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
             $('#disqus_thread').css('display','none');
         })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    <script>
     /* comments */
     var ego_disqus_thread=$('#disqus_thread');
     var ego_ds_label=$('.ds-thread');
     $('.disqus_label').click(function(){
         ego_disqus_thread.show();
         ego_ds_label.hide();
     });
     $('.ds-label').click(function(){
         ego_disqus_thread.hide();
         ego_ds_label.show();
     });
    </script>
        </section>
    <script src="/media/js/main.js"></script>
        <script type="text/javascript">
         var _gaq = _gaq || [];
         _gaq.push(['_setAccount', '7bac4fd0247f69c27887e0d4e3aee41e']);
         _gaq.push(['_trackPageview']);
         (function() {
             var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
             ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
             var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
         })();
        </script>
    <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 27.x(<a href="http://orgmode.org">Org mode</a> 9.x)</p>
        <p>
            Copyright &copy; 2014 - <span id="footerYear"></span> <a href="mailto:travis &lt;at&gt; travis-job-c7de1c50-88ed-412e-ae70-62694dd7dea5">lujun9972</a>
            &nbsp;&nbsp;-&nbsp;&nbsp;
            Powered by <a href="https://github.com/emacs-china/ego" target="_blank">EGO</a><br/>
            <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license"><img src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png" style="border-width:0" alt="Creative Commons License" class="center"></a>
            <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
    </div>
            </div>
            <script type="text/javascript"
                    src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_SVG">
            </script>
            <script type="text/x-mathjax-config">
             MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "AMS"} } });
            </script>
</div>

  </div>
  <!-- https://instant.page/
       Make your site’s pages instant in 1 minute and improve your conversion rate by 1%  -->
  <script src="//instant.page/1.1.0" type="module" integrity="sha384-EwBObn5QAxP8f09iemwAJljc+sU+eUXeL9vSBw1eNmVarwhKk2F9vBEpaN9rsrtp"></script>
  </body>
</html>
