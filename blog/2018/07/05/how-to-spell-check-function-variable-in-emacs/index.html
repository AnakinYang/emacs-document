<!DOCTYPE html>
<html lang="en">
<head>
  <title>How to spell check function/variable in Emacs - EMACS-DOCUMENT</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <meta name="author" content="lujun9972" />
  <meta name="keywords" content="raw" />
  <style>
   #ds-thread #ds-reset .ds-comment-body p {color: #ffffff;}
   #ds-thread #ds-reset .ds-comment-body p a {color: #ff0;}
   #ds-thread #ds-reset .ds-comment-body p a:hover {color: #0ff;}
   #disqus_thread a {color: #00ffff;}
  </style>
  <link rel="stylesheet" href="/media/css/main.css" type="text/css"/>
  <link rel="stylesheet" href="/media/css/comment.css" type="text/css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
</head>

  <body><div class="container">
<div>
  <header class="masthead">
    <h1 class="masthead-title"><a href="/">EMACS-DOCUMENT</a></h1>
    <p>=============&gt;集思广益</p>
    <nav class="site-nav">
      <div class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z" fill="#ffff00"/>
          <path d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z" fill="#ffff00"/>
          <path d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z" fill="#ffff00"/>
        </svg>
      </div>
      <ul class="trigger">
        <li><a href="/years/">Years</a></li>
        <li><a href="/authors/">Authors</a></li>
        <li><a href="/tags/">Tags</a></li>
        <li><a href="/about/">About</a></li>
        <li><a href="https://github.com/lujun9972/emacs-document">Github</a></li>
        <li><a href="/rss.xml">RSS</a></li>
      </ul>
    </nav>
    <form method="get" id="searchform" action="http://www.google.com/search">
      <input type="text" class="field" name="q" id="s" placeholder="Search">
      <input type="hidden" name="as_sitesearch" value="lujun9972.github.io/emacs-document">
    </form>
  </header>
</div>

<div>
<div class="post">
<h1 class="title">How to spell check function/variable in Emacs</h1>
<p>
<a href="http://blog.binchen.org/posts/effective-spell-check-in-emacs.html">This article</a> explains how developers can check typos of function/variable while programming in Emacs.
</p>

<p>
It uses the <code>--run-together</code> option of <a href="http://aspell.net/">GNU Aspell</a> to check camel cased word.
</p>

<p>
But this solution is not perfect. It wrongly identifies two character interior word as typo. For example, "onChange" is regards as typo because the interior word "on". Another issue is namespace of function name. For example, "MS" from "MSToggleButton" is alias of "Microsoft". If "MS" is identified as typo, every word containing namespace "MS" is regarded as typo.
</p>

<p>
In this article,
</p>

<ul class="org-ul">
<li>I will explain <b>how Emacs spell checker works</b></li>
<li>Then we study the <b>algorithm of aspell</b></li>
<li>Finally, I will show you <b>a complete setup</b></li>
</ul>

<p>
In Emacs, a built in plugin <a href="https://www.emacswiki.org/emacs/FlySpell">Fly Spell</a> is in charge of spell check. It passes the options and plain text to command line tool aspell. Aspell sends back the typos of text into <code>Fly Spell</code>. <code>Fly Spell</code> then select certain typos to display. For example, when <a href="https://www.gnu.org/software/emacs/manual/html_node/emacs/Spelling.html">flyspell-prog-mode</a> is on, only typos in comments and strings are visible.
</p>

<p>
So aspell doesn't understand syntax of any programming language. It scans plain text and report all typos to Fly Spell.
</p>

<p>
In aspell, there are two extra "run-together" word options:
</p>

<ul class="org-ul">
<li><code>--run-together-limit</code> is "Maximum number of words can be strung together"</li>
<li><code>--run-together-min</code> is "Minimal length of interior words"</li>
</ul>

<p>
Let's study the code of aspell to understand these two options. The "run-together" algorithm in implemented in function <code>Working::check_word</code> of file "modules/speller/default/suggest.cpp".
</p>

<p>
In order to help you understand this function, I documented the code line by line,
</p>

<pre class="example">
class Working : public Score {
 unsigned check_word(char 0_sync_master.sh 1_add_new_article_manual.sh 1_add_new_article_newspaper.sh 2_start_translating.sh 3_continue_the_work.sh 4_finish.sh 5_pause.sh base.sh parse_url_by_manual.sh parse_url_by_newspaper.py parse_url_by_newspaper.sh project.cfg reformat.sh texput.log urls_checker.sh word, char 0_sync_master.sh 1_add_new_article_manual.sh 1_add_new_article_newspaper.sh 2_start_translating.sh 3_continue_the_work.sh 4_finish.sh 5_pause.sh base.sh parse_url_by_manual.sh parse_url_by_newspaper.py parse_url_by_newspaper.sh project.cfg reformat.sh texput.log urls_checker.sh word_end, CheckInfo 0_sync_master.sh 1_add_new_article_manual.sh 1_add_new_article_newspaper.sh 2_start_translating.sh 3_continue_the_work.sh 4_finish.sh 5_pause.sh base.sh parse_url_by_manual.sh parse_url_by_newspaper.py parse_url_by_newspaper.sh project.cfg reformat.sh texput.log urls_checker.sh ci, unsigned pos = 1);
};
unsigned Working::check_word(char 0_sync_master.sh 1_add_new_article_manual.sh 1_add_new_article_newspaper.sh 2_start_translating.sh 3_continue_the_work.sh 4_finish.sh 5_pause.sh base.sh parse_url_by_manual.sh parse_url_by_newspaper.py parse_url_by_newspaper.sh project.cfg reformat.sh texput.log urls_checker.sh word, char 0_sync_master.sh 1_add_new_article_manual.sh 1_add_new_article_newspaper.sh 2_start_translating.sh 3_continue_the_work.sh 4_finish.sh 5_pause.sh base.sh parse_url_by_manual.sh parse_url_by_newspaper.py parse_url_by_newspaper.sh project.cfg reformat.sh texput.log urls_checker.sh word_end, CheckInfo 0_sync_master.sh 1_add_new_article_manual.sh 1_add_new_article_newspaper.sh 2_start_translating.sh 3_continue_the_work.sh 4_finish.sh 5_pause.sh base.sh parse_url_by_manual.sh parse_url_by_newspaper.py parse_url_by_newspaper.sh project.cfg reformat.sh texput.log urls_checker.sh ci,
 /bin /boot /dev /etc /home /lib /lib64 /lost+found /media /mnt /opt /proc /root /run /sbin /srv /sys /tmp /usr /var it WILL modify word */
 unsigned pos)
{
 // check the whole word before go into run-together mode
 unsigned res = check_word_s(word, ci);
 // if `res` is true, it's a valid word, don't bother run-together
 if (res) return pos + 1;
 // it's typo because number of interior words is greater than "--run-together-limit"
 if (pos + 1 &gt;= sp-&gt;run_together_limit_) return 0;

 // `i` is the `end` of interior word, the poition AFTER last character of interior word
 for (char 0_sync_master.sh 1_add_new_article_manual.sh 1_add_new_article_newspaper.sh 2_start_translating.sh 3_continue_the_work.sh 4_finish.sh 5_pause.sh base.sh parse_url_by_manual.sh parse_url_by_newspaper.py parse_url_by_newspaper.sh project.cfg reformat.sh texput.log urls_checker.sh i = word + sp-&gt;run_together_min_; 
 // already checked the whole word; besides, any interior word whose size is less 
 // than "--run-together-min" is regarded as invalid
 i &lt;= word_end - sp-&gt;run_together_min_;
 ++i)
 {
 char t = *i;

 // read the interior word by set the character at `end` position to '\0'
 *i = '\0';
 res = check_word_s(word, ci);
 // restore original character at `end` position
 *i = t;

 // Current interior word is invalid, we need append the character at current
 // `end` position to creata new interior word.
 // Inncrement `i` because `i` always points to the `end` of interior word
 if (!res) continue;

 // Current interior word is valid, strip it from the whole word to create a totally
 // new word for `check_word`, `check_word` is a recursive function
 res = check_word(i, word_end, ci + 1, pos + 1);
 if (res) return res;
 }
 memset(ci, 0, sizeof(CheckInfo));
 return 0;
}
</pre>

<p>
Let's use "hisHelle" as demo how <code>check_word</code> runs:
</p>

<ul class="org-ul">
<li>"word" points to string "hisHelle" (in C/C++, string is character array. The last character of array is character '\0')</li>
<li>"sp-&gt;run\_together\_min\_" is 3, so "i" initially points to the character "H", at the end of interior word "his"</li>
<li>"check\_word\_s" return "true" for interior word "his"</li>
<li>So we strip "his" from "hisHelle" and recursively call "check\_word" to check new word "Helle"</li>
<li>In the new context of "check\_word", we extract "Hel" from "Helle" initially</li>
<li>"Hel" is invalid. So we extract "Hell" from "Helle" and get new word "e" and recursively apply "check\_word" on "e"</li>
<li>"e" is not valid and at the end of recursion. So "hisHelle" is a typo</li>
</ul>

<p>
Here is our conclusion after studying the code:
</p>

<ul class="org-ul">
<li><code>--run-together-limit</code> could not be bigger if your computer got enough memory. It's default value is 8. I prefer 16.</li>
<li><code>--run-together-min</code> can't be 2 because too many typos are combination of "correct" two character interior words ("hehe", "isme", ...)</li>
<li><code>--run-together-min</code> can't be greater than 3, or else, too many "correct" three character interior words are regarded as invalid ("his", "her", "one", "two")</li>
<li><code>--run-together-min</code> should always be 3 which is its default value. Actually, it should never be tweak-able by user at the beginning</li>
</ul>

<p>
Since <code>--run-together-min</code> is 3. the word "onChange" is always regarded as typo because of two character interior word "on". Since there is nothing we can do at aspell side, we have to turn to Emacs to fix this problem.
</p>

<p>
When Emacs got potential typo on Emacs side, we can strip out all the two character interior word from original word and spell check new word again.
</p>

<p>
We can attach a predicate into specific major-mode. The predicate return <code>t</code> if current word at cursor is typo,
</p>

<pre class="example">
(defun js-flyspell-verify ()
 (let* ((font-face (get-text-property (- (point) 1) 'face))
 (word (thing-at-point 'word)))
 (message "font-face=%s word=%s" font-face word)
 t))
(put 'js2-mode 'flyspell-mode-predicate 'js-flyspell-verify)
</pre>

<p>
As you can see from above code, we have full control on what typos should be displayed in <code>js-flyspell-verify</code>. So namespace is also easy problem. If namespace is three characters, it will be automatically processed by aspell. All we need to do is add namespace into our personal dictionary <code>$HOME/.aspell.en.pws</code>. If namespace is one or two characters, we strip down it from original word. Same way as we deal with two character interior word.
</p>

<p>
Here is complete setup you can paste into <code>.emacs</code> (I setup for <code>js2-mode</code> and <code>rjsx-mode</code> but code is generic enough),
</p>

<pre class="example">
(defun flyspell-detect-ispell-args (&amp;optional run-together)
 "If RUN-TOGETHER is true, spell check the CamelCase words.
Please note RUN-TOGETHER will make aspell less capable. So it should only be used in prog-mode-hook."
 ;; force the English dictionary, support Camel Case spelling check (tested with aspell 0.6)
 (let* ((args (list "--sug-mode=ultra" "--lang=en_US"))args)
 (if run-together
 (setq args (append args '("--run-together" "--run-together-limit=16"))))
 args))

(setq ispell-program-name "aspell")
(setq-default ispell-extra-args (flyspell-detect-ispell-args t))

(defvar extra-flyspell-predicate '(lambda (word) t)
 "A callback to check WORD. Return t if WORD is typo.")

(defun my-flyspell-predicate (word)
 "Use aspell to check WORD. If it's typo return true."
 (if (string-match-p (concat "^&amp; " word)
 (shell-command-to-string (format "echo %s | %s %s pipe"
 word
 ispell-program-name
 (mapconcat 'identity
 (flyspell-detect-ispell-args t)
 " "))))
 t))

(defmacro my-flyspell-predicate-factory (preffix)
 `(lambda (word)
 (let* ((pattern (concat "^\\(" ,preffix "\\)\\([A-Z]\\)"))
 rlt)
 (cond
 ((string-match-p pattern word)
 (setq word (replace-regexp-in-string pattern "\\2" word))
 (setq rlt (my-flyspell-predicate word)))
 (t
 (setq rlt t)))
 rlt)))

(defun js-flyspell-verify ()
 (let* ((case-fold-search nil)
 (font-matched (memq (get-text-property (- (point) 1) 'face)
 '(js2-function-call
 js2-function-param
 js2-object-property
 font-lock-variable-name-face
 font-lock-string-face
 font-lock-function-name-face
 font-lock-builtin-face
 rjsx-tag
 rjsx-attr)))
 word
 (rlt t))
 (cond
 ((not font-matched)
 (setq rlt nil))
 ((not (string-match-p "aspell$" ispell-program-name))
 ;; Only override aspell's result
 (setq rlt t))
 ((string-match-p "^[a-zA-Z][a-zA-Z]$"
 (setq word (thing-at-point 'word)))
 (setq rlt nil))
 ((string-match-p "\\([A-Z][a-z]\\|^[a-z][a-z]\\)[A-Z]\\|[a-z][A-Z][a-z]$"
 word)
 ;; strip two character interior words
 (setq word (replace-regexp-in-string "\\([A-Z][a-z]\\|^[a-z][a-z]\\)\\([A-Z]\\)" "\\2" word))
 (setq word (replace-regexp-in-string "\\([a-z]\\)[A-Z][a-z]$" "\\1" word))
 ;; check stripped word
 (setq rlt (my-flyspell-predicate word)))
 (t
 (setq rlt (funcall extra-flyspell-predicate word))))
 rlt))
(put 'js2-mode 'flyspell-mode-predicate 'js-flyspell-verify)
(put 'rjsx-mode 'flyspell-mode-predicate 'js-flyspell-verify)

(defun prog-mode-hook-setup ()
 ;; remove namespace "MS" and "X"
 (setq-local extra-flyspell-predicate (my-flyspell-predicate-factory "MS\\|X")))
(add-hook 'prog-mode-hook 'prog-mode-hook-setup)
</pre>

<p>
Optionally, you could see <a href="https://github.com/redguardtoo/emacs.d/blob/master/lisp/init-spelling.el">https://github.com/redguardtoo/emacs.d/blob/master/lisp/init-spelling.el</a> for my real world setup.
</p>

</div>
</div>
<div>
        <div class="post-meta">
            <span title="post date" class="post-info">2018-07-05</span>
            <span title="last modification date" class="post-info">2018-07-05</span>
            <span title="tags" class="post-info">:<a href="/tags/raw">raw</a>:</span>
            <span title="author" class="post-info"><a href="mailto:lujun9972 &lt;at&gt; T430S">lujun9972</a></span>
        </div>
    <script src="/media/js/jquery-2.1.3.min.js"></script>
        <section>
            <h1>Comments</h1>
            <div id="comment-wrap">
                    <a class="disqus_label">使用 Disqus 评论</a>
    </ul>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
         //var disqus_developer = 1;
         var preempt_signal=false;
         var disqus_identifier = "/blog/2018/07/05/how-to-spell-check-function-variable-in-emacs/";
         var disqus_url = "https://lujun9972.github.io/emacs-document/blog/2018/07/05/how-to-spell-check-function-variable-in-emacs/";
         var disqus_shortname = 'emacs-document';
         /* * * DON'T EDIT BELOW THIS LINE * * */
         (function() {
             var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
             dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
             (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
             $('#disqus_thread').css('display','none');
         })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    <script>
     /* comments */
     var ego_disqus_thread=$('#disqus_thread');
     var ego_ds_label=$('.ds-thread');
     $('.disqus_label').click(function(){
         ego_disqus_thread.show();
         ego_ds_label.hide();
     });
     $('.ds-label').click(function(){
         ego_disqus_thread.hide();
         ego_ds_label.show();
     });
    </script>
        </section>
    <script src="/media/js/main.js"></script>
    <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 26.x(<a href="http://orgmode.org">Org mode</a> 9.x)</p>
        <p>
            Copyright &copy; 2014 - <span id="footerYear"></span> <a href="mailto:lujun9972 &lt;at&gt; T430S">lujun9972</a>
            &nbsp;&nbsp;-&nbsp;&nbsp;
            Powered by <a href="https://github.com/emacs-china/ego" target="_blank">EGO</a><br/>
            <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license"><img src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png" style="border-width:0" alt="Creative Commons License" class="center"></a>
            <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
    </div>
            </div>
            <script type="text/javascript"
                    src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_SVG">
            </script>
            <script type="text/x-mathjax-config">
             MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "AMS"} } });
            </script>
</div>

  </div>
  <!-- https://instant.page/
       Make your site’s pages instant in 1 minute and improve your conversion rate by 1%  -->
  <script src="//instant.page/1.1.0" type="module" integrity="sha384-EwBObn5QAxP8f09iemwAJljc+sU+eUXeL9vSBw1eNmVarwhKk2F9vBEpaN9rsrtp"></script>
  </body>
</html>
