<!DOCTYPE html>
<html lang="en">
<head>
  <title>Determining if the server is started, or the wonders of server-running-p - EMACS-DOCUMENT</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <meta name="author" content="lujun9972" />
  <meta name="keywords" content="raw" />
  <!-- <link rel="stylesheet" href="https://lujun9972.github.io/emacs-document/media/css/main.css" type="text/css"/>
       <link rel="stylesheet" href="https://lujun9972.github.io/emacs-document/media/css/comment.css" type="text/css"/> -->
  <link rel='stylesheet' href='https://cdn.jsdelivr.net/gh/kognise/water.css@latest/dist/dark.css'>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
</head>

  <body><div class="container">
<div>
  <header class="masthead">
    <h1 class="masthead-title"><a href="https://lujun9972.github.io/emacs-document/">EMACS-DOCUMENT</a></h1>
    <p>=============&gt;集思广益</p>
    <nav class="site-nav">
      <ul class="trigger">
        <li><a href="https://lujun9972.github.io/emacs-document/years/">Years</a></li>
        <li><a href="https://lujun9972.github.io/emacs-document/authors/">Authors</a></li>
        <li><a href="https://lujun9972.github.io/emacs-document/tags/">Tags</a></li>
        <li><a href="https://lujun9972.github.io/emacs-document/about/">About</a></li>
        <li><a href="https://github.com/lujun9972/emacs-document">Github</a></li>
        <li><a href="https://lujun9972.github.io/emacs-document/rss.xml">RSS</a></li>
      </ul>
    </nav>
    <form method="get" id="searchform" action="https://www.bing.com/search">
      <input type="text" class="field" name="q" id="s" placeholder="Search">
      <input type="hidden" name="as_sitesearch" value="lujun9972.github.io/emacs-document">
    </form>
  </header>
</div>

<div>
<div class="post">
<h1 class="title">Determining if the server is started, or the wonders of server-running-p</h1>
<p>
Trivia: How can you determine if the current Emacs instance has the
Emacs server running?
</p>

<p>
A quick search gives us three potential candidates: <code>server-mode</code>,
<code>(daemonp)</code> and <code>(server-running-p)</code>. That's way too much, but
surely one of them is the right one, isn't it? Well, no. Because the
real answer to this trivial question is: you can't.
</p>

<ul class="org-ul">
<li><code>server-mode</code> is <code>t</code> if, and only if, the server was started using the function with the same name. But there are other ways to run the server, like <code>M-x server-start</code> or <code>emacs --daemon</code>.</li>
<li><code>(daemonp)</code> returns t if, and only if, Emacs was started in daemon mode.</li>
</ul>

<p>
What about <code>(server-running-p)</code>, then? Well, it may look friendly,
but here be monsters.
</p>

<p>
It starts by looking promising: after <code>M-x server-start</code>,
<code>(server-running-p)</code> now returns <code>t</code>! Do we have a winner? Not yet!
Let's pop a new Emacs instance and eval <code>(server-running-p)</code> without
starting the server. <code>t</code> again!
</p>

<p>
What's happening? The truth is that <code>(server-running-p)</code> is not
what it seems to be. Here's its complete source code:
</p>

<pre class="example">
(defun server-running-p (&amp;optional name)
 "Test whether server NAME is running.

Return values:
 nil the server is definitely not running.
 t the server seems to be running.
 something else we cannot determine whether it's running without using
 commands which may have to wait for a long time."
 (unless name (setq name server-name))
 (condition-case nil
 (if server-use-tcp
 (with-temp-buffer
 (insert-file-contents-literally (expand-file-name name server-auth-dir))
 (or (and (looking-at "127\\.0\\.0\\.1:[0-9]+ \\([0-9]+\\)")
 (assq 'comm
 (process-attributes
 (string-to-number (match-string 1))))
 t)
 :other))
 (delete-process
 (make-network-process
 :name "server-client-test" :family 'local :server nil :noquery t
 :service (expand-file-name name server-socket-dir)))
 t)
 (file-error nil)))
</pre>

<p>
The horror starts as soon as the docstring. The <code>-p</code> suffix in the
name promises a predicate, that is, a boolean function. But in
<code>server-running-p</code>, non-<code>nil</code> is not a loud and clear “Yes!”, it's a
mumbled “well, maybe, who knows?”. Ternary logic, because Emacs is
above the law of excluded middle.
</p>

<p>
But what does this function do? It tries to determine if a server
called <code>NAME</code> is running, by assuming that this server would be
configured exactly the same as the running instance. It may end up
looking at the socket file of the current server, or it may try to
initiate a TCP connection, which is extremely expensive.
<code>server-running-p</code> is the kind of function you may be tempted to
call while building the mode line: try it, and get an instant and
unrecoverable Emacs freeze. What it's supposed to be useful for is
extremely unclear. It's unable to determine if the running instance
has a server --- but it uses this server's config to search for a
potentially completely different server.
</p>

</div>
</div>
<div>
        <div class="post-meta">
            <span title="post date" class="post-info">2018-07-05</span>
            <span title="last modification date" class="post-info">2018-07-05</span>
            <span title="tags" class="post-info">:<a href="https://lujun9972.github.io/emacs-document/tags/raw">raw</a>:</span>
            <span title="author" class="post-info"><a href="mailto:lujun9972 &lt;at&gt; T430S">lujun9972</a></span>
        </div>
    <script src="https://lujun9972.github.io/emacs-document/media/js/jquery-2.1.3.min.js"></script>
    <script src="https://lujun9972.github.io/emacs-document/media/js/md5.min.js"></script>
        <section>
            <div id="gitalk-container"></div>
            <script type="text/javascript">
             var gitalk = new Gitalk({
                 clientID: 'fdcb5d9da3f4acb4862c',
                 clientSecret: 'dd0a16312a206782cb7669dcec5e96874ab48170',
                 repo: 'lujun9972.github.com',
                 owner: 'lujun9972',
                 admin: ['lujun9972'],
                 id: md5(location.pathname),      // Ensure uniqueness and length less than 50
                 distractionFreeMode: false  // Facebook-like distraction free mode
             })
             gitalk.render('gitalk-container')
            </script>
        </section>
    <script src="https://lujun9972.github.io/emacs-document/media/js/main.js"></script>
    <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 26.x(<a href="http://orgmode.org">Org mode</a> 9.x)</p>
        <p>
            Copyright &copy; 2014 - <span id="footerYear"></span> <a href="mailto:lujun9972 &lt;at&gt; T430S">lujun9972</a>
            &nbsp;&nbsp;-&nbsp;&nbsp;
            Powered by <a href="https://github.com/emacs-china/ego" target="_blank">EGO</a><br/>
            <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license"><img src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png" style="border-width:0" alt="Creative Commons License" class="center"></a>
            <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
    </div>
            </div>
            <script type="text/javascript"
                    src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_SVG">
            </script>
            <script type="text/x-mathjax-config">
             MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "AMS"} } });
            </script>
</div>

  </div>
  <!-- https://instant.page/
       Make your site’s pages instant in 1 minute and improve your conversion rate by 1%  -->
  <script src="https://lujun9972.github.io/emacs-document//instant.page/1.1.0" type="module" integrity="sha384-EwBObn5QAxP8f09iemwAJljc+sU+eUXeL9vSBw1eNmVarwhKk2F9vBEpaN9rsrtp"></script>
  </body>
</html>
