<!DOCTYPE html>
<html lang="en">
<head>
  <title>Literate Programming with Org-mode - EMACS-DOCUMENT</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <meta name="author" content="lujun9972" />
  <meta name="keywords" content="raw" />
  <style>
   #ds-thread #ds-reset .ds-comment-body p {color: #ffffff;}
   #ds-thread #ds-reset .ds-comment-body p a {color: #ff0;}
   #ds-thread #ds-reset .ds-comment-body p a:hover {color: #0ff;}
   #disqus_thread a {color: #00ffff;}
  </style>
  <link rel="stylesheet" href="/media/css/main.css" type="text/css"/>
  <link rel="stylesheet" href="/media/css/comment.css" type="text/css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
</head>

  <body><div class="container">
<div>
  <header class="masthead">
    <h1 class="masthead-title"><a href="/">EMACS-DOCUMENT</a></h1>
    <p>=============&gt;随便,谢谢</p>
    <nav class="site-nav">
      <div class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z" fill="#ffff00"/>
          <path d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z" fill="#ffff00"/>
          <path d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z" fill="#ffff00"/>
        </svg>
      </div>
      <ul class="trigger">
        <li><a href="/years/">Years</a></li>
        <li><a href="/authors/">Authors</a></li>
        <li><a href="/tags/">Tags</a></li>
        <li><a href="/about/">About</a></li>
        <li><a href="https://github.com/lujun9972/emacs-document.git">Github</a></li>
        <li><a href="/rss.xml">RSS</a></li>
      </ul>
    </nav>
    <form method="get" id="searchform" action="http://www.google.com/search">
      <input type="text" class="field" name="q" id="s" placeholder="Search">
      <input type="hidden" name="as_sitesearch" value="lujun9972.github.io/emacs-document">
    </form>
  </header>
</div>

<div>
<div class="post">
<h1 class="title">Literate Programming with Org-mode</h1>
<div id="table-of-contents">
<h2>&#30446;&#24405;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org-babel-basics-remote-code-execution">Org-Babel Basics &amp; Remote code execution</a></li>
<li><a href="#example-setting-up-a-python-virtual-environment">Example: Setting up a Python virtual environment</a></li>
<li><a href="#additional-resources">Additional Resources</a></li>
</ul>
</div>
</div>
<p>
I've <a href="file:///2016/9/my-workflow-org-agenda/">described at length</a> how I use Emacs and Org as a project management tool. As part of my process, I frequently use Org as a lab notebook, in which I keep track of various bits of data and record both the code I run and various parameters I used in the process. My workflow requires (1) running code, (2) logging the results, and (3) including my own thoughts and analysis in between, a programming paradigm known more generally as <a href="https://en.wikipedia.org/wiki/Literate_programming">literate programming</a>A number of folks <a href="https://www.reddit.com/r/emacs/comments/8tmsfj/literate_programming_with_orgmode/">on Reddit</a> and <a href="http://irreal.org/blog/?p=7301">irreal.com</a> have pointed out that I don't dive deep enough to really call the content in this post literate programming. Perhaps a more appropriate title would include Literate Scripting; regardless, the content I present here is still an integral part of my Emacs-based workflow. .
</p>

<p>
A number of folks <a href="https://www.reddit.com/r/emacs/comments/8tmsfj/literate_programming_with_orgmode/">on Reddit</a> and <a href="http://irreal.org/blog/?p=7301">irreal.com</a> have pointed out that I don't dive deep enough to really call the content in this post literate programming. Perhaps a more appropriate title would include Literate Scripting; regardless, the content I present here is still an integral part of my Emacs-based workflow.
</p>

<p>
Org makes it easy to asynchronously execute code for multiple programming languages (and even allows for remote code execution over ssh). For instance, on a recent project of mine I had a few shell scripts that I would occasionally run that would loop through some data files I was generating on a remote machine and return some statistics about them; Org makes it possible for me to do this without having to leave my notes. In this article, I'll go over a few use-cases that illustrate the utility of using Emacs with Org for coding projects and walk you through some of the functionality I couldn't live without.
</p>

<div id="outline-container-orge2d0349" class="outline-2">
<h2 id="org-babel-basics-remote-code-execution"><a id="orge2d0349"></a>Org-Babel Basics &amp; Remote code execution</h2>
<div class="outline-text-2" id="text-org-babel-basics-remote-code-execution">
<p>
Org makes it easy to include source code blocks alongside text passages and then execute it with <a href="https://orgmode.org/worg/org-contrib/babel/"><code>Org Babel</code></a>. Setting up Babel is pretty simple:
</p>

<p>
A simple configuration for using org-babel. <code>lisp</code>
</p>

<p>
A simple configuration for using org-babel.
</p>

<p>
<code>lisp</code>
</p>

<pre class="example">
;; Run/highlight code using babel in org-mode
(org-babel-do-load-languages
 'org-babel-load-languages
 '(
 (python . t)
 (ipython . t)
 (sh . t)
 (shell . t)
 ;; Include other languages here...
 ))
;; Syntax highlight in #+BEGIN_SRC blocks
(setq org-src-fontify-natively t)
;; Don't prompt before running code in org
(setq org-confirm-babel-evaluate nil)
;; Fix an incompatibility between the ob-async and ob-ipython packages
(setq ob-async-no-async-languages-alist '("ipython"))
</pre>

<p>
The anatomy of a source code block is reasonably simple: each begins with <code>#+BEGIN_SRC</code>, followed immediately by the name of the language, then the code you wish to include, and finally closes with <code>#+END_SRC</code>. Here's a simple example in Python:
</p>

<pre class="example">
#+BEGIN_SRC python :results output
 import random
 random.seed(1)
 print("Hello World! Here's a random number: %f" % random.random())
#+END_SRC

#+RESULTS:
: Hello World! Here's a random number: 0.134364
</pre>

<p>
Running <code>C-c C-c</code> while the cursor is inside the source block will execute the Python code block in place and produce the result you see above.Setting <code>:results output</code> captures the printed output of executing the code block; an exhaustive list of arguments for src blocks can be found <a href="https://org-babel.readthedocs.io/en/latest/header-args/">in this Org Babel reference card</a>. If you pasted this src block into an Org file, you should notice that it is automatically syntax highlighted as well. Executing <code>C-c '</code> inside the block will open a separate buffer in which you can edit the block.
</p>

<p>
Setting <code>:results output</code> captures the printed output of executing the code block; an exhaustive list of arguments for src blocks can be found <a href="https://org-babel.readthedocs.io/en/latest/header-args/">in this Org Babel reference card</a>.
</p>

<p>
Setting the arguments of a src block is a powerful tool. For instance, changing the <code>:dir</code> argument changes the base directory in which the code is run. This is useful for running simple bash scripts:
</p>

<pre class="example">
#+BEGIN_SRC bash :dir ~/Desktop
 pwd
#+END_SRC

#+RESULTS:
: /Users/Greg/Desktop
</pre>

<p>
Where this functionality really shines is in the ability to execute code on remote servers. The <code>:dir</code> argument can be set to paths using <code>scp</code> syntax, and Emacs will take care of the <code>ssh</code> into the remote machine, running the code, recording the output, and inserting it into the buffer.
</p>

<pre class="example">
#+BEGIN_SRC bash :dir /user@127.0.0.1:
 pwd
 echo $USER
 hostname -I
#+END_SRC

#+RESULTS:
: /home/user
: user
: 127.0.0.1
</pre>

<p>
Of course, you should replace <code>user@127.0.0.1</code> with a username and IP address of your choosing. Note: I would highly recommend that you use the remote code execution functionality only for machine in which you have an ssh key installed. Emacs will prompt you with a password whenever the keys are not installed, but I've had it hang on occasion, which can be frustrating when I'm in the middle of a task.
</p>

<p>
Code execution in Emacs is synchronous by default, meaning that you will be locked out of editing while the code is being run. Fortunately, the fantastic <a href="https://github.com/astahlman/ob-async"><code>ob-async</code> package</a> allows for asynchronous code execution with the <code>:async</code> arg, meaning that you can still use Emacs while the code snippet is run in the backgroundThere are some small things you give up by using the <code>ob-async</code> package. In particular, the <code>:session</code> functionality is <a href="https://github.com/astahlman/ob-async/issues/1">absent in general</a>, which otherwise allows variables and function definitions to persist across blocks of code. . Once the package is installed, simply include <code>:async t</code> to the source code block and run it again:
</p>

<p>
There are some small things you give up by using the <code>ob-async</code> package. In particular, the <code>:session</code> functionality is <a href="https://github.com/astahlman/ob-async/issues/1">absent in general</a>, which otherwise allows variables and function definitions to persist across blocks of code.
</p>

<pre class="example">
#+BEGIN_SRC bash :dir /user@127.0.0.1: :async t
 pwd
 echo $USER
 hostname -I
#+END_SRC

#+RESULTS:
: 0ddf0124c8fcb26d53fdba83dc4773f6
</pre>

<p>
While the code block is running, the <code>RESULTS</code> drawer is populated with a random hash. When the block is finished executing, the hash will be replaced with the actual result.
</p>
</div>
</div>

<div id="outline-container-orgaa01843" class="outline-2">
<h2 id="example-setting-up-a-python-virtual-environment"><a id="orgaa01843"></a>Example: Setting up a Python virtual environment</h2>
<div class="outline-text-2" id="text-example-setting-up-a-python-virtual-environment">
<p>
Most examples that use Org Babel seem to focus on a particular language, yet many of the projects I set up actually involve the interplay between multiple languages. Here, we'll set up a Python virtual environment (in <code>bash</code>), set up an iPython workbook, and then use the resulting environment to generate a plot, which we can view inline. Package management in Python can be a pain, which is why using a <a href="https://virtualenv.pypa.io/en/stable/">virtual environment</a> is important for making reusable development environments. If you want to follow along, be sure to install <a href="https://github.com/astahlman/ob-async"><code>ob-async</code></a>, <a href="https://github.com/jorgenschaefer/pyvenv"><code>pyvenv</code></a>, and <a href="https://github.com/gregsexton/ob-ipython"><code>ob-ipython</code></a> within Emacs. As one might expect, I wrote this entire section using my literate programming setup. Since my blog's syntax highlighting didn't play nice with the Org syntax, I've broken the code blocks into manageable chunks.
</p>

<p>
Rather than set the properties of each <code>BEGIN_SRC</code> block individually, I often find it useful to set certain properties at the level of each Org header, which I do in the <code>:PROPERTIES:</code> drawer:
</p>

<pre class="example">
0_sync_master.sh 1_add_new_article_manual.sh 1_add_new_article_newspaper.sh 2_start_translating.sh 3_continue_the_work.sh 4_finish.sh 5_pause.sh base.sh parse_url_by_manual.sh parse_url_by_newspaper.py parse_url_by_newspaper.sh project.cfg reformat.sh texput.log urls_checker.sh Creating a Python virtual environment
:PROPERTIES:
:header-args: :eval never-export
:header-args:bash: :exports code
:header-args:elisp: :exports code
:header-args:ipython: :exports both
:END:
</pre>

<p>
Notice that, in addition to setting <code>:header-args:</code> I have also set a number of language-specific arguments as well. For instance, I have set <code>:header-args:elisp: :exports code</code>, which means that for any Emacs lisp code blocks, whenever I want to export this Org file to a different format (like a PDF) for sharing, only the code will be included in the export and the <code>RESULTS</code> drawer will be ignored.
</p>

<p>
My first step is to set up the Python virtual environment. For convenience, I will put it on my Desktop, which I can do by setting <code>:dir ~/Desktop</code> in the src block properties, and name it <code>py2_venv</code>:
</p>

<pre class="example">
#+BEGIN_SRC bash :dir ~/Desktop :results drawer
 pwd
 virtualenv py2_venv
#+END_SRC

#+RESULTS:
:RESULTS:
/Users/Greg/Desktop
New python executable in /Users/Greg/Desktop/py2_venv/bin/python
Installing setuptools, pip, wheel...done.
:END:
</pre>

<p>
The results suggest that everything finished as expected and that the virtual environment is now on my Desktop. With that complete, we need to activate the virtual environment within EmacsFor whatever reason, I found that installing packages in the virtual environment was only practical after activating the virtual environment inside Emacs, since this seems to modify the python path. . This is done with the <code>pyvenv-activate</code> command provided by the <a href="https://github.com/jorgenschaefer/pyvenv"><code>pyvenv</code> package</a> as follows:
</p>

<p>
For whatever reason, I found that installing packages in the virtual environment was only practical after activating the virtual environment inside Emacs, since this seems to modify the python path.
</p>

<pre class="example">
#+BEGIN_SRC elisp :results silent
 (pyvenv-activate "~/Desktop/py2_venv")
#+END_SRC
</pre>

<p>
With the virtual environment activated, installing a few packages via pip is pretty simpleThe additional <code>ipython</code> and <code>jupyter</code> packages are for using iPython (instead of Python) with Babel. There are a couple niceties provided by the <a href="https://github.com/gregsexton/ob-ipython"><code>ob-ipython</code> package</a> that you don't get from the base Python install, so I'd recommend looking at the documentation if you're interested in Python development. .
</p>

<p>
The additional <code>ipython</code> and <code>jupyter</code> packages are for using iPython (instead of Python) with Babel. There are a couple niceties provided by the <a href="https://github.com/gregsexton/ob-ipython"><code>ob-ipython</code> package</a> that you don't get from the base Python install, so I'd recommend looking at the documentation if you're interested in Python development.
</p>

<pre class="example">
#+BEGIN_SRC bash :results drawer :async t
 pip install ipython jupyter_client jupyter_console numpy matplotlib
#+END_SRC
</pre>

<p>
Since installing packages via <code>pip</code> can sometimes take a while, waiting for the code to finish can be a massive inconvenience, and I've included <code>:async t</code> in the arg list so that the installations will run in the background. Once this is done and the virtual environment is set up, running Python code within iPython is as straightforward as one might expect:
</p>

<pre class="example">
#+BEGIN_SRC ipython :results drawer :async t :session py2session
 %matplotlib inline
 import numpy as np
 import matplotlib.pyplot as plt
#+END_SRC
</pre>

<p>
Notice that, in addition to running the code asynchronously, I have also provided <code>:session py2session</code> to the iPython src block. Sessions are extremely useful, since they allow you to set variables, define functions, import packages, etc. within one src block and have them persist to other src blocks with the same session name. Now, having imported the requisite packages, we can generate a plot:
</p>

<pre class="example">
#+BEGIN_SRC ipython :results drawer :async t :session py2session
 fig=plt.figure(facecolor='white')
 plt.hist(np.random.randn(500000), bins=100);
#+END_SRC
</pre>

<p>
Having set <code>%matplotlib inline</code> in the previous block, the resulting plot is saved to a temporary directory and appears inline. Expectedly, the histogram shows a Gaussian distribution:
</p>


<div class="figure">
<p><img src="http://cachestocaches.com/media/photologue/photos/cache/72597RmJ_display.png" alt="72597RmJ_display.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-orga78f517" class="outline-2">
<h2 id="additional-resources"><a id="orga78f517"></a>Additional Resources</h2>
<div class="outline-text-2" id="text-additional-resources">
<p>
There are plenty of other resources on using Emacs and Org Babel for literate programming. In addition to the <a href="https://orgmode.org/worg/org-contrib/babel/intro.html#literate-programming">guide to Org Babel</a> there's also the fantastic <a href="http://howardism.org/Technical/Emacs/literate-devops.html">Literate DevOps guide</a> and accompanying <a href="https://www.youtube.com/watch?v=dljNabciEGg">video summary</a> by Howard Abrams. If you enjoyed this post and are left wanting more, I'd recommend checking out Howard's guides: both are fantastic. Also useful is the <a href="https://orgmode.org/manual/Working-with-source-code.html#Working-with-source-code">Org-mode guide to working with source code</a>.
</p>

<p>
Feel free to let me know how this short guide may be improved in the comments below or <a href="https://www.reddit.com/r/emacs/comments/8tmsfj/literate_programming_with_orgmode/">on Reddit</a>.
</p>
</div>
</div>

</div>
</div>
<div>
        <div class="post-meta">
            <span title="post date" class="post-info">2018-07-06</span>
            <span title="last modification date" class="post-info">2018-07-06</span>
            <span title="tags" class="post-info">:<a href="/tags/raw">raw</a>:</span>
            <span title="author" class="post-info"><a href="mailto:travis &lt;at&gt; travis-job-c7de1c50-88ed-412e-ae70-62694dd7dea5">lujun9972</a></span>
        </div>
    <script src="/media/js/jquery-2.1.3.min.js"></script>
        <section>
            <h1>Comments</h1>
            <div id="comment-wrap">
                    <a class="disqus_label">使用 Disqus 评论</a>
    </ul>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
         //var disqus_developer = 1;
         var preempt_signal=false;
         var disqus_identifier = "/blog/2018/07/06/literate-programming-with-org-mode/";
         var disqus_url = "https://lujun9972.github.io/emacs-document/blog/2018/07/06/literate-programming-with-org-mode/";
         var disqus_shortname = 'emacs-document';
         /* * * DON'T EDIT BELOW THIS LINE * * */
         (function() {
             var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
             dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
             (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
             $('#disqus_thread').css('display','none');
         })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    <script>
     /* comments */
     var ego_disqus_thread=$('#disqus_thread');
     var ego_ds_label=$('.ds-thread');
     $('.disqus_label').click(function(){
         ego_disqus_thread.show();
         ego_ds_label.hide();
     });
     $('.ds-label').click(function(){
         ego_disqus_thread.hide();
         ego_ds_label.show();
     });
    </script>
        </section>
    <script src="/media/js/main.js"></script>
        <script type="text/javascript">
         var _gaq = _gaq || [];
         _gaq.push(['_setAccount', '7bac4fd0247f69c27887e0d4e3aee41e']);
         _gaq.push(['_trackPageview']);
         (function() {
             var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
             ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
             var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
         })();
        </script>
    <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 27.x(<a href="http://orgmode.org">Org mode</a> 9.x)</p>
        <p>
            Copyright &copy; 2014 - <span id="footerYear"></span> <a href="mailto:travis &lt;at&gt; travis-job-c7de1c50-88ed-412e-ae70-62694dd7dea5">lujun9972</a>
            &nbsp;&nbsp;-&nbsp;&nbsp;
            Powered by <a href="https://github.com/emacs-china/ego" target="_blank">EGO</a><br/>
            <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license"><img src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png" style="border-width:0" alt="Creative Commons License" class="center"></a>
            <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
    </div>
            </div>
            <script type="text/javascript"
                    src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_SVG">
            </script>
            <script type="text/x-mathjax-config">
             MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "AMS"} } });
            </script>
</div>

  </div>
  <!-- https://instant.page/
       Make your site’s pages instant in 1 minute and improve your conversion rate by 1%  -->
  <script src="//instant.page/1.1.0" type="module" integrity="sha384-EwBObn5QAxP8f09iemwAJljc+sU+eUXeL9vSBw1eNmVarwhKk2F9vBEpaN9rsrtp"></script>
  </body>
</html>
