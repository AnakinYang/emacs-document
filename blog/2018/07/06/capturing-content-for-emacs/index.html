<!DOCTYPE html>
<html lang="en">
<head>
  <title>Capturing Content for Emacs - EMACS-DOCUMENT</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <meta name="author" content="lujun9972" />
  <meta name="keywords" content="raw" />
  <style>
   #ds-thread #ds-reset .ds-comment-body p {color: #ffffff;}
   #ds-thread #ds-reset .ds-comment-body p a {color: #ff0;}
   #ds-thread #ds-reset .ds-comment-body p a:hover {color: #0ff;}
   #disqus_thread a {color: #00ffff;}
  </style>
  <link rel="stylesheet" href="/media/css/main.css" type="text/css"/>
  <link rel="stylesheet" href="/media/css/comment.css" type="text/css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
</head>

  <body><div class="container">
<div>
  <header class="masthead">
    <h1 class="masthead-title"><a href="/">EMACS-DOCUMENT</a></h1>
    <p>=============&gt;集思广益</p>
    <nav class="site-nav">
      <div class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z" fill="#ffff00"/>
          <path d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z" fill="#ffff00"/>
          <path d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z" fill="#ffff00"/>
        </svg>
      </div>
      <ul class="trigger">
        <li><a href="/years/">Years</a></li>
        <li><a href="/authors/">Authors</a></li>
        <li><a href="/tags/">Tags</a></li>
        <li><a href="/about/">About</a></li>
        <li><a href="https://github.com/lujun9972/emacs-document">Github</a></li>
        <li><a href="/rss.xml">RSS</a></li>
      </ul>
    </nav>
    <form method="get" id="searchform" action="http://www.google.com/search">
      <input type="text" class="field" name="q" id="s" placeholder="Search">
      <input type="hidden" name="as_sitesearch" value="lujun9972.github.io/emacs-document">
    </form>
  </header>
</div>

<div>
<div class="post">
<h1 class="title">Capturing Content for Emacs</h1>
<div id="table-of-contents">
<h2>&#30446;&#24405;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org83a14c0">The “Current” Task</a></li>
<li><a href="#org4090a78">Code References</a></li>
<li><a href="#orgfe6508d">Output from Terminal Commands</a></li>
<li><a href="#org053f8eb">Content from Browsers</a></li>
<li><a href="#org755594b">Summary</a></li>
</ul>
</div>
</div>
<p>
Let's suppose you are current investigating a new code base, system or other
problem, and you are following <a href="literate-devops.html">my advice</a> and copying code, storing output, and
taking notes along the way. All of this gets stored into your engineering
notebook, aka <i>primary org mode</i> file (for me, this is often my current Sprint page).
</p>

<p>
Sure, selecting code, switching buffers or windows, pasting the code (maybe even
jotting down some notes), and then popping back to your original file, may not
be many keystrokes, but it exacts a bit of mental tax that mounts.
</p>

<p>
The typical solution to this problem is to use the <a href="https://orgmode.org/manual/Capture.html">org-capture feature</a> (If you
are not familiar with this Org feature, check out my <a href="capturing-intro.html">gentle introduction</a> or see
<a href="http://sachachua.com/blog/2015/02/learn-take-notes-efficiently-org-mode/#unnumbered-3">Step 3</a> of Sacha Chua's essay, <i>Learn how to take notes more efficiently in Org
Mode</i>). While <code>org-capture</code> makes copying content into your org file easy, I am
trying to improve on it, and here some of my experiments.
</p>

<div id="outline-container-org2622f7d" class="outline-2">
<h2 id="org83a14c0">The “Current” Task</h2>
<div class="outline-text-2" id="text-org83a14c0">
<p>
One mentally taxing aspect of <code>org-capture</code> is determining where something
should go. Do you have a dozen <code>(file)</code> reference destinations? I have found the
<code>(clock)</code> reference ideal for altering a <i>default destination</i>. Specifically, I
begin work on <i>a task</i>, and designate it the <i>focus of my attention</i> (i.e. the
<i>destination</i> of my work), by <i>clocking in</i>, using <code>org-clock-in</code> (<code>C-c C-x C-i</code> or <code>,  I</code> in Spacemacs).
</p>

<p>
Now, we can add the following to the org-capture list:
</p>

<pre class="example">
(add-to-list 'org-capture-templates
 `("c" "Item to Current Clocked Task" item
 (clock)
 "%i%?" :empty-lines 1))
</pre>

<p>
This capture destination allows me to easily specify <i>any header</i> as a special
destination with a simple clock in. However, we do have the mental
interruption associated with creating a new buffer. Let's minimize that by
allowing us to put something on the kill ring, and send it to that clocked-in
task:
</p>

<pre class="example">
(add-to-list 'org-capture-templates
 `("K" "Kill-ring to Current Clocked Task" plain
 (clock)
 "%c" :immediate-finish t :empty-lines 1))
</pre>

<p>
The <i>trick</i> here is the use of <code>:immediate-finish</code>, where it doesn't even bother
with a buffer, but just injects the <code>kill-ring</code> contents to the clocked in task
without even a sneeze. Don't want the hassle of sending something to the
<code>kill-ring</code>? With this one, you only have to select the text, then kick off
the capture:
</p>

<pre class="example">
(add-to-list 'org-capture-templates
 `("C" "Contents to Current Clocked Task" plain
 (clock)
 "%i" :immediate-finish t :empty-lines 1))
</pre>

<p>
In fact, create the following function and keybinding, and you can select
text, and immediately copy it to your clocked in task without bothering with
the org-capture menu:
</p>

<pre class="example">
(defun region-to-clocked-task (start end)
 "Copies the selected text to the currently clocked in org-mode task."
 (interactive "r")
 (org-capture-string (buffer-substring-no-properties start end) "C"))

(global-set-key (kbd "C-&lt;F17&gt;") 'region-to-clocked-task)
</pre>

<p>
This is great for <i>general textual content</i>, but much of what I want to copy is
code, which could bring along a bit of <i>meta data</i>.
</p>
</div>
</div>

<div id="outline-container-org0f31863" class="outline-2">
<h2 id="org4090a78">Code References</h2>
<div class="outline-text-2" id="text-org4090a78">
<p>
Much of my ideas got started after reading <a href="http://ul.io/nb/2018/04/30/better-code-snippets-with-org-capture/">this blog entry</a> where the idea is
to have a function gather meta data associated with the currently selected
text, and help to leave a back trace to the original code file.
</p>

<p>
I wanted to copy both <i>code</i> and regular text, so I made
<code>ha/org-capture-clip-snippet</code> for wrapping the region in an <code>EXAMPLE</code>:
</p>

<pre class="example">
(defun ha/org-capture-clip-snippet (f)
 "Given a file, F, this captures the currently selected text
within an Org EXAMPLE block and a backlink to the file."
 (with-current-buffer (find-buffer-visiting f)
 (ha/org-capture-fileref-snippet f "EXAMPLE" "" nil)))
</pre>

<p>
And <code>ha/org-capture-code-snippet</code> for getting function name and the code type:
</p>

<pre class="example">
(defun ha/org-capture-code-snippet (f)
 "Given a file, F, this captures the currently selected text
within an Org SRC block with a language based on the current mode
and a backlink to the function and the file."
 (with-current-buffer (find-buffer-visiting f)
 (let ((org-src-mode (replace-regexp-in-string "-mode" "" (format "%s" major-mode)))
 (func-name (which-function)))
 (ha/org-capture-fileref-snippet f "SRC" org-src-mode func-name))))
</pre>

<p>
Both of these function do not do much, but given some values to Nick's
original function (which I've modified the <code>format</code> to fit my personal style):
</p>

<pre class="example">
(defun ha/org-capture-fileref-snippet (f type headers func-name)
 (let* ((code-snippet
 (buffer-substring-no-properties (mark) (- (point) 1)))
 (file-name (buffer-file-name))
 (file-base (file-name-nondirectory file-name))
 (line-number (line-number-at-pos (region-beginning)))
 (initial-txt (if (null func-name)
 (format "From [[file:%s::%s][%s]]:"
 file-name line-number file-base)
 (format "From ~%s~ (in [[file:%s::%s][%s]]):"
 func-name file-name line-number
 file-base))))
 (format "
 %s

 #+BEGIN_%s %s
%s
 #+END_%s" initial-txt type headers code-snippet type)))
</pre>

<p>
However, content I want to store in an org-mode comes from more than just
Emacs buffers.
</p>
</div>
</div>

<div id="outline-container-org1bdd25d" class="outline-2">
<h2 id="orgfe6508d">Output from Terminal Commands</h2>
<div class="outline-text-2" id="text-orgfe6508d">
<p>
What if the end result of a command sequence on the Terminal was a pipe to a
program that could use <code>cat</code> to gather textual data from standard input, and
then use <code>emacsclient</code> call <code>org-capture</code> to store it?
</p>

<p>
Yeah, and interesting idea when sent to the current clocked in task:
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #2aa1ae; background-color: #292e34;">#</span><span style="color: #2aa1ae; background-color: #292e34;">!/bin/</span><span style="color: #4f97d7; font-weight: bold;">bash</span>

<span style="color: #7590db;">TITLE</span>=<span style="color: #2d9574;">"$*"</span>
<span style="color: #7590db;">CONTENT</span>=<span style="color: #2d9574;">"</span>
<span style="color: #2d9574;"> #+BEGIN_EXAMPLE</span>
<span style="color: #2d9574;">$(</span><span style="color: #fa8072;">cat</span><span style="color: #2d9574;"> | sed 's/^/ /g')</span>
<span style="color: #2d9574;"> #+END_EXAMPLE</span>
<span style="color: #2d9574;">"</span>

<span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">[</span><span style="color: #bc6ec5;">[</span> -n $<span style="color: #7590db;">TITLE</span> <span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">]</span>
<span style="color: #4f97d7; font-weight: bold;">then</span>
 <span style="color: #7590db;">CONTENT</span>=<span style="color: #2d9574;">" - ${TITLE}\n${CONTENT}"</span>
<span style="color: #4f97d7; font-weight: bold;">fi</span>

/usr/local/bin/emacsclient -c -n <span style="color: #2d9574;">\</span>
 -e <span style="color: #2d9574;">"(progn (org-capture-string \"$CONTENT\" \"C\") (delete-frame))"</span>
</pre>
</div>

<p>
Here I'm using our latest <code>C</code> capture template to that just takes textual
context and stores is. Let's try it in action by typing the following in a
shell:
</p>

<div class="org-src-container">
<pre class="src src-shell">date | ec
</pre>
</div>

<p>
Works like a charm:
</p>

<div class="org-src-container">
<pre class="src src-org"><span style="color: #827591; background-color: #373040;">#+BEGIN_EXAMPLE</span>
Thu Jun 7 22:45:23 PDT 2018
<span style="color: #827591; background-color: #373040;">#+END_EXAMPLE</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4e538b7" class="outline-2">
<h2 id="org053f8eb">Content from Browsers</h2>
<div class="outline-text-2" id="text-org053f8eb">
<p>
Like many software people, I have a love-hate relationship with browsers.
I often find myself copying/pasting information from a web site into my
engineering notebook. Pasting text data into an org-mode file looses all text
formatting as well as hyperlink references. But operating system clipboards
can store some of this formatting data, so we just need to tap into it.
</p>

<p>
I'm currently using a Mac, so the following is very Mac-centric, but perhaps
the ideas can lend you to build a Linux or Windows version (if so, let me know).
</p>

<p>
I'm going to use Alfred to start this Workflow, as it will allow me to
trigger these scripts in succession as shown in this diagram:
</p>


<div class="figure">
<p><img src="capturing-content-01.png" alt="capturing-content-01.png" />
</p>
</div>

<p>
The trigger (in this case, every meta-key on a laptop), will start the first
script that basically issues the <code>Command-C</code> to copy the selected text to the
clipboard:
</p>

<pre class="example">
tell application "System Events" to keystroke "c" using command down
</pre>

<p>
Yes, this works with any application, including browsers.
</p>

<p>
The next script basically takes the contents of the clipboard (as HTML),
render that to an org-compatible format with <a href="https://pandoc.org/">pandoc</a> (which you'll need to
install), and then use <code>emacsclient</code> to call my org-capture routine with the
“C” selection, so that the contents go directly to my clocked in task:
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #7590db;">query</span>=$<span style="color: #4f97d7;">(</span><span style="color: #fa8072;">osascript</span> -e <span style="color: #2d9574;">'the clipboard as "HTML"'</span> | <span style="color: #2d9574;">\</span>
 perl -ne <span style="color: #2d9574;">'print chr foreach unpack("C*",pack("H*",substr($_,11,-3)))'</span> | <span style="color: #2d9574;">\</span>
 /usr/local/bin/pandoc -f html -t org | <span style="color: #2d9574;">\</span>
 sed <span style="color: #2d9574;">'s/"//g'</span> | sed <span style="color: #2d9574;">'s/^/ /'</span> <span style="color: #4f97d7;">)</span>

/usr/local/bin/emacsclient -c -n <span style="color: #2d9574;">\</span>
 -e <span style="color: #2d9574;">"(progn (org-capture-string \"${query}\" \"C\") (delete-frame))"</span>
</pre>
</div>

<p>
The script is a modified version from <a href="https://gist.github.com/rolandcrosby/c26571bf4e263f695d2f">Roland Crosby</a>. How well does it work?
I just selected some of the homepage at <a href="https://orgmode.org/">orgmode.org</a>, and clocked this header
as my <i>current task</i>, and ended up with this getting pasted:
</p>

<div class="org-src-container">
<pre class="src src-org">The stable version of Org is <span style="font-weight: bold;">*9.1.13*</span>, as of May 2018. See the
<span style="color: #2aa1ae; text-decoration: underline;"><a href="https://orgmode.org/Changes.html">release notes</a></span>.

Get it with <span style="color: #4f97d7;">=M-x package-install RET org RET=</span> (see
<span style="color: #2aa1ae; text-decoration: underline;"><a href="https://orgmode.org/elpa.html">Org ELPA</a></span>).

Or download it as a <span style="color: #2aa1ae; text-decoration: underline;"><a href="https://orgmode.org/org-9.1.13.tar.gz">tar.gz</a></span> or
<span style="color: #2aa1ae; text-decoration: underline;"><a href="https://orgmode.org/org-9.1.13.zip">zip</a></span> archives.
</pre>
</div>

<p>
In other words, it renders quite well...which is especially good, since this
pasting business happens completely in the background while I am still surfin'
the web.
</p>
</div>
</div>

<div id="outline-container-orgd58a357" class="outline-2">
<h2 id="org755594b">Summary</h2>
<div class="outline-text-2" id="text-org755594b">
<p>
My workflow proposal amounts to gathering data from a web browser, shell
commands, and source code, and be able to fling it into my engineering
notebook without switching out of that application.
</p>

<p>
Later, I will return to my notebook in Emacs and clean up and summarize my
capturing. Once clean, the issues or knowledge I wish to share can then be
easily exported from org.
</p>

<p>
The side-benefit, is that I automatically remind myself to clock in to my task.
</p>
</div>
</div>

</div>
</div>
<div>
        <div class="post-meta">
            <span title="post date" class="post-info">2018-07-06</span>
            <span title="last modification date" class="post-info">2019-04-26</span>
            <span title="tags" class="post-info">:<a href="/tags/raw">raw</a>:</span>
            <span title="author" class="post-info"><a href="mailto:lujun9972 &lt;at&gt; T430S">lujun9972</a></span>
        </div>
    <script src="/media/js/jquery-2.1.3.min.js"></script>
        <section>
            <h1>Comments</h1>
            <div id="comment-wrap">
                    <a class="disqus_label">使用 Disqus 评论</a>
    </ul>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
         //var disqus_developer = 1;
         var preempt_signal=false;
         var disqus_identifier = "/blog/2018/07/06/capturing-content-for-emacs/";
         var disqus_url = "https://lujun9972.github.io/emacs-document/blog/2018/07/06/capturing-content-for-emacs/";
         var disqus_shortname = 'emacs-document';
         /* * * DON'T EDIT BELOW THIS LINE * * */
         (function() {
             var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
             dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
             (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
             $('#disqus_thread').css('display','none');
         })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    <script>
     /* comments */
     var ego_disqus_thread=$('#disqus_thread');
     var ego_ds_label=$('.ds-thread');
     $('.disqus_label').click(function(){
         ego_disqus_thread.show();
         ego_ds_label.hide();
     });
     $('.ds-label').click(function(){
         ego_disqus_thread.hide();
         ego_ds_label.show();
     });
    </script>
        </section>
    <script src="/media/js/main.js"></script>
    <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 26.x(<a href="http://orgmode.org">Org mode</a> 9.x)</p>
        <p>
            Copyright &copy; 2014 - <span id="footerYear"></span> <a href="mailto:lujun9972 &lt;at&gt; T430S">lujun9972</a>
            &nbsp;&nbsp;-&nbsp;&nbsp;
            Powered by <a href="https://github.com/emacs-china/ego" target="_blank">EGO</a><br/>
            <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license"><img src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png" style="border-width:0" alt="Creative Commons License" class="center"></a>
            <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
    </div>
            </div>
            <script type="text/javascript"
                    src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_SVG">
            </script>
            <script type="text/x-mathjax-config">
             MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "AMS"} } });
            </script>
</div>

  </div>
  <!-- https://instant.page/
       Make your site’s pages instant in 1 minute and improve your conversion rate by 1%  -->
  <script src="//instant.page/1.1.0" type="module" integrity="sha384-EwBObn5QAxP8f09iemwAJljc+sU+eUXeL9vSBw1eNmVarwhKk2F9vBEpaN9rsrtp"></script>
  </body>
</html>
