<!DOCTYPE html>
<html lang="en">
<head>
  <title>A Brief Introduction to Literate Analytics With org-babel - EMACS-DOCUMENT</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <meta name="author" content="lujun9972" />
  <meta name="keywords" content="raw" />
  <style>
   #ds-thread #ds-reset .ds-comment-body p {color: #ffffff;}
   #ds-thread #ds-reset .ds-comment-body p a {color: #ff0;}
   #ds-thread #ds-reset .ds-comment-body p a:hover {color: #0ff;}
   #disqus_thread a {color: #00ffff;}
  </style>
  <link rel="stylesheet" href="/media/css/main.css" type="text/css"/>
  <link rel="stylesheet" href="/media/css/comment.css" type="text/css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
</head>

  <body><div class="container">
<div>
  <header class="masthead">
    <h1 class="masthead-title"><a href="/">EMACS-DOCUMENT</a></h1>
    <p>=============&gt;集思广益</p>
    <nav class="site-nav">
      <div class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z" fill="#ffff00"/>
          <path d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z" fill="#ffff00"/>
          <path d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z" fill="#ffff00"/>
        </svg>
      </div>
      <ul class="trigger">
        <li><a href="/years/">Years</a></li>
        <li><a href="/authors/">Authors</a></li>
        <li><a href="/tags/">Tags</a></li>
        <li><a href="/about/">About</a></li>
        <li><a href="https://github.com/lujun9972/emacs-document">Github</a></li>
        <li><a href="/rss.xml">RSS</a></li>
      </ul>
    </nav>
    <form method="get" id="searchform" action="http://www.google.com/search">
      <input type="text" class="field" name="q" id="s" placeholder="Search">
      <input type="hidden" name="as_sitesearch" value="lujun9972.github.io/emacs-document">
    </form>
  </header>
</div>

<div>
<div class="post">
<h1 class="title">A Brief Introduction to Literate Analytics With org-babel</h1>
<div id="table-of-contents">
<h2>&#30446;&#24405;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#getting-started">Getting Started</a></li>
<li><a href="#using-remote-resources-via-tramp">Using Remote Resources via TRAMP</a></li>
<li><a href="#further-reading">Further Reading</a></li>
</ul>
</div>
</div>
<p>
As an engineer on an analytics and data infrastructure team, I spend
quite a bit of time exploring and performing ad-hoc analyses of data
scattered across SQL databases; Hive and Spark clusters; and blob
storage. These investigations can be a chore -- a single instance might
involve a half dozen ETL steps, ad-hoc querying to assess whether data
needs to be cleaned, and moving code between a REPL and a program
destined for production.
</p>

<p>
Once an initial conclusion has been reached, I need to go back and
document my process for posterity, remembering exactly what worked along
the way. This is a recipe for mistakes and omissions, so why not
document as you go?
</p>

<p>
What I need to do is:
</p>

<ol class="org-ol">
<li>Log each command</li>
<li>Document what it does and why it's necessary</li>
<li>Execute and examine the results as I go</li>
</ol>

<p>
<code>org-mode</code> and <code>org-babel</code> provide an amazing environment for this sort
of polyglot, multi-modal series of tasks. Prose and code can be freely
intermingled in a <a href="https://en.wikipedia.org/wiki/Literate_programming">literate
programming</a> style,
any references used during the process can be cited, and the final
product can be exported into human- or machine-readable formats. If
you're keen to see the final product of an analysis, <a href="https://gist.github.com/nickbarnwell/917c8d8bbde173ef5ad94e40ba5fa01f">here's an
example</a>
I recently created for <a href="http://www.teawithstrangers.com/">Tea With
Strangers</a>, reporting on growth in
recent months that demonstrates these capabilities.
</p>

<div id="outline-container-org4080079" class="outline-2">
<h2 id="getting-started">Getting Started</h2>
<div class="outline-text-2" id="text-getting-started">
<p>
As I typically begin my explorations with a SQL-like datastore, I'll
begin my examples there. <code>sql-mode</code> and <code>ob-sql</code> ship with <code>emacs</code>, so
all you have to do is allow for execution of SQL <code>src</code> blocks in the
<code>org-babel</code> environment; to do this, add the following to your
<code>init.el</code>:
</p>

<pre class="example">
1
2
3
4
5
6
7
</pre>

<pre class="example">
(add-to-list 'org-babel-load-languages '(sql . t))
;;If you also want to disable confirmation for SQL blocks:
(setq org-confirm-babel-evaluate
 (lambda (lang body)
 (not (string= lang "sql"))))
;;or disable it for all blocks
(setq org-confirm-babel-evaluate nil)
</pre>

<blockquote>
<p>
n.b. If you'd like to learn more about how <code>babel=‘s evaluation
  works, its =info</code> page is very complete; call <code>(info "(org) Evaluating code blocks")</code> to view .
</p>
</blockquote>

<p>
Now that <code>org-babel</code> is configured, it's time create a new <code>org</code> buffer
and add some properties that will configure our SQL environment. <code>src</code>
blocks accept a variety of arguments that control the behaviour of their
output and export.
</p>

<ul class="org-ul">
<li><code>#+PROPERTY: header-args:sql :session literate-analytics :engine postgresql</code>

<ul class="org-ul">
<li>This line adds two default arguments to any <code>sql</code> <code>src</code> blocks:
<code>:session</code> and <code>:engine</code>. The former enables <a href="https://orgmode.org/worg/org-contrib/babel/intro.html#org98c324c">session-based
evaluation for our SQL
blocks</a>,
the latter tells <code>sql-mode</code> that <code>postgresql</code> is the backend
we're working against; this is equivalent to using
<code>sql-set-product</code> in a <code>sql-mode</code> buffer.</li>
</ul></li>

<li><code>#+PROPERTY: header-args:sql+ :exports results :database tws_dev</code>

<ul class="org-ul">
<li>The <code>+</code> after <code>sql</code> enables appending to existing arguments
instead of overriding them. <code>:exports results</code> includes the
output of <code>src</code> blocks will be included in the output of an
<code>org-export</code> backend by default. Finally, <code>:database</code> is the
connection string that will be passed to our SQL client.</li>
</ul></li>
</ul>

<p>
Now add a <code>src</code> block in <code>sql-mode</code> by typing <code>&lt;s TAB sql</code>. Contents of
this block will be syntax highlighted as if they were in their own
buffer, and you can edit its contents inline or in an indirect buffer
using the appropriate major mode by typing <code>C-c '</code> while your point is
over the block.
</p>

<p>
Your buffer should now look like
this:
</p>

<pre class="example">
1
2
3
4
5
6
</pre>

<pre class="example">
#+PROPERTY: header-args:sql :session literate-analytics :engine postgresql
#+PROPERTY: header-args:sql+ :exports results :database tws_dev

#+BEGIN_SRC sql
 SELECT COUNT(*) FROM users;
#+END_SRC
</pre>

<p>
Now, place your point inside the <code>src</code> block and call
<code>org-babel-execute-src-block</code> with <code>C-c C-c</code>. If everything's configured
correctly, a <code>RESULT</code> block should be inserted below:
</p>

<pre class="example">
1
2
3
4
</pre>

<pre class="example">
#+RESULTS:
| count |
|-------|
| 5 |
</pre>

<p>
Results are automatically coerced into an <code>org</code> table, which can be
quite helpful if you want to perform some tabulation or filtering with
<code>elisp</code>, or simply want to export the results later via <code>org-export</code>.
</p>
</div>
</div>

<div id="outline-container-orgfc94e75" class="outline-2">
<h2 id="using-remote-resources-via-tramp">Using Remote Resources via TRAMP</h2>
<div class="outline-text-2" id="text-using-remote-resources-via-tramp">
<p>
Since it's rare you'll be interacting exclusively with local resources,
it's quite useful to be able to run commands on other machines. For
example, we frequently <code>ssh</code> into our Hadoop cluster head nodes to
rename, move, or find files in HDFS. Fortunately, <code>babel</code> is tightly
integrated with <a href="https://www.gnu.org/software/tramp/">TRAMP</a>.
</p>

<p>
The <code>:dir</code> property on <code>src</code> blocks accepts a TRAMP reference; execution
of the block will then occur on the remote machine, e.g.:
</p>

<pre class="example">
1
2
3
4
5
6
7
8
9
10
</pre>

<pre class="example">
#+BEGIN_SRC sh :dir /ssh:spark: :results output list
hdfs dfs -ls $hdfsPath/ServiceInterface
#+END_SRC

#+RESULTS:
: - Found 5 items
: - drwxrwxrwx+ - ... 0 2018-04-25 17:06 $hdfsPath/ServiceInterface/Delinked
: - drwxrwxrwx+ - ... 0 2018-04-25 16:43 $hdfsPath/ServiceInterface/PartialValidated
: - drwxrwxrwx+ - ... 0 2018-04-23 19:58 $hdfsPath/ServiceInterface/PreValidated
: - drwxrwxrwx+ - ... 0 2018-04-25 21:24 $hdfsPath/ServiceInterface/Unvalidated
</pre>

<p>
If you're going to be executing multiple commands on the same remote
machine, you can use the <code>:session</code> header arg to keep the connection
open. See <a href="https://orgmode.org/manual/session.html">the info page for
:session</a> for details.
</p>
</div>
</div>

<div id="outline-container-orga85c67e" class="outline-2">
<h2 id="further-reading">Further Reading</h2>
<div class="outline-text-2" id="text-further-reading">
<p>
I've only covered a fraction of what <code>org-babel</code> is capable of, but
hopefully it'll give you some ideas. For further reading, I recommend
watching <a href="https://www.youtube.com/watch?v=dljNabciEGg">Howard Abram's Literate DevOps with emacs
talk</a> and perusing the
<code>info</code> manual for <code>babel</code>.
</p>
</div>
</div>

</div>
</div>
<div>
        <div class="post-meta">
            <span title="post date" class="post-info">2018-06-05</span>
            <span title="last modification date" class="post-info">2018-06-05</span>
            <span title="tags" class="post-info">:<a href="/tags/raw">raw</a>:</span>
            <span title="author" class="post-info"><a href="mailto:lujun9972 &lt;at&gt; T430S">lujun9972</a></span>
        </div>
    <script src="/media/js/jquery-2.1.3.min.js"></script>
        <section>
            <h1>Comments</h1>
            <div id="comment-wrap">
                    <a class="disqus_label">使用 Disqus 评论</a>
    </ul>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
         //var disqus_developer = 1;
         var preempt_signal=false;
         var disqus_identifier = "/blog/2018/06/05/a-brief-introduction-to-literate-analytics-with-org-babel/";
         var disqus_url = "https://lujun9972.github.io/emacs-document/blog/2018/06/05/a-brief-introduction-to-literate-analytics-with-org-babel/";
         var disqus_shortname = 'emacs-document';
         /* * * DON'T EDIT BELOW THIS LINE * * */
         (function() {
             var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
             dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
             (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
             $('#disqus_thread').css('display','none');
         })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    <script>
     /* comments */
     var ego_disqus_thread=$('#disqus_thread');
     var ego_ds_label=$('.ds-thread');
     $('.disqus_label').click(function(){
         ego_disqus_thread.show();
         ego_ds_label.hide();
     });
     $('.ds-label').click(function(){
         ego_disqus_thread.hide();
         ego_ds_label.show();
     });
    </script>
        </section>
    <script src="/media/js/main.js"></script>
    <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 26.x(<a href="http://orgmode.org">Org mode</a> 9.x)</p>
        <p>
            Copyright &copy; 2014 - <span id="footerYear"></span> <a href="mailto:lujun9972 &lt;at&gt; T430S">lujun9972</a>
            &nbsp;&nbsp;-&nbsp;&nbsp;
            Powered by <a href="https://github.com/emacs-china/ego" target="_blank">EGO</a><br/>
            <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license"><img src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png" style="border-width:0" alt="Creative Commons License" class="center"></a>
            <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
    </div>
            </div>
            <script type="text/javascript"
                    src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_SVG">
            </script>
            <script type="text/x-mathjax-config">
             MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "AMS"} } });
            </script>
</div>

  </div>
  <!-- https://instant.page/
       Make your site’s pages instant in 1 minute and improve your conversion rate by 1%  -->
  <script src="//instant.page/1.1.0" type="module" integrity="sha384-EwBObn5QAxP8f09iemwAJljc+sU+eUXeL9vSBw1eNmVarwhKk2F9vBEpaN9rsrtp"></script>
  </body>
</html>
