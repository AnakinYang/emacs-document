<!DOCTYPE html>
<html lang="en">
<head>
  <title>Making it easier to extend the export of org-mode links with generic functions - EMACS-DOCUMENT</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <meta name="author" content="lujun9972" />
  <meta name="keywords" content="raw" />
  <!-- <link rel="stylesheet" href="https://lujun9972.github.io/emacs-document/media/css/main.css" type="text/css"/>
       <link rel="stylesheet" href="https://lujun9972.github.io/emacs-document/media/css/comment.css" type="text/css"/> -->
  <link rel='stylesheet' href='https://cdn.jsdelivr.net/gh/kognise/water.css@latest/dist/dark.css'>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
</head>

  <body><div class="container">
<div>
  <header class="masthead">
    <h1 class="masthead-title"><a href="https://lujun9972.github.io/emacs-document/">EMACS-DOCUMENT</a></h1>
    <p>=============&gt;集思广益</p>
    <nav class="site-nav">
      <ul class="trigger">
        <li><a href="https://lujun9972.github.io/emacs-document/years/">Years</a></li>
        <li><a href="https://lujun9972.github.io/emacs-document/authors/">Authors</a></li>
        <li><a href="https://lujun9972.github.io/emacs-document/tags/">Tags</a></li>
        <li><a href="https://lujun9972.github.io/emacs-document/about/">About</a></li>
        <li><a href="https://github.com/lujun9972/emacs-document">Github</a></li>
        <li><a href="https://lujun9972.github.io/emacs-document/rss.xml">RSS</a></li>
      </ul>
    </nav>
    <form method="get" id="searchform" action="https://www.bing.com/search">
      <input type="text" class="field" name="q" id="s" placeholder="Search">
      <input type="hidden" name="as_sitesearch" value="lujun9972.github.io/emacs-document">
    </form>
  </header>
</div>

<div>
<div class="post">
<h1 class="title">Making it easier to extend the export of org-mode links with generic functions</h1>
<p>
I am a big fan of org-mode links. Lately, I have had a need to modify how some links are exported, e.g. defining new exports for different backends, or fine-tuning a particular backend. This can be difficult, depending on how the link was set up. Here is a typical setup I am used to using, where the different options for the backends are handled in a conditional statement in a single function. I will just use a link that just serves to illustrate the issues here. These links are just sytactic sugar for markup, they don't do anything else. We start with an example that just converts text to italic text for different backends like html or latex.
</p>

<pre class="example">
(defun italic-link-export (path desc backend)
 (cond
 ((eq 'html backend)
 (format "&lt;em&gt;%s&lt;/em&gt;" path))
 ((eq 'latex backend)
 (format "\\textit{%s}" path))
 ;; fall-through case for everything else
 (t
 path)))

(org-link-set-parameters "italic" :export 'italic-link-export)
</pre>

<p>
:export
italic-link-export
</p>

<pre class="example">
(org-export-string-as "italic:text" 'html t)
</pre>

<pre class="example">
&lt;p&gt;
&lt;em&gt;text&lt;/em&gt;&lt;/p&gt;
</pre>

<pre class="example">
(org-export-string-as "italic:text" 'latex t)
</pre>

<pre class="example">
\textit{text}
</pre>

<p>
This falls through though to the default case.
</p>

<pre class="example">
(require 'ox-md)
(org-export-string-as "italic:text" 'md t)
</pre>

<pre class="example">

# Table of Contents



text

</pre>

<p>
The point I want to make here is that this is not easy to extend as a user. You have to either modify the italic-link-export function, advise it, or monkey-patch it. None of these are especially nice.
</p>

<p>
I could define italic-link-export in a way that it retrieves the function to use from an alist or hash-table using the backend, but then you have to do two things to modify the behavior: define a backend specific function <i>and</i> register it in the lookup variable. It is also possible to just look up a function by a derived symbol, e.g. using fboundp, and then using funcall to execute it. This looks something like this:
</p>

<pre class="example">
;; a user definable function for exporting to latex
(defun italic-link-export-latex (path desc backend)
 (format "\\textit{%s}" path))

;; generic export function that looks up functions or defaults to
(defun italic-link-exporter (path desc backend)
 "Run `italic-link-export-BACKEND' if it exists, or return path."
 (let ((func (intern-soft (format "italic-link-export-%s" backend))))
 (if (fboundp func)
 (funcall func path desc backend)
 path)))
</pre>

<p>
This has some indirection, but allows you to just define new functions to add new export backends, or replace single backend exports. It isn't bad, but there is room for improvement.
</p>

<p>
In this <a href="https://github.com/jkitchin/org-ref/issues/492#issuecomment-387806180">comment</a> in org-ref, I saw a new opportunity to address this issue using generic functions in elisp! The idea is to define a generic function that handles the general export case, and then define additional functions for each specific backend based on the signature of the export function. I will switch to bold markup for this.
</p>

<pre class="example">
(cl-defgeneric bold-link-export (path desc backend)
 "Generic function to export a bold link."
 path)

;; this one runs when the backend is equal to html
(cl-defmethod bold-link-export ((path t) (desc t) (backend (eql html)))
 (format "&lt;b&gt;%s&lt;/b&gt;" path))

;; this one runs when the backend is equal to latex
(cl-defmethod bold-link-export ((path t) (desc t) (backend (eql latex)))
 (format "\\textit{%s}" path))

(org-link-set-parameters "bold" :export 'bold-link-export)
</pre>

<p>
:export
bold-link-export
</p>

<p>
Here it is in action:
</p>

<pre class="example">
(org-export-string-as "some bold:text" 'html t)
</pre>

<pre class="example">
&lt;p&gt;
some &lt;b&gt;text&lt;/b&gt;&lt;/p&gt;
</pre>

<pre class="example">
(org-export-string-as "some bold:text" 'latex t)
</pre>

<p>
This uses the generic function.
</p>

<pre class="example">
(require 'ox-md)
(org-export-string-as "some bold:text" 'md t)
</pre>

<pre class="example">

# Table of Contents



some text

</pre>

<p>
The syntax for defining the generic function is pretty similar to a regular function. The specific methods are a little different since they have to provide the specific "signature" that triggers each method. Here we only differentiate on the type of the backend. It is nice these are all separate functions though. It makes it trivial to add new ones, and less intrusive to replace in my opinion.
</p>

<p>
Generic functions have many other potential applications to replace functions that use lots of conditions to control flow, with a fall-through option at the end. You can learn more about them here: <a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/Generic-Functions.html">https://www.gnu.org/software/emacs/manual/html_node/elisp/Generic-Functions.html</a>. There is a lot more to them than I have illustrated here.
</p>

<p>
Copyright (C) 2018 by John Kitchin. See the <a href="file:///copying.html">License</a> for information about copying.
</p>

<p>
<a href="file:///org/2018/05/09/Making-it-easier-to-extend-the-export-of-org-mode-links-with-generic-functions.html">org-mode source</a>
</p>

<p>
Org-mode version = 9.1.13
</p>

</div>
</div>
<div>
        <div class="post-meta">
            <span title="post date" class="post-info">2018-06-11</span>
            <span title="last modification date" class="post-info">2018-06-11</span>
            <span title="tags" class="post-info">:<a href="https://lujun9972.github.io/emacs-document/tags/raw">raw</a>:</span>
            <span title="author" class="post-info"><a href="mailto:lujun9972 &lt;at&gt; T430S">lujun9972</a></span>
        </div>
    <script src="https://lujun9972.github.io/emacs-document/media/js/jquery-2.1.3.min.js"></script>
    <script src="https://lujun9972.github.io/emacs-document/media/js/md5.min.js"></script>
        <section>
            <div id="gitalk-container"></div>
            <script type="text/javascript">
             var gitalk = new Gitalk({
                 clientID: 'fdcb5d9da3f4acb4862c',
                 clientSecret: 'dd0a16312a206782cb7669dcec5e96874ab48170',
                 repo: 'lujun9972.github.com',
                 owner: 'lujun9972',
                 admin: ['lujun9972'],
                 id: md5(location.pathname),      // Ensure uniqueness and length less than 50
                 distractionFreeMode: false  // Facebook-like distraction free mode
             })
             gitalk.render('gitalk-container')
            </script>
        </section>
    <script src="https://lujun9972.github.io/emacs-document/media/js/main.js"></script>
    <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 26.x(<a href="http://orgmode.org">Org mode</a> 9.x)</p>
        <p>
            Copyright &copy; 2014 - <span id="footerYear"></span> <a href="mailto:lujun9972 &lt;at&gt; T430S">lujun9972</a>
            &nbsp;&nbsp;-&nbsp;&nbsp;
            Powered by <a href="https://github.com/emacs-china/ego" target="_blank">EGO</a><br/>
            <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license"><img src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png" style="border-width:0" alt="Creative Commons License" class="center"></a>
            <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
    </div>
            </div>
            <script type="text/javascript"
                    src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_SVG">
            </script>
            <script type="text/x-mathjax-config">
             MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "AMS"} } });
            </script>
</div>

  </div>
  <!-- https://instant.page/
       Make your site’s pages instant in 1 minute and improve your conversion rate by 1%  -->
  <script src="https://lujun9972.github.io/emacs-document//instant.page/1.1.0" type="module" integrity="sha384-EwBObn5QAxP8f09iemwAJljc+sU+eUXeL9vSBw1eNmVarwhKk2F9vBEpaN9rsrtp"></script>
  </body>
</html>
