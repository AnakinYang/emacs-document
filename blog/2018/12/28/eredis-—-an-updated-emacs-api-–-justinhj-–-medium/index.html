<!DOCTYPE html>
<html lang="en">
<head>
  <title>eredis — An updated Emacs API – justinhj – Medium - EMACS-DOCUMENT</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <meta name="author" content="lujun9972" />
  <meta name="keywords" content="raw" />
  <style>
   #ds-thread #ds-reset .ds-comment-body p {color: #ffffff;}
   #ds-thread #ds-reset .ds-comment-body p a {color: #ff0;}
   #ds-thread #ds-reset .ds-comment-body p a:hover {color: #0ff;}
   #disqus_thread a {color: #00ffff;}
  </style>
  <link rel="stylesheet" href="https://lujun9972.github.io/emacs-document/media/css/main.css" type="text/css"/>
  <link rel="stylesheet" href="https://lujun9972.github.io/emacs-document/media/css/comment.css" type="text/css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
</head>

  <body><div class="container">
<div>
  <header class="masthead">
    <h1 class="masthead-title"><a href="https://lujun9972.github.io/emacs-document/">EMACS-DOCUMENT</a></h1>
    <p>=============&gt;集思广益</p>
    <nav class="site-nav">
      <div class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z" fill="#ffff00"/>
          <path d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z" fill="#ffff00"/>
          <path d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z" fill="#ffff00"/>
        </svg>
      </div>
      <ul class="trigger">
        <li><a href="https://lujun9972.github.io/emacs-document/years/">Years</a></li>
        <li><a href="https://lujun9972.github.io/emacs-document/authors/">Authors</a></li>
        <li><a href="https://lujun9972.github.io/emacs-document/tags/">Tags</a></li>
        <li><a href="https://lujun9972.github.io/emacs-document/about/">About</a></li>
        <li><a href="https://github.com/lujun9972/emacs-document">Github</a></li>
        <li><a href="https://lujun9972.github.io/emacs-document/rss.xml">RSS</a></li>
      </ul>
    </nav>
    <form method="get" id="searchform" action="http://www.google.com/search">
      <input type="text" class="field" name="q" id="s" placeholder="Search">
      <input type="hidden" name="as_sitesearch" value="lujun9972.github.io/emacs-document">
    </form>
  </header>
</div>

<div>
<div class="post">
<h1 class="title">eredis — An updated Emacs API – justinhj – Medium</h1>
<div id="table-of-contents">
<h2>&#30446;&#24405;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#7a4e">eredis --- An updated Emacs API</a>
<ul>
<li><a href="#0f3c">Possible uses of eredis</a></li>
<li><a href="#2f92">Installation and preparation</a></li>
<li><a href="#0fc3">Connections and basic commands</a></li>
<li><a href="#398b">Lolwut</a></li>
<li><a href="#02fa">A note on multibyte string handling</a></li>
<li><a href="#da6f">org mode integration</a></li>
<li><a href="#18b9">Data processing</a></li>
<li><a href="#16e8">Future</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-orgea58a90" class="outline-2">
<h2 id="7a4e">eredis --- An updated Emacs API</h2>
<div class="outline-text-2" id="text-7a4e">
<p>
[[<a href="https://medium.com/@justinhj?source=post_header_lockup">https://medium.com/@justinhj?source=post_header_lockup</a>][<img src="https://cdn-images-1.medium.com/fit/c/100/100/1*k_QTqpFPm_lCg29o-IGi8w.png" alt="1*k_QTqpFPm_lCg29o-IGi8w.png" />]]<a href="https://medium.com/@justinhj?source=post_header_lockup">justinhj</a>
</p>

<p>
Nov 19
</p>

<p>
In July 2011 I released an emacs lisp client for the <a href="https://redis.io/">Redis</a> in-memory data structure store. You can install either from the <a href="https://melpa.org/#/eredis">Melpa</a> package or just clone from <a href="https://github.com/justinhj/eredis">Github</a>. The current version at time of writing is <code>0.9.6</code> and you will need that or later for some of the examples below to work.
</p>

<p>
In my spare time over the last few weeks I have been steadily improving eredis by fixing bugs, adding support for multiple connections, modernizing the use of emacs lisp and adding some features like iterating and mapping over all the keys in the Redis DB.
</p>

<p>
In this article I will re-introduce eredis and describe some of these changes, as well as going into some details about how it works under the hood.
</p>
</div>

<div id="outline-container-org33c8e60" class="outline-3">
<h3 id="0f3c">Possible uses of eredis</h3>
<div class="outline-text-3" id="text-0f3c">
<ul class="org-ul">
<li>Debugging your applications. A convenient way to view the data in Redis that uses the full power of Emacs buffers and emacs lisp</li>
<li>Monitoring. Using the hooks to org mode you can load a list of key/values into an org table. With <a href="https://www.emacswiki.org/emacs/lively.el">lively.el</a> you can update it periodically. Now emacs is a realtime monitoring tool!</li>
<li>Data processing. Using iteration and reduction functions in eredis you can scan over all the keys in Redis and perform calculations on your data.</li>
<li>Scripting and testing. Use the full power of emacs lisp to create test data or simulate users for test cases.</li>
</ul>
</div>
</div>

<div id="outline-container-orgbf65c5b" class="outline-3">
<h3 id="2f92">Installation and preparation</h3>
<div class="outline-text-3" id="text-2f92">
<p>
Installation instructions can be found in the <a href="https://github.com/justinhj/eredis">Github</a> README.md file.
</p>

<p>
Next you will need access to a Redis database. You can run a local test Redis instance using Docker. There are two scripts in the github repo to let you run two instances; one on port 6380 and the other on the default port 6379. This is because you can connect to multiple Redis servers using eredis. Also note we're using Redis 5.0 so we can try out the newer commands.
</p>

<pre class="example">
docker run -d -p 6379:6379 --name redis5_80 redis:5.0.0-alpine
docker run -d -p 6380:6379 --name redis5_81 redis:5.0.0-alpine
</pre>
</div>
</div>

<div id="outline-container-org009b236" class="outline-3">
<h3 id="0fc3">Connections and basic commands</h3>
<div class="outline-text-3" id="text-0fc3">
<p>
Each connection to Redis creates an emacs <a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/Processes.html">process</a>. To write a network client you use a network process. The following commands open network processes to your Redis instances.
</p>

<pre class="example">
(require 'eredis)
(setq rp (eredis-connect "localhost" 6379))
(setq rp2 (eredis-connect "localhost" 6380))
</pre>

<p>
Note that the return value is a process. We can then pass that in as the final parameter to most eredis calls, so it knows where to route the command. If you omit the process it will use the last opened process by default. This ensures backwards compatibility with older eredis versions.
</p>

<p>
Let's try a couple of basic commands. Imagine our application stores users and the time they logged in as string key that looks like=user:ID= and a value which is the timestamp. We'll set two users that have logged in at the same time, one in each instance:
</p>

<pre class="example">
(eredis-set "user:61" "1542084912" rp)
(eredis-set "user:62" "1542084912" rp2)
</pre>

<p>
Now you can check the data is stored correctly:
</p>

<pre class="example">
(eredis-get "user:61" rp)
(eredis-get "user:62" rp2)
</pre>

<p>
When we issue a Redis command it is sent to over the network using the function <code>process-send-string</code> and the response from Redis will be sent to an emacs buffer associated with the process. After the two commands above you'll see the buffers look like this:
</p>

<p>
<img src="https://cdn-images-1.medium.com/max/1600/1*sNLicU-rGYepRyp3X1RXNw.png" alt="1*sNLicU-rGYepRyp3X1RXNw.png" />Process buffers for each Redis connection
</p>

<p>
Notice that the buffers contain the pre-parsed RESP protocol. Using buffers in this way lets you see the history of output from Redis, which helps with debugging and also maybe useful depending on how you use eredis.
</p>

<p>
After the command is sent to Redis eredis will call <code>accept-process-output</code> which is a signal to Emacs to check for any data received over the network connection and put it in the buffer. This function can return immediately if there is no data, so you have to keep calling it until you've got a fully formed response.
</p>

<p>
If the buffers start to get big or you want to clear them, you can do so with <code>eredis-clear-buffer</code> passing the process as the parameter. You can also disconnect from the process once you are done either by using the command <code>eredis-disconnect</code> or by killing the process in the window you get if you run the=list-processes= command.
</p>
</div>
</div>

<div id="outline-container-orge230950" class="outline-3">
<h3 id="398b">Lolwut</h3>
<div class="outline-text-3" id="text-398b">
<p>
Salvatore Sanfilippo recently wrote in Redis news <a href="http://antirez.com/news/123">LOLWUT: a piece of art inside a DB command</a> about how from version 5 onwards LOLWUT will do something fun. Currently that draws a piece of randomly generated art using the braille unicode characters. eredis supports that command.
</p>

<p>
<code>eredis-lolwut</code> returns the lolwut art.
</p>

<p>
<img src="https://cdn-images-1.medium.com/max/1600/1*ZO8UJ3A268rUPAvh0BJKfQ.png" alt="1*ZO8UJ3A268rUPAvh0BJKfQ.png" />LOLWUT
</p>

<p>
Note that it won't look like this necessarily. In Emacs 26.1 running on macOS Mojave I had to download a few fonts before I found one that rendered correctly called <a href="https://www.ffonts.net/Swell-Braille.font.download">Swell Braille</a>.
</p>
</div>
</div>

<div id="outline-container-org2eec742" class="outline-3">
<h3 id="02fa">A note on multibyte string handling</h3>
<div class="outline-text-3" id="text-02fa">
<p>
In early versions of eredis there was a bug reading multibyte character data. Redis, as you may know, only deals with bytes. Whatever encoding you're using for strings on the client side, you send byte strings to Redis and it sends those same strings back. In eredis the buffer is set to multibyte mode, so if you receive multibyte characters they will display correctly there:
</p>

<pre class="example">
(eredis-set "hello-chinese" "你好吗") ;; "OK"
(eredis-get "hello-chinese") ;; "你好吗"
</pre>

<p>
So to the user of eredis everything works. But this is not automatic, take this example:
</p>

<pre class="example">
(length "你好吗") ;; 3
(length (string-as-unibyte "你好吗")) ;; 9
</pre>

<p>
Emacs returns the length of a multibyte string as the number of characters, not the number of bytes. But Redis returns this string as follows:
</p>

<pre class="example">
$9
你好吗
</pre>

<p>
In other words Redis sends a string of 9 bytes. You need to be careful when parsing RESP data to count actual bytes and not characters. In eredis I convert between multibyte and unibyte strings to make sure the parser works correctly, before passing the final multibyte string to the caller.
</p>
</div>
</div>

<div id="outline-container-orgf32520f" class="outline-3">
<h3 id="da6f">org mode integration</h3>
<div class="outline-text-3" id="text-da6f">
<p>
Note that you need version =0.9.6=or later for this section as I had to fix some bugs and make some improvements for this flow to work correctly. Please note that the org functions don't obey the process parameter, and they work on the last opened connection only. If you only have one connection open you should be fine. A fix for this will be in the next release.
</p>

<p>
Data from Redis and org-mode <a href="https://orgmode.org/manual/Tables.html">tables</a> are a natural match, so I have implemented integration between the two. As an example let's create a 1000 random user login times (within the last 15 minutes) stored in the format above:
</p>

<pre class="example">
(let ((time-now (round (float-time))))
 (dotimes (n 1000)
 (let ((login-time (- time-now (random (* 15 60)))))
 (eredis-set (format "user:%d" n) (number-to-string login-time) rp))))
</pre>

<p>
Now for debugging we want to see a table with login times of some users we're interested in. That can be done like this:
</p>

<pre class="example">
(eredis-org-table-from-keys '("user:11" "user:21" "user:31" "user:41"))
</pre>

<p>
Which creates a table and inserts it in the buffer:
</p>

<p>
<img src="https://cdn-images-1.medium.com/max/1600/1*aN1F8d72AgClJcWIdQPZ6g.png" alt="1*aN1F8d72AgClJcWIdQPZ6g.png" />Table from keys
</p>

<p>
Of course it wouldn't be any fun if the data flow was one way, so you can also edit the values (and keys) in the table and push them back up to Redis using the interactive command <code>eredis-org-table-mset</code>
</p>

<p>
If you create the table again in another part of the buffer you'll see the values from your edit session have been stored to Redis.
</p>


<div class="figure">
<p><img src="https://cdn-images-1.medium.com/max/1600/1*uxd4uE7a5yBS5q7uFNwJTQ.png" alt="1*uxd4uE7a5yBS5q7uFNwJTQ.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-org161c738" class="outline-3">
<h3 id="18b9">Data processing</h3>
<div class="outline-text-3" id="text-18b9">
<p>
Another capability I recently added and that will be expanded on in future is the ability to iterate over all the keys in Redis using <a href="https://redis.io/commands/scan">SCAN</a>. Redis initially only had the <code>KEYS *</code> command for getting all the keys at once. Doing operations like that is a big problem when your data sets are very large. If you're working with a real time data processing system you also don't want to choke DB's of any type by pulling huge amounts of data in single queries. For that reason Redis added the SCAN command so we can iterate through pages of keys and Redis can manage making sure that particular clients don't overwhelm the system.
</p>

<p>
To this end I've added (so far) two facilities for iterating and reducing the entire key set, that wrap the SCAN command and let you focus on your data processing task. In addition at each step eredis pulls the values for each key using the MGET command. Now we can safely do map and reduce type operations over the keys and values in Redis!
</p>

<p>
Since I'm a fan of the <a href="https://github.com/magnars/dash.el">dash.el</a> list library, I use Dash commands to implement these functions, and then compile each page together transparently for the caller.
</p>

<p>
Earlier we added 1000 users. Let's do a simple reduction to count them. There are two versions of this reduce function, one that also does a key name match <code>eredis-reduce-from-matching-key-value</code> and another that gets all of the keys <code>eredis-reduce-from-key-value</code> Note the function names map to the dash.el <code>reduce-from</code> function and conceptually does the same thing but with transparent paging across the key space.
</p>

<p>
In this example we will simply count all of the users using the reduce.
</p>

<pre class="example">
(eredis-reduce-from-matching-key-value (lambda (acc k v)
 (+ acc 1))
 0
 "user:*"
 rp) ;; 1000
</pre>

<p>
Here's a more useful example that actually uses the value (we stored a timestamp) in the reduction. We'll figure out how long each user has been logged in, total all the login times, and divide by 1000 to get the average time logged in:
</p>

<pre class="example">
(let ((time-now (round (float-time))))
 (/ 
 (eredis-reduce-from-matching-key-value (lambda (acc k v)
 (+ acc (- time-now (string-to-number v))))
 0
 "user:*"
 rp)
 1000)) ;; 2450
</pre>

<p>
So the average login time is 2450 seconds, or about 40 minutes, which is because I created the test users around 40 minutes ago.
</p>

<p>
As well as reductions you can iterate over the users using <code>each</code> Note that this is not mapping over the key space as that would be very unfriendly to your Emacs environment if you have a lot of data. Map creates a new list of keys and values and holds them all in memory at once. All we want to do is iterate over the pages of keys and values, execute some function for its side effect, and continue on. There's nothing stopping you materializing the entire key set in emacs should you need to, but it's not supported by the eredis default API.
</p>

<pre class="example">
(let ((most-recent-login 0))
 (eredis-each-matching-key-value (lambda (k v)
 (let ((login-time (string-to-number v)))
 (if (&gt; login-time most-recent-login)
 (setf most-recent-login login-time))))
 "user:*" rp)
 most-recent-login) ;; 1542566731
</pre>

<p>
Here we iterate all the keys and values and find the most recent login. Note that this could be done as a reduction too, there is some overlap between iterators and reductions.
</p>
</div>
</div>

<div id="outline-container-orgd7f5e13" class="outline-3">
<h3 id="16e8">Future</h3>
<div class="outline-text-3" id="text-16e8">
<p>
Once eredis has stabilized and supports all Redis commands without bugs it will go to version <code>1.0.0</code>
</p>

<p>
Before that however, the more immediate work is going into support for <a href="https://github.com/NicolasPetton/stream/blob/master/stream.el">stream.el</a> which allows us to construct lazy sequences. By implementing the SCAN functionality as a lazy stream we then can better compose operations on large data sets without blowing our memory. For example you can chain a couple of maps and filters together to transform your data before a final reduce to make it a single value.
</p>

<p>
In addition the org table support will be bolstered with bug fixes and new features.
</p>

<p>
I hope you enjoyed this quick tour of eredis and find a use for it, or at the very least see that emacs lisp programming can be fun, useful and quite simple.
</p>

<p>
If you want to read more blog posts like this one, I also write <a href="http://justinhj.github.io/">Functional Justin</a> over on github pages.
</p>
</div>
</div>
</div>

</div>
</div>
<div>
        <div class="post-meta">
            <span title="post date" class="post-info">2018-12-28</span>
            <span title="last modification date" class="post-info">2018-12-28</span>
            <span title="tags" class="post-info">:<a href="https://lujun9972.github.io/emacs-document/tags/raw">raw</a>:</span>
            <span title="author" class="post-info"><a href="mailto:lujun9972 &lt;at&gt; T430S">lujun9972</a></span>
        </div>
    <script src="https://lujun9972.github.io/emacs-document/media/js/jquery-2.1.3.min.js"></script>
        <section>
            <h1>Comments</h1>
            <div id="comment-wrap">
                    <a class="disqus_label">使用 Disqus 评论</a>
    </ul>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
         //var disqus_developer = 1;
         var preempt_signal=false;
         var disqus_identifier = "/blog/2018/12/28/eredis-—-an-updated-emacs-api-–-justinhj-–-medium/";
         var disqus_url = "https://lujun9972.github.io/emacs-document/blog/2018/12/28/eredis-—-an-updated-emacs-api-–-justinhj-–-medium/";
         var disqus_shortname = 'emacs-document';
         /* * * DON'T EDIT BELOW THIS LINE * * */
         (function() {
             var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
             dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
             (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
             $('#disqus_thread').css('display','none');
         })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    <script>
     /* comments */
     var ego_disqus_thread=$('#disqus_thread');
     var ego_ds_label=$('.ds-thread');
     $('.disqus_label').click(function(){
         ego_disqus_thread.show();
         ego_ds_label.hide();
     });
     $('.ds-label').click(function(){
         ego_disqus_thread.hide();
         ego_ds_label.show();
     });
    </script>
        </section>
    <script src="https://lujun9972.github.io/emacs-document/media/js/main.js"></script>
    <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 26.x(<a href="http://orgmode.org">Org mode</a> 9.x)</p>
        <p>
            Copyright &copy; 2014 - <span id="footerYear"></span> <a href="mailto:lujun9972 &lt;at&gt; T430S">lujun9972</a>
            &nbsp;&nbsp;-&nbsp;&nbsp;
            Powered by <a href="https://github.com/emacs-china/ego" target="_blank">EGO</a><br/>
            <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license"><img src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png" style="border-width:0" alt="Creative Commons License" class="center"></a>
            <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
    </div>
            </div>
            <script type="text/javascript"
                    src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_SVG">
            </script>
            <script type="text/x-mathjax-config">
             MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "AMS"} } });
            </script>
</div>

  </div>
  <!-- https://instant.page/
       Make your site’s pages instant in 1 minute and improve your conversion rate by 1%  -->
  <script src="https://lujun9972.github.io/emacs-document//instant.page/1.1.0" type="module" integrity="sha384-EwBObn5QAxP8f09iemwAJljc+sU+eUXeL9vSBw1eNmVarwhKk2F9vBEpaN9rsrtp"></script>
  </body>
</html>
