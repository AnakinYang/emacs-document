<!DOCTYPE html>
<html lang="en">
<head>
  <title>ZSH, tmux, Emacs and SSH: A copy-paste story - EMACS-DOCUMENT</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <meta name="author" content="lujun9972" />
  <meta name="keywords" content="raw" />
  <!-- <link rel="stylesheet" href="../../../../../media/css/main.css" type="text/css"/>
       <link rel="stylesheet" href="../../../../../media/css/comment.css" type="text/css"/> -->
  <link rel='stylesheet' href='https://cdn.jsdelivr.net/gh/kognise/water.css@latest/dist/dark.css'>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
</head>

  <body><div class="container">
<div>
  <header class="masthead">
    <h1 class="masthead-title"><a href="../../../../../">EMACS-DOCUMENT</a></h1>
    <p>=============&gt;随便,谢谢</p>
    <nav class="site-nav">
      <ul class="trigger">
        <li><a href="../../../../../years/">Years</a></li>
        <li><a href="../../../../../authors/">Authors</a></li>
        <li><a href="../../../../../tags/">Tags</a></li>
        <li><a href="../../../../../about/">About</a></li>
        <li><a href="https://github.com/lujun9972/emacs-document.git">Github</a></li>
        <li><a href="../../../../../rss.xml">RSS</a></li>
      </ul>
    </nav>
    <form method="get" id="searchform" action="https://www.bing.com/search">
      <input type="text" class="field" name="q" id="s" placeholder="Search">
      <input type="hidden" name="as_sitesearch" value="lujun9972.github.io/emacs-document">
    </form>
  </header>
</div>

<div>
<div class="post">
<h1 class="title">ZSH, tmux, Emacs and SSH: A copy-paste story</h1>
<div id="table-of-contents">
<h2>&#30446;&#24405;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org7acbd90">Shared functions</a></li>
<li><a href="#org41175b2">Problem: Pasting text is interpreted literally in a terminal</a></li>
<li><a href="#org74b37b7">Problem: Terminal Emacs lacks clipboard access</a></li>
<li><a href="#org22a8106">Problem: tmux uses paste buffers instead of clipboard</a></li>
<li><a href="#org4700e37">Problem: tmux under macOS lacks clipboard access</a></li>
<li><a href="#orga3ac8e2">Problem: Remote SSH sesssions lack clipboard access to local session</a></li>
<li><a href="#org6e0f726">Most up-to-date code in my dotfiles</a></li>
<li><a href="#orgedd7683">Bibliography</a></li>
</ul>
</div>
</div>
<p>
Explanations and code for how to enable copy-paste support working in as many terminal applications as possible. Works on a full GUI <code>$DISPLAY</code>, over SSH, on both macOS and Linux, and between ZSH, tmux and Emacs.
</p>

<p>
tl;dr: See the code from my <a href="https://github.com/jschaf/dotfiles/blob/master/bin/clipboard-copy">dotfiles</a> for <a href="https://github.com/jschaf/dotfiles/blob/master/bin/clipboard-copy">clipboard-copy</a>, <a href="https://github.com/jschaf/dotfiles/blob/master/bin/clipboard-paste">clipboard-paste</a>, <a href="https://github.com/jschaf/dotfiles/blob/d5b0b75423a681bb39d42a88336fd9ab44744849/layers/joe/config.el#L828">Emacs integration</a> and <a href="https://github.com/jschaf/dotfiles/blob/d5b0b75423a681bb39d42a88336fd9ab44744849/tmux.conf#L66">tmux integration</a>.
</p>

<p>
Implementing working copy-paste in multiple environments is <i>absurdly</i> difficult. Any of the following reasons complicate matters, but taken together the difficulty rises to a level of complexity not seen since macOS stopped shipping reasonably updated versions of bash.
</p>

<ul class="org-ul">
<li>Pasting into a terminal is interpreted literally, meaning an attacker can hide</li>
</ul>
<p>
<code>;sudo do $really_evil_thing;</code> in innocent looking, pasteable HTML with CSS trickery. Therefore, we can't blindly paste text into a terminal.
</p>
<ul class="org-ul">
<li>In a terminal, Emacs doesn't have access to the clipboard.</li>
<li>Emacs has its own independent idea of a clipboard, called a <a href="https://www.gnu.org/software/emacs/manual/html_node/emacs/Kill-Ring.html">kill ring</a>.</li>
<li>tmux has its own independent idea of a clipboard, called <code>paste buffers</code>.</li>
<li>zsh has it's own independent idea of a clipboard, also called a <a href="http://zsh.sourceforge.net/Doc/Release/Zsh-Line-Editor.html">kill ring</a>.</li>
<li>There is no clipboard in a remote SSH session because a clipboard is a windowing system concept.</li>
<li>There are 3 separate “clipboards” in X11, the primary selection, the clipboard selection, and the obsolete cut buffers.</li>
<li>tmux in macOS doesn't have access to the clipboard by default.</li>
</ul>

<p>
We will address each issue separately to develop a unified solution.
</p>

<div id="outline-container-orgec93c2f" class="outline-2">
<h2 id="org7acbd90"><a id="orgec93c2f"></a>Shared functions</h2>
<div class="outline-text-2" id="text-org7acbd90">
<p>
We need several functions to unify copy-paste handling across macOS and Linux. I've only included the most relevant functions. The rest of the helper functions can be found in my <a href="https://github.com/jschaf/dotfiles/blob/master/bin/clipboard-copy">dotfiles</a>, under <a href="https://github.com/jschaf/dotfiles/tree/master/zsh/functions">zsh/functions</a>.
</p>

<pre class="example">
zsh


function clipboard-copy() {
emulate -L zsh

local clipper_port=8377
local fake_clipboard=/tmp/clipboard-data.txt
if is-ssh &amp;&amp; is-port-in-use $clipper_port; then

tee &gt;(nc localhost $clipper_port) "$fake_clipboard"
return
fi

if ! has-display; then

&gt; fake_clipboard
return
fi

if is-darwin; then
pbcopy
elif is-cygwin; then
cat &gt; /dev/clipboard
else
if command-exists xclip; then
xclip -in -selection clipboard
elif command-exists xsel; then
xsel --clipboard --input
else
local message="clipboard-copy: Platform $(uname -s) not supported or "
message+="xclip/xsel not installed"
print message &gt;&amp;2
return 1
fi
fi
}

clipboard-copy $@
</pre>

<pre class="example">
zsh


function clipboard-paste() {
emulate -L zsh


if ! has-display; then
local fake_clipboard=/tmp/clipboard-data.txt
[[ -e $fake_clipboard ]] &amp;&amp; cat $fake_clipboard
return
fi

if is-darwin; then
pbpaste
elif is-cygwin; then
cat /dev/clipboard
else
if command-exists xclip; then
xclip -out -selection clipboard
elif command-exists xsel; then
xsel --clipboard --output
else
message="clipboard-paste: Platform $GRML_OSTYPE not supported "
message+="or xclip/xsel not installed"
print $message &gt;&amp;2
return 1
fi
fi
}

clipboard-paste $@
</pre>
</div>
</div>

<div id="outline-container-orga5ecc07" class="outline-2">
<h2 id="org41175b2"><a id="orga5ecc07"></a>Problem: Pasting text is interpreted literally in a terminal</h2>
<div class="outline-text-2" id="text-org41175b2">
<p>
When you paste something in a terminal, a terminal will default to interpreting what you pasted the same as entering a sequence of commands. See <a href="https://thejh.net/misc/website-terminal-copy-paste">this site</a> for an example of a posioned clipboard attack. The resulting <a href="https://news.ycombinator.com/item?id=5508225">Hacker News</a> and <a href="https://www.reddit.com/r/netsec/comments/1bv359/dont_copypaste_from_website_to_terminal_demo/">Reddit</a> discussion are also worth a look.
</p>

<p>
We want to be able to seww what we pasted without it executing. ZSH has the capability to edit multi-line text entries with the <a href="http://zsh.sourceforge.net/Doc/Release/Zsh-Line-Editor.html">ZSH line editor</a> (ZLE) and <a href="http://zsh.sourceforge.net/Doc/Release/Zsh-Line-Editor.html#Zle-Widgets">widgets</a>. Therefore, we can dump the pasted text into the edit buffer knowing that it won't be executed.
</p>

<p>
NOTE: Bracketed paste mode doesn't seem necessary with this approach but I'm not 100% certain this prevents all clipboard attacks.
</p>

<pre class="example">
zsh


function widget-paste-from-clipboard() {
local paste_data=$(clipboard-paste      | remove-trailing-empty-lines      | remove-leading-empty-lines)
zle copy-region-as-kill "$paste_data"
LBUFFER=${LBUFFER}${paste_data}
}
</pre>

<p>
Now, we need to bind this function in ZSH.
</p>

<pre class="example">

bindkey -M emacs 'C-y' widget-paste-from-clipboard
bindkey -M viins 'C-y' widget-paste-from-clipboard
bindkey -M vicmd 'C-y' widget-paste-from-clipboard
</pre>
</div>
</div>

<div id="outline-container-org8c1cfac" class="outline-2">
<h2 id="org74b37b7"><a id="org8c1cfac"></a>Problem: Terminal Emacs lacks clipboard access</h2>
<div class="outline-text-2" id="text-org74b37b7">
<p>
In a GUI Emacs, everything is nicely integrated for us. In terminal mode, i.e. <code>emacs -nw</code>, <a href="http://stackoverflow.com/questions/4580835">Emacs isn't linked</a> to any of the X11 libraries. So, in terminal mode, Emacs has no idea how to read or put data on the clipboard. We can enable clipboard access for a terminal Emacs in two steps.
</p>

<ol class="org-ol">
<li>From tmux, identify when we're pasting into Emacs.</li>
<li>Use emacsclient to call a function with the paste data.</li>
</ol>

<p>
NOTE: This relies on the assumption that Emacs will always run in a tmux session.
</p>

<p>
For the first step, we need the following shell function on the <code>$PATH</code>.
</p>

<pre class="example">
zsh


function tmux-smart-paste() {

local current_program=$(tmux display-message -p '#{window_name}')
if [[ $current_program == 'zsh' ]]; then

tmux send-keys 'C-y'
elif [[ ${current_program:l} == 'emacs' ]]; then
emacsclient --no-wait --alternate-editor=false --quiet      --eval "(my:paste-from-emacs-client)"      2&gt;&amp;1 &gt; /dev/null
else
tmux set-buffer "$(clipboard-paste)"
tmux paste-buffer
fi
}
tmux-smart-paste
</pre>

<p>
Next, we bind <code>tmux-smart-paste</code> in tmux.conf to <code>C-y</code>.
接下来，我们在tmux.conf中绑定=tmux-smart-paste=到=C-y=。
</p>

<pre class="example">
bind-key -T root C-y run-shell "tmux-smart-paste"
</pre>

<p>
For step two, we need the following emacs-lisp function.
</p>

<pre class="example">
(defun my:paste-from-emacs-client ()
"Paste into a terminal Emacs."
(if window-system
(error "Trying to paste into GUI emacs.")
(let ((paste-data (s-trim (shell-command-to-string "clipboard-paste"))))


(with-current-buffer (window-buffer)
(insert paste-data))

(kill-new paste-data))))
</pre>

<p>
NOTE: The terminal Emacs must be running the <a href="https://www.gnu.org/software/emacs/manual/html_node/emacs/Emacs-Server.html">server</a> for this to work.
</p>
</div>
</div>

<div id="outline-container-orgb196383" class="outline-2">
<h2 id="org22a8106"><a id="orgb196383"></a>Problem: tmux uses paste buffers instead of clipboard</h2>
<div class="outline-text-2" id="text-org22a8106">
<p>
In newer tmux versions, the <code>copy-pipe-and-cancel</code> is just what we need. This only handles the case using a visual selection and using <code>y</code> to yank the selection.
</p>

<pre class="example">
bind-key -T copy-mode-vi 'y' send-keys -X copy-pipe-and-cancel "clipboard-copy"
</pre>
</div>
</div>

<div id="outline-container-org495f598" class="outline-2">
<h2 id="org4700e37"><a id="org495f598"></a>Problem: tmux under macOS lacks clipboard access</h2>
<div class="outline-text-2" id="text-org4700e37">
<p>
The canonical reference for tmux and macOS integreation is Chris Johnsen's <a href="https://github.com/ChrisJohnsen/tmux-MacOSX-pasteboard">tmux-MacOSX-pasteboard</a> repo. The problem is that <code>pbpaste</code> and <code>pbcopy</code> do not work under tmux. The problem is solvable with undocumented functions.
</p>

<ol class="org-ol">
<li>Install <code>reattach-to-user-namespace</code>.</li>
</ol>

<pre class="example">
brew install reattach-to-user-namespace
</pre>

<ol class="org-ol">
<li>Configure tmux to invoke the shell with <code>reattach-to-user-namespace</code>.</li>
</ol>

<p>
tmux.conf - load Darwin conf
</p>

<pre class="example">


if-shell '[ "$(uname -s)" = "Darwin" ]' 'source-file ~/.config/tmux/osx.conf'
</pre>

<p>
~/.config/tmux/osx.conf
</p>

<pre class="example">




set-option -g default-command 'reattach-to-user-namespace -l zsh'
</pre>
</div>
</div>

<div id="outline-container-org74d13cd" class="outline-2">
<h2 id="orga3ac8e2"><a id="org74d13cd"></a>Problem: Remote SSH sesssions lack clipboard access to local session</h2>
<div class="outline-text-2" id="text-orga3ac8e2">
<p>
When you're SSHed into a remote computer, it would be really nice to copy text from the terminal and make it available on your local computer. Usually, the way people do this is by selecting the text via mouse and invoking copy from the terminal emulator, e.g. <i>iterm2</i>.
</p>

<p>
We want to be able to copy text from a remote SSH session and have it be available on our local clipboard using normal tmux commands. <a href="https://github.com/wincent/clipper">Clipper</a> is tailor made for this use case because it provides “clipboard access for local and remote tmux sessions.” Once you have clipper running on the remote server and locally, we can send data to it by modifying the <code>clipboard-copy</code> function.
</p>

<pre class="example">
function clipboard-copy() {
local clipper_port=8377
if is-ssh &amp;&amp; is-port-in-use $clipper_port; then

nc localhost $clipper_port
return
fi

}
</pre>
</div>
</div>

<div id="outline-container-org0dc40a0" class="outline-2">
<h2 id="org6e0f726"><a id="org0dc40a0"></a>Most up-to-date code in my dotfiles</h2>
<div class="outline-text-2" id="text-org6e0f726">
<p>
The most up-to-date code is in my <a href="https://github.com/jschaf/dotfiles/blob/master/bin/clipboard-copy">dotfiles</a> repo. The interesting bits are <a href="https://github.com/jschaf/dotfiles/blob/master/bin/clipboard-copy">clipboard-copy</a>, <a href="https://github.com/jschaf/dotfiles/blob/master/bin/clipboard-paste">clipboard-paste</a>, <a href="https://github.com/jschaf/dotfiles/blob/master/layers/joe/config.el#L828">Emacs integration</a> and <a href="https://github.com/jschaf/dotfiles/blob/master/tmux.conf#L66">tmux integration</a>.
</p>
</div>
</div>

<div id="outline-container-org11d820f" class="outline-2">
<h2 id="orgedd7683"><a id="org11d820f"></a>Bibliography</h2>
<div class="outline-text-2" id="text-orgedd7683">
<p>
<a href="https://en.wikipedia.org/w/index.php?title=X_Window_selection&amp;oldid=744898565">X Window Selection</a>
</p>
</div>
</div>

</div>
</div>
<div>
        <div class="post-meta">
            <span title="post date" class="post-info">2018-05-31</span>
            <span title="last modification date" class="post-info">2020-02-01</span>
            <span title="tags" class="post-info">:<a href="../../../../../tags/raw">raw</a>:</span>
            <span title="author" class="post-info"><a href="mailto:travis &lt;at&gt; travis-job-292cf71b-17e9-49b5-8069-c86303c3f932">lujun9972</a></span>
        </div>
    <script src="../../../../../media/js/jquery-2.1.3.min.js"></script>
    <script src="../../../../../media/js/md5.min.js"></script>
        <section>
            <div id="gitalk-container"></div>
            <script type="text/javascript">
             var gitalk = new Gitalk({
                 clientID: 'fdcb5d9da3f4acb4862c',
                 clientSecret: 'dd0a16312a206782cb7669dcec5e96874ab48170',
                 repo: 'lujun9972.github.com',
                 owner: 'lujun9972',
                 admin: ['lujun9972'],
                 id: md5(location.pathname),      // Ensure uniqueness and length less than 50
                 distractionFreeMode: false  // Facebook-like distraction free mode
             })
             gitalk.render('gitalk-container')
            </script>
        </section>
    <script src="../../../../../media/js/main.js"></script>
        <script>
         var _hmt = _hmt || [];
         (function() {
             var hm = document.createElement("script");
             hm.src = "https://hm.baidu.com/hm.js?7bac4fd0247f69c27887e0d4e3aee41e";
             var s = document.getElementsByTagName("script")[0]; 
             s.parentNode.insertBefore(hm, s);
         })();
        </script>
    <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 27.x(<a href="http://orgmode.org">Org mode</a> 9.x)</p>
        <p>
            Copyright &copy; 2014 - <span id="footerYear"></span> <a href="mailto:travis &lt;at&gt; travis-job-292cf71b-17e9-49b5-8069-c86303c3f932">lujun9972</a>
            &nbsp;&nbsp;-&nbsp;&nbsp;
            Powered by <a href="https://github.com/emacs-china/ego" target="_blank">EGO</a><br/>
            <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license"><img src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png" style="border-width:0" alt="Creative Commons License" class="center"></a>
            <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
    </div>
            </div>
            <script type="text/javascript"
                    src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_SVG">
            </script>
            <script type="text/x-mathjax-config">
             MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "AMS"} } });
            </script>
</div>

  </div>
  <!-- https://instant.page/
       Make your site’s pages instant in 1 minute and improve your conversion rate by 1%  -->
  <script src="../../../../../instant.page/1.1.0" type="module" integrity="sha384-EwBObn5QAxP8f09iemwAJljc+sU+eUXeL9vSBw1eNmVarwhKk2F9vBEpaN9rsrtp"></script>
  </body>
</html>
